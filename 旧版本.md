# é¡¹ç›®ä»£ç æ±‡æ€»

ç”Ÿæˆæ—¶é—´: 2026-01-03 09:48:24
æ–‡ä»¶æ€»æ•°: 30

---

## æ–‡ä»¶: action_popup.py

```python
ï»¿# -*- coding: utf-8 -*-
# ui/action_popup.py

import os
from PyQt5.QtWidgets import (QWidget, QHBoxLayout, QPushButton, QLabel, 
                             QGraphicsDropShadowEffect, QVBoxLayout, QFrame, QApplication)
from PyQt5.QtCore import Qt, pyqtSignal, QTimer, QPoint, QSize
from PyQt5.QtGui import QCursor, QColor, QPixmap
from core.config import COLORS
from ui.common_tags import CommonTags

class ActionPopup(QWidget):
    """
    å¤åˆ¶æˆåŠŸååœ¨é¼ æ ‡é™„è¿‘å¼¹å‡ºçš„å¿«æ·æ“ä½œæ¡
    å¸ƒå±€é€»è¾‘ï¼š [å¤§ Logo] | [æ”¶è—] [å¸¸ç”¨æ ‡ç­¾...] [ç®¡ç†]
    """
    request_favorite = pyqtSignal(int)
    request_tag_toggle = pyqtSignal(int, str, bool) 
    request_manager = pyqtSignal()

    def __init__(self, parent=None):
        super().__init__(parent)
        self.current_idea_id = None
        self.is_favorited = False
        
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | Qt.Tool)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setAttribute(Qt.WA_ShowWithoutActivating)
        
        self._init_ui()
        
        self.hide_timer = QTimer(self)
        self.hide_timer.setSingleShot(True)
        self.hide_timer.timeout.connect(self._animate_hide)

    def _init_ui(self):
        # ä¸»å®¹å™¨
        self.container = QWidget(self)
        self.container.setStyleSheet(f"""
            QWidget {{
                background-color: #1E1E1E; 
                border: 1px solid {COLORS['primary']}; 
                border-radius: 30px;
            }}
        """)
        
        # ä¸»å¸ƒå±€
        layout = QHBoxLayout(self.container)
        layout.setContentsMargins(15, 8, 15, 8)
        layout.setSpacing(12)
        
        # --- 1. å·¦ä¾§ï¼šè¶…å¤§ Logo (å“ç‰ŒåŒº) ---
        self.lbl_logo = QLabel()
        self.lbl_logo.setFixedSize(42, 42)
        self.lbl_logo.setAlignment(Qt.AlignCenter)
        self.lbl_logo.setStyleSheet("border: none; background: transparent;")
        
        logo_path = os.path.join("assets", "logo.svg")
        if os.path.exists(logo_path):
            pixmap = QPixmap(logo_path)
            scaled_pixmap = pixmap.scaled(42, 42, Qt.KeepAspectRatio, Qt.SmoothTransformation)
            self.lbl_logo.setPixmap(scaled_pixmap)
        else:
            self.lbl_logo.setText("âš¡")
            self.lbl_logo.setStyleSheet("border:none; font-size: 28px; color: #00F3FF;")
            
        layout.addWidget(self.lbl_logo)
        
        # --- 2. åˆ†å‰²çº¿ ---
        line = QFrame()
        line.setFrameShape(QFrame.VLine)
        line.setFrameShadow(QFrame.Plain)
        line.setFixedWidth(1)
        line.setFixedHeight(30)
        line.setStyleSheet("background-color: #444; border: none;")
        layout.addWidget(line)

        # --- 3. å³ä¾§ï¼šæ“ä½œåŒº (æ”¶è— + æ ‡ç­¾) ---
        # æ”¶è—æŒ‰é’®
        self.btn_fav = QPushButton("â˜†")
        self.btn_fav.setFixedSize(32, 32)
        self.btn_fav.setToolTip("æ”¶è—")
        self.btn_fav.setCursor(Qt.PointingHandCursor)
        self.btn_fav.setStyleSheet(f"""
            QPushButton {{
                background: transparent; 
                color: #BBB; 
                border: 1px solid transparent; 
                border-radius: 16px;
                font-size: 20px; 
                padding-bottom: 2px;
            }}
            QPushButton:hover {{ 
                color: {COLORS['warning']}; 
                background-color: rgba(255, 255, 255, 0.05);
            }}
        """)
        self.btn_fav.clicked.connect(self._on_fav_clicked)
        layout.addWidget(self.btn_fav)

        # å¸¸ç”¨æ ‡ç­¾æ 
        self.common_tags_bar = CommonTags()
        self.common_tags_bar.tag_toggled.connect(self._on_tag_toggled)
        self.common_tags_bar.manager_requested.connect(self._on_manager_clicked)
        self.common_tags_bar.refresh_requested.connect(self._adjust_size_dynamically)
        
        layout.addWidget(self.common_tags_bar)
        
        # é˜´å½±
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(25)
        shadow.setXOffset(0)
        shadow.setYOffset(6)
        shadow.setColor(QColor(0, 0, 0, 160))
        self.container.setGraphicsEffect(shadow)

    def _adjust_size_dynamically(self):
        if self.isVisible():
            self.container.adjustSize()
            self.resize(self.container.size() + QSize(30, 30))

    def show_at_mouse(self, idea_id):
        self.current_idea_id = idea_id
        self.is_favorited = False
        
        self.common_tags_bar.reload_tags()
        self.common_tags_bar.reset_selection()
        
        # é‡ç½®æ”¶è—æŒ‰é’®
        self.btn_fav.setText("â˜†")
        self.btn_fav.setStyleSheet(f"""
            QPushButton {{
                background: transparent; color: #BBB; border: 1px solid transparent; border-radius: 16px; font-size: 20px;
            }}
            QPushButton:hover {{ color: {COLORS['warning']}; background-color: rgba(255, 255, 255, 0.05); }}
        """)
        
        # è°ƒæ•´å¤§å°
        self.container.adjustSize()
        self.resize(self.container.size() + QSize(30, 30))
        
        # --- æ™ºèƒ½å®šä½é€»è¾‘ (Smart Positioning) ---
        cursor_pos = QCursor.pos()
        
        # è·å–å½“å‰å±å¹•å‡ ä½•ä¿¡æ¯
        screen = QApplication.screenAt(cursor_pos)
        if not screen:
            screen = QApplication.primaryScreen()
        screen_geo = screen.availableGeometry()
        
        w = self.width()
        h = self.height()
        
        # é»˜è®¤ï¼šæ˜¾ç¤ºåœ¨é¼ æ ‡æ­£ä¸Šæ–¹ï¼Œæ°´å¹³å±…ä¸­
        # (æ°´å¹³å±…ä¸­ï¼šcursor.x - çª—å£ä¸€åŠå®½åº¦)
        x = cursor_pos.x() - (w // 2)
        # (å‚ç›´ä¸Šæ–¹ï¼šcursor.y - çª—å£é«˜åº¦ - é—´è·)
        y = cursor_pos.y() - h - 15  
        
        # 1. æ°´å¹³è¾¹ç¼˜æ£€æµ‹ä¸ä¿®æ­£
        # å¦‚æœå·¦è¾¹è¶…å‡ºäº†å±å¹• (x < left)
        if x < screen_geo.left() + 10:
            x = screen_geo.left() + 10
        # å¦‚æœå³è¾¹è¶…å‡ºäº†å±å¹• (x + w > right) -> è¿™æ˜¯æ‚¨æˆªå›¾çš„æƒ…å†µ
        elif x + w > screen_geo.right() - 10:
            x = screen_geo.right() - w - 10
            
        # 2. å‚ç›´è¾¹ç¼˜æ£€æµ‹ä¸ä¿®æ­£
        # å¦‚æœä¸Šé¢è¶…å‡ºäº†å±å¹• (é¼ æ ‡åœ¨é¡¶ç«¯)ï¼Œåˆ™æ”¹åˆ°é¼ æ ‡ä¸‹æ–¹æ˜¾ç¤º
        if y < screen_geo.top() + 10:
            y = cursor_pos.y() + 30 # æ˜¾ç¤ºåœ¨é¼ æ ‡ä¸‹æ–¹
        
        self.move(x, y)
        self.show()
        
        self.hide_timer.start(3500)

    def _on_fav_clicked(self):
        if self.current_idea_id:
            if not self.is_favorited:
                self.request_favorite.emit(self.current_idea_id)
                self.is_favorited = True
                self.btn_fav.setText("â˜…")
                self.btn_fav.setStyleSheet(f"""
                    QPushButton {{
                        background: transparent; color: {COLORS['warning']}; border: 1px solid transparent; border-radius: 16px; font-size: 20px;
                    }}
                """)
            
            if self.underMouse():
                self.hide_timer.stop()
            else:
                self.hide_timer.start(1500)

    def _on_tag_toggled(self, tag_name, checked):
        if self.current_idea_id:
            self.request_tag_toggle.emit(self.current_idea_id, tag_name, checked)
            
            if self.underMouse():
                self.hide_timer.stop()
            else:
                self.hide_timer.start(1500)

    def _on_manager_clicked(self):
        self.request_manager.emit()
        self.hide()

    def _animate_hide(self):
        self.hide()

    def enterEvent(self, event):
        self.hide_timer.stop()
        super().enterEvent(event)

    def leaveEvent(self, event):
        self.hide_timer.start(1000)
        super().leaveEvent(event)
```

## æ–‡ä»¶: advanced_tag_selector.py

```python
# -*- coding: utf-8 -*-
# ui/advanced_tag_selector.py

from PyQt5.QtWidgets import (QApplication, QWidget, QVBoxLayout, QHBoxLayout, QPushButton, 
                             QLineEdit, QScrollArea, QLabel, QLayout, QSizePolicy)
from PyQt5.QtCore import Qt, pyqtSignal, QPoint, QRect, QSize
from PyQt5.QtGui import QCursor, QColor
from core.config import COLORS

class FlowLayout(QLayout):
    def __init__(self, parent=None, margin=0, spacing=-1):
        super(FlowLayout, self).__init__(parent)
        if parent is not None:
            self.setContentsMargins(margin, margin, margin, margin)
        self.setSpacing(spacing)
        self.itemList = []

    def __del__(self):
        item = self.takeAt(0)
        while item:
            item = self.takeAt(0)

    def addItem(self, item):
        self.itemList.append(item)

    def count(self):
        return len(self.itemList)

    def itemAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList[index]
        return None

    def takeAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList.pop(index)
        return None

    def expandingDirections(self):
        return Qt.Orientations(Qt.Orientation(0))

    def hasHeightForWidth(self):
        return True

    def heightForWidth(self, width):
        height = self.doLayout(QRect(0, 0, width, 0), True)
        return height

    def setGeometry(self, rect):
        super(FlowLayout, self).setGeometry(rect)
        self.doLayout(rect, False)

    def sizeHint(self):
        return self.minimumSize()

    def minimumSize(self):
        size = QSize()
        for item in self.itemList:
            size = size.expandedTo(item.minimumSize())
        margin = self.contentsMargins()
        size += QSize(margin.left() + margin.right(), margin.top() + margin.bottom())
        return size

    def doLayout(self, rect, testOnly):
        x = rect.x()
        y = rect.y()
        lineHeight = 0
        spacing = self.spacing()

        for item in self.itemList:
            wid = item.widget()
            spaceX = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Horizontal)
            spaceY = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Vertical)
            
            nextX = x + item.sizeHint().width() + spaceX
            if nextX - spaceX > rect.right() and lineHeight > 0:
                x = rect.x()
                y = y + lineHeight + spaceY
                nextX = x + item.sizeHint().width() + spaceX
                lineHeight = 0

            if not testOnly:
                item.setGeometry(QRect(QPoint(x, y), item.sizeHint()))

            x = nextX
            lineHeight = max(lineHeight, item.sizeHint().height())

        return y + lineHeight - rect.y()

class AdvancedTagSelector(QWidget):
    """
    åŠŸèƒ½å¼ºå¤§çš„æ‚¬æµ®æ ‡ç­¾é€‰æ‹©é¢æ¿
    æ”¯æŒä¸¤ç§æ¨¡å¼ï¼š
    1. ç»‘å®šæ¨¡å¼ (ä¼ å…¥ idea_id): ç›´æ¥ä¿®æ”¹æ•°æ®åº“ï¼Œå³æ—¶ä¿å­˜
    2. é€‰æ‹©æ¨¡å¼ (ä¼ å…¥ initial_tags): ä»…ä½œä¸ºé€‰æ‹©å™¨ï¼Œè¿”å›ç»“æœï¼Œä¸ç›´æ¥ä¿®æ”¹æ•°æ®åº“
    """
    tags_confirmed = pyqtSignal(list)

    # ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ  initial_tags å‚æ•°ï¼Œå…è®¸ä¼ å…¥åˆå§‹æ ‡ç­¾åˆ—è¡¨
    def __init__(self, db, idea_id=None, initial_tags=None, parent=None):
        super().__init__(parent)
        self.db = db
        self.idea_id = idea_id
        
        # åˆå§‹åŒ–é€‰ä¸­çŠ¶æ€
        self.selected_tags = set()
        if initial_tags:
            self.selected_tags = set(initial_tags)
            
        self.tag_buttons = {} 
        self._is_closing = False 

        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | Qt.Tool)
        self.setAttribute(Qt.WA_TranslucentBackground)
        
        self._init_ui()
        self._load_tags()
        
        QApplication.instance().focusChanged.connect(self._on_focus_changed)

    def _init_ui(self):
        container = QWidget()
        container.setObjectName("mainContainer")
        container.setStyleSheet(f"""
            #mainContainer {{
                background-color: #1E1E1E; 
                border: 1px solid #333;
                border-radius: 8px;
                color: #EEE;
            }}
        """)

        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.addWidget(container)

        layout = QVBoxLayout(container)
        layout.setContentsMargins(12, 12, 12, 12)
        layout.setSpacing(10)

        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("ğŸ” æœç´¢æˆ–æ–°å»º...")
        self.search_input.setStyleSheet(f"""
            QLineEdit {{
                background-color: #2D2D2D; 
                border: none;
                border-bottom: 1px solid #444;
                border-radius: 4px; 
                padding: 8px; 
                font-size: 13px; 
                color: #DDD;
            }}
            QLineEdit:focus {{ border-bottom: 1px solid {COLORS['primary']}; }}
        """)
        self.search_input.textChanged.connect(self._filter_tags)
        self.search_input.returnPressed.connect(self._on_search_return)
        layout.addWidget(self.search_input)

        self.recent_label = QLabel("æœ€è¿‘ä½¿ç”¨")
        self.recent_label.setStyleSheet("color: #888; font-size: 12px; font-weight: bold; margin-top: 5px;")
        layout.addWidget(self.recent_label)

        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setStyleSheet("""
            QScrollArea { border: none; background: transparent; }
            QWidget { background: transparent; }
            QScrollBar:vertical {
                border: none; background: #2D2D2D; width: 6px; margin: 0;
            }
            QScrollBar::handle:vertical { background: #555; border-radius: 3px; }
        """)
        
        self.scroll_content = QWidget()
        self.flow_layout = FlowLayout(self.scroll_content, margin=0, spacing=8)
        
        scroll.setWidget(self.scroll_content)
        layout.addWidget(scroll)
        
        self.setFixedSize(360, 450)

    def _load_tags(self):
        # å¦‚æœæœ‰ idea_idï¼Œä»æ•°æ®åº“åŠ è½½è¯¥ idea çš„æ ‡ç­¾å¹¶åˆå¹¶åˆ°å½“å‰é€‰ä¸­
        if self.idea_id:
            self.selected_tags = set(self.db.get_tags(self.idea_id))
        
        c = self.db.conn.cursor()
        c.execute('''
            SELECT t.name, COUNT(it.idea_id) as cnt, MAX(i.updated_at) as last_used
            FROM tags t
            LEFT JOIN idea_tags it ON t.id = it.tag_id
            LEFT JOIN ideas i ON it.idea_id = i.id AND i.is_deleted = 0
            GROUP BY t.id 
            ORDER BY last_used DESC, cnt DESC, t.name ASC
        ''')
        all_tags = c.fetchall()
        
        self.recent_label.setText(f"æœ€è¿‘ä½¿ç”¨ ({len(all_tags)})")

        while self.flow_layout.count():
            item = self.flow_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
        self.tag_buttons.clear()

        for row in all_tags:
            name = row[0]
            count = row[1]
            self._create_tag_chip(name, count)

    def _create_tag_chip(self, name, count=0):
        btn = QPushButton()
        btn.setCheckable(True)
        btn.setChecked(name in self.selected_tags)
        btn.setCursor(Qt.PointingHandCursor)
        
        btn.setProperty("tag_name", name)
        btn.setProperty("tag_count", count)
        
        self._update_chip_state(btn)
        
        btn.toggled.connect(lambda checked, b=btn, n=name: self._on_tag_toggled(b, n, checked))
        
        self.flow_layout.addWidget(btn)
        self.tag_buttons[name] = btn

    def _update_chip_state(self, btn):
        name = btn.property("tag_name")
        count = btn.property("tag_count")
        checked = btn.isChecked()
        
        icon = "âœ“" if checked else "ğŸ•’"
        text = f"{icon} {name}"
        if count > 0:
            text += f" ({count})"
        
        btn.setText(text)
        
        if checked:
            btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {COLORS['primary']};
                    color: white;
                    border: 1px solid {COLORS['primary']};
                    border-radius: 14px;
                    padding: 6px 12px;
                    font-size: 12px;
                    font-family: "Segoe UI", "Microsoft YaHei";
                }}
            """)
        else:
            btn.setStyleSheet("""
                QPushButton {
                    background-color: #2D2D2D;
                    color: #BBB;
                    border: 1px solid #444;
                    border-radius: 14px;
                    padding: 6px 12px;
                    font-size: 12px;
                    font-family: "Segoe UI", "Microsoft YaHei";
                }
                QPushButton:hover {
                    background-color: #383838;
                    border-color: #666;
                    color: white;
                }
            """)

    def _on_tag_toggled(self, button, name, checked):
        if checked:
            self.selected_tags.add(name)
        else:
            self.selected_tags.discard(name)
        self._update_chip_state(button)

    def _filter_tags(self):
        term = self.search_input.text().lower().strip()
        for name, btn in self.tag_buttons.items():
            if term in name.lower():
                btn.show()
            else:
                btn.hide()

    def _on_search_return(self):
        text = self.search_input.text().strip()
        if not text:
            self._handle_close()
            return

        found_existing = False
        for name, btn in self.tag_buttons.items():
            if name.lower() == text.lower():
                if not btn.isChecked():
                    btn.setChecked(True)
                found_existing = True
                break
        
        if not found_existing:
            self.selected_tags.add(text)
            self._create_tag_chip(text, 0)
            new_btn = self.tag_buttons.get(text)
            if new_btn: 
                new_btn.setChecked(True)
        
        self.search_input.clear()
        self._filter_tags()

    def _save_tags(self):
        """ä»…åœ¨ç»‘å®šæ¨¡å¼ä¸‹ä¿å­˜åˆ°æ•°æ®åº“"""
        # ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¦‚æœ self.idea_id ä¸ºç©ºï¼Œè¯´æ˜æ˜¯çº¯é€‰æ‹©æ¨¡å¼ï¼Œä¸è¿›è¡Œæ•°æ®åº“ç»‘å®šæ“ä½œ
        if not self.idea_id:
            return

        c = self.db.conn.cursor()
        c.execute('DELETE FROM idea_tags WHERE idea_id = ?', (self.idea_id,))
        for tag_name in self.selected_tags:
            c.execute('INSERT OR IGNORE INTO tags (name) VALUES (?)', (tag_name,))
            c.execute('SELECT id FROM tags WHERE name = ?', (tag_name,))
            result = c.fetchone()
            if result:
                tag_id = result[0]
                c.execute('INSERT INTO idea_tags (idea_id, tag_id) VALUES (?, ?)', (self.idea_id, tag_id))
        self.db.conn.commit()

    def _is_child_widget(self, widget):
        if widget is None: return False
        current = widget
        while current:
            if current is self: return True
            current = current.parent()
        return False

    def _on_focus_changed(self, old_widget, new_widget):
        if self._is_closing or not self.isVisible(): return
        if not self._is_child_widget(new_widget):
            self._handle_close()

    def _handle_close(self):
        if self._is_closing: return
        self._is_closing = True
        try:
            QApplication.instance().focusChanged.disconnect(self._on_focus_changed)
        except: pass
        
        self._save_tags()
        self.tags_confirmed.emit(list(self.selected_tags))
        self.close()

    def show_at_cursor(self):
        cursor_pos = QCursor.pos()
        screen_geo = QApplication.desktop().screenGeometry()
        x, y = cursor_pos.x() + 15, cursor_pos.y() + 15
        if x + self.width() > screen_geo.right(): x = cursor_pos.x() - self.width() - 15
        if y + self.height() > screen_geo.bottom(): y = screen_geo.bottom() - self.height() - 15
        self.move(x, y)
        self.show()
        self.activateWindow()
        self.search_input.setFocus()
```

## æ–‡ä»¶: backup_service.py

```python
ï»¿# -*- coding: utf-8 -*-

# services/backup_service.py
import os
import shutil
from datetime import datetime
from core.config import DB_NAME, BACKUP_DIR

class BackupService:
    @staticmethod
    def run_backup():
        """æ‰§è¡Œæ•°æ®åº“å¤‡ä»½å¹¶æ¸…ç†æ—§æ–‡ä»¶"""
        if not os.path.exists(BACKUP_DIR):
            os.makedirs(BACKUP_DIR)
        
        if os.path.exists(DB_NAME):
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            target = os.path.join(BACKUP_DIR, f'ideas_{timestamp}.db')
            try:
                shutil.copy2(DB_NAME, target)
                BackupService._clean_old_backups()
                print(f"[System] Backup created: {target}")
            except Exception as e:
                print(f"[System] Backup failed: {e}")

    @staticmethod
    def _clean_old_backups(keep=20):
        try:
            files = sorted(
                [os.path.join(BACKUP_DIR, f) for f in os.listdir(BACKUP_DIR)],
                key=os.path.getmtime
            )
            while len(files) > keep:
                os.remove(files.pop(0))
        except Exception:
            pass
```

## æ–‡ä»¶: ball.py

```python
# -*- coding: utf-8 -*-
# ui/ball.py
import math
import random
from PyQt5.QtWidgets import QWidget, QMenu
from PyQt5.QtCore import Qt, pyqtSignal, QPoint, QTimer, QRectF
from PyQt5.QtGui import QPainter, QColor, QFont, QPen, QBrush
from core.settings import save_setting

class FloatingBall(QWidget):
    request_show_quick_window = pyqtSignal()
    request_show_main_window = pyqtSignal()
    request_quit_app = pyqtSignal()
    double_clicked = pyqtSignal()

    def __init__(self, main_window):
        super().__init__()
        self.mw = main_window 
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.WindowStaysOnTopHint | Qt.Tool)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setFixedSize(64, 64) 
        self.setAcceptDrops(True)

        self.dragging = False
        self.is_hovering = False 
        
        # --- å‰ªè´´æ¿åé¦ˆçŠ¶æ€ ---
        self.is_clipboard_active = False  
        self.clipboard_timer_count = 0     
        
        self.offset = QPoint()
        self.hue = 0  # è‰²ç›¸ (0-359)

        # --- åŠ¨èƒ½å‚æ•° ---
        self.angle_outer = 0  # å¤–ç¯è§’åº¦
        self.angle_inner = 0  # å†…ç¯è§’åº¦
        self.rotation_speed_base = 2.0 # åŸºç¡€è½¬é€Ÿ
        self.current_speed = self.rotation_speed_base
        
        # ç²’å­ç³»ç»Ÿ
        self.particles = [] 

        self.timer = QTimer(self)
        self.timer.timeout.connect(self._update_physics)
        self.timer.start(16) # ~60FPS

    def trigger_clipboard_feedback(self):
        """å…¬å…±æ–¹æ³•ï¼šè§¦å‘å‰ªè´´æ¿æˆåŠŸåé¦ˆç‰¹æ•ˆ"""
        self.is_clipboard_active = True
        self.clipboard_timer_count = 0  # é‡ç½®è®¡æ•°å™¨ï¼Œç‰¹æ•ˆæŒç»­çº¦2ç§’ (120å¸§)

    def _update_physics(self):
        """ç‰©ç†å¸§æ›´æ–°"""
        # 1. è‰²ç›¸æ›´æ–° (å½©è™¹å‘¼å¸æ•ˆæœ)
        self.hue = (self.hue + 0.5) % 360

        # 2. å‰ªè´´æ¿ç‰¹æ•ˆè®¡æ—¶
        if self.is_clipboard_active:
            self.clipboard_timer_count += 1
            if self.clipboard_timer_count > 120:  # çº¦2ç§’åè‡ªåŠ¨å…³é—­ç‰¹æ•ˆ
                self.is_clipboard_active = False
                self.clipboard_timer_count = 0

        # 3. ç›®æ ‡é€Ÿåº¦æ§åˆ¶ (æƒ¯æ€§å¹³æ»‘å¤„ç†)
        # ä¼˜å…ˆçº§ï¼šæ‹–æ‹½æ‚¬åœ > å‰ªè´´æ¿åé¦ˆ > æ­£å¸¸çŠ¶æ€
        if self.is_hovering:
            target_speed = 15.0
        elif self.is_clipboard_active:
            target_speed = 15.0
        else:
            target_speed = 2.0
            
        self.current_speed += (target_speed - self.current_speed) * 0.1
        
        # 4. æ›´æ–°è§’åº¦
        self.angle_outer += self.current_speed
        self.angle_inner -= self.current_speed * 1.5 # å†…ç¯åå‘æ—‹è½¬
        
        # å½’ä¸€åŒ–
        self.angle_outer %= 360
        self.angle_inner %= 360

        # 5. ç²’å­æ›´æ–°
        if self.is_hovering or self.is_clipboard_active:
            self._update_particles()
        else:
            self.particles = []  # æ¸…ç©ºç²’å­
            
        self.update()

    def _update_particles(self):
        # éšæœºç”ŸæˆæŒ‡å‘åœ†å¿ƒçš„ç²’å­
        if len(self.particles) < 10:
            angle = random.uniform(0, 6.28)
            dist = 30
            self.particles.append({'a': angle, 'd': dist, 's': random.uniform(2, 4)})
        
        # æ›´æ–°ç²’å­ä½ç½®
        alive_particles = []
        for p in self.particles:
            p['d'] -= p['s'] # å‘åœ†å¿ƒå¸å…¥
            if p['d'] > 0:
                alive_particles.append(p)
        self.particles = alive_particles

    def paintEvent(self, e):
        p = QPainter(self)
        p.setRenderHint(QPainter.Antialiasing)

        cx, cy = 32, 32
        
        # === èµ›åšé…è‰² (Cyber Palette) ===
        if self.is_hovering:
            # æ‹–æ‹½æ‚¬åœçŠ¶æ€: é‡‘/æ©™
            main_color = QColor(255, 215, 0)      # Gold
            glow_color = QColor(255, 69, 0, 150)  # Orange Glow
            bg_color = QColor(20, 0, 0, 200)
        elif self.is_clipboard_active:
            # å‰ªè´´æ¿æˆåŠŸçŠ¶æ€: ç´«/é’ (Neon Purple & Cyan)
            main_color = QColor(138, 43, 226)     # Purple
            glow_color = QColor(0, 255, 255, 150) # Cyan Glow
            bg_color = QColor(20, 0, 40, 220)     # æ·±ç´«èƒŒæ™¯
        else:
            # å¸¸æ€: å½©è™¹å‘¼å¸
            main_color = QColor.fromHsvF(self.hue / 360.0, 0.9, 1.0)
            glow_color = QColor.fromHsvF(self.hue / 360.0, 0.7, 1.0, 0.4)
            bg_color = QColor(0, 15, 30, 180)

        # 1. ç»˜åˆ¶æ ¸å¿ƒèƒŒæ™¯
        p.setPen(Qt.NoPen)
        p.setBrush(bg_color)
        p.drawEllipse(4, 4, 56, 56)

        # 2. ç»˜åˆ¶ç²’å­æµ
        if self.is_hovering or self.is_clipboard_active:
            # å‰ªè´´æ¿çŠ¶æ€ä½¿ç”¨é’è‰²ç²’å­ï¼Œæ‹–æ‹½çŠ¶æ€ä½¿ç”¨ç™½è‰²ç²’å­
            particle_color = QColor(0, 255, 255, 200) if self.is_clipboard_active else QColor(255, 255, 255, 180)
            p.setPen(QPen(particle_color, 1.5))
            for pt in self.particles:
                px = cx + math.cos(pt['a']) * pt['d']
                py = cy + math.sin(pt['a']) * pt['d']
                p.drawPoint(QPoint(int(px), int(py)))

        # 3. ç»˜åˆ¶å¤–ç¯ (ä¸‰æ®µä¸å¯¹ç§°ï¼Œæ¨¡æ‹ŸHUD)
        pen_outer = QPen(main_color)
        pen_outer.setWidth(3)
        pen_outer.setCapStyle(Qt.RoundCap)
        p.setPen(pen_outer)
        p.setBrush(Qt.NoBrush)
        
        rect_outer = QRectF(6, 6, 52, 52)
        start_angle = int(self.angle_outer * 16)
        p.drawArc(rect_outer, start_angle, 16 * 60)          # 60åº¦é•¿å¼§
        p.drawArc(rect_outer, start_angle + 16*120, 16 * 30) # 30åº¦çŸ­å¼§
        p.drawArc(rect_outer, start_angle + 16*200, 16 * 100)# 100åº¦å¤§å¼§

        # 4. ç»˜åˆ¶å†…ç¯ (ä¸‰æ®µå¯¹ç§°ï¼Œæ¨¡æ‹Ÿæœºæ¢°é”æ‰£)
        pen_inner = QPen(main_color)
        pen_inner.setWidth(2)
        pen_inner.setCapStyle(Qt.FlatCap)
        p.setPen(pen_inner)
        
        rect_inner = QRectF(14, 14, 36, 36)
        start_angle_in = int(self.angle_inner * 16)
        
        p.drawArc(rect_inner, start_angle_in, 16 * 80)
        p.drawArc(rect_inner, start_angle_in + 16 * 120, 16 * 80)
        p.drawArc(rect_inner, start_angle_in + 16 * 240, 16 * 80)

        # 5. ç»˜åˆ¶ä¸­å¿ƒé—ªç”µå›¾æ ‡
        font = QFont('Arial', 18, QFont.Bold)
        p.setFont(font)
        
        # è¾‰å…‰å±‚
        p.setPen(glow_color)
        p.drawText(self.rect().adjusted(1,1,1,1), Qt.AlignCenter, 'âš¡')
        
        # å®ä½“å±‚
        p.setPen(QColor(255, 255, 255))
        p.drawText(self.rect(), Qt.AlignCenter, 'âš¡')

    # --- äº¤äº’é€»è¾‘ ---
    def dragEnterEvent(self, e):
        if e.mimeData().hasText():
            e.accept()
            self.is_hovering = True
        else:
            e.ignore()

    def dragLeaveEvent(self, e):
        self.is_hovering = False

    def dropEvent(self, e):
        self.is_hovering = False
        text = e.mimeData().text()
        if text.strip():
            self.mw.quick_add_idea(text)
            e.acceptProposedAction()

    def mousePressEvent(self, e):
        if e.button() == Qt.LeftButton:
            self.dragging = True
            self.offset = e.pos()

    def mouseMoveEvent(self, e):
        if self.dragging:
            self.move(self.mapToGlobal(e.pos() - self.offset))

    def mouseReleaseEvent(self, e):
        if self.dragging:
            self.dragging = False
            pos = self.pos()
            save_setting('floating_ball_pos', {'x': pos.x(), 'y': pos.y()})

    def mouseDoubleClickEvent(self, e):
        if e.button() == Qt.LeftButton:
            self.double_clicked.emit()

    def contextMenuEvent(self, e):
        m = QMenu(self)
        m.setStyleSheet("""
            QMenu { background-color: #1a1a1a; color: #00f3ff; border: 1px solid #333; padding: 5px; }
            QMenu::item { padding: 5px 20px; }
            QMenu::item:selected { background-color: #00f3ff; color: #000; border-radius: 2px;}
            QMenu::separator { background-color: #333; height: 1px; margin: 5px 0; }
        """)
        m.addAction('âš¡ æ‰“å¼€å¿«é€Ÿç¬”è®°', self.request_show_quick_window.emit)
        m.addAction('ğŸ’» æ‰“å¼€ä¸»ç•Œé¢', self.request_show_main_window.emit)
        m.addAction('â• æ–°å»ºçµæ„Ÿ', self.mw.new_idea)
        m.addSeparator()
        m.addAction('âŒ é€€å‡º', self.request_quit_app.emit)
        m.exec_(e.globalPos())
```

## æ–‡ä»¶: cards.py

```python
# -*- coding: utf-8 -*-
# ui/cards.py
import sys
from PyQt5.QtWidgets import QFrame, QVBoxLayout, QHBoxLayout, QLabel, QApplication, QSizePolicy
from PyQt5.QtCore import Qt, pyqtSignal, QMimeData, QSize
from PyQt5.QtGui import QDrag, QPixmap, QImage
from core.config import STYLES

class IdeaCard(QFrame):
    # (id, is_ctrl, is_shift)
    selection_requested = pyqtSignal(int, bool, bool)
    double_clicked = pyqtSignal(int)

    def __init__(self, data, db, parent=None):
        super().__init__(parent)
        self.setAttribute(Qt.WA_StyledBackground)
        
        self.data = data
        self.db = db
        self.id = data[0]
        self.setCursor(Qt.PointingHandCursor)
        
        # --- çŠ¶æ€å˜é‡ ---
        self._drag_start_pos = None
        self._is_potential_click = False
        
        # è¿™æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œä¼šåœ¨ main_window ä¸­è¢«èµ‹å€¼
        self.get_selected_ids_func = None
        
        self._init_ui()

    def _init_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(15, 12, 15, 12)
        layout.setSpacing(8) # å¢åŠ ä¸€ç‚¹å†…éƒ¨é—´è·
        
        # --- 1. é¡¶éƒ¨ï¼šæ ‡é¢˜ + å›¾æ ‡ ---
        top = QHBoxLayout()
        top.setSpacing(8)
        
        # æ ‡é¢˜ (å¯¹äºå›¾ç‰‡ï¼Œå¦‚æœæ ‡é¢˜æ˜¯é»˜è®¤çš„"[å›¾ç‰‡]"ï¼Œå¯ä»¥æ˜¾ç¤ºå¾—æ·¡ä¸€ç‚¹ï¼Œæˆ–è€…ä¿æŒåŸæ ·)
        title_text = self.data[1]
        title = QLabel(title_text)
        title.setStyleSheet("font-size:15px; font-weight:bold; background:transparent; color:white;")
        title.setWordWrap(False)
        top.addWidget(title, stretch=1)
        
        # å›¾æ ‡åŒºåŸŸ (ç½®é¡¶/æ”¶è—)
        icon_layout = QHBoxLayout()
        icon_layout.setSpacing(4)
        if self.data[4]:  # is_pinned
            pin_icon = QLabel('ğŸ“Œ')
            pin_icon.setStyleSheet("background:transparent; font-size:12px;")
            icon_layout.addWidget(pin_icon)
        if self.data[5]:  # is_favorite
            fav_icon = QLabel('â­')
            fav_icon.setStyleSheet("background:transparent; font-size:12px;")
            icon_layout.addWidget(fav_icon)
            
        top.addLayout(icon_layout)
        layout.addLayout(top)
        
        # --- 2. ä¸­éƒ¨ï¼šå†…å®¹é¢„è§ˆ (æ–‡æœ¬ æˆ– å›¾ç‰‡) ---
        # è§£ææ•°æ®ç±»å‹
        # dataç»“æ„: 0:id, 1:title, 2:content ... 10:item_type, 11:data_blob
        item_type = self.data[10] if len(self.data) > 10 and self.data[10] else 'text'
        
        if item_type == 'image':
            # === å›¾ç‰‡æ¨¡å¼ ===
            blob_data = self.data[11] if len(self.data) > 11 else None
            if blob_data:
                pixmap = QPixmap()
                pixmap.loadFromData(blob_data)
                
                if not pixmap.isNull():
                    img_label = QLabel()
                    # é™åˆ¶æœ€å¤§æ˜¾ç¤ºé«˜åº¦ï¼Œé˜²æ­¢å¡ç‰‡è¿‡å¤§
                    max_height = 160
                    if pixmap.height() > max_height:
                        pixmap = pixmap.scaledToHeight(max_height, Qt.SmoothTransformation)
                    
                    # å¦‚æœå®½åº¦ä¹Ÿå¤ªå®½ï¼Œé™åˆ¶å®½åº¦
                    if pixmap.width() > 400: # å‡è®¾å¡ç‰‡å¤§æ¦‚è¿™ä¹ˆå®½
                        pixmap = pixmap.scaledToWidth(400, Qt.SmoothTransformation)
                        
                    img_label.setPixmap(pixmap)
                    img_label.setAlignment(Qt.AlignLeft | Qt.AlignTop)
                    img_label.setStyleSheet("background: transparent; border-radius: 4px;")
                    layout.addWidget(img_label)
                else:
                    err_label = QLabel("[å›¾ç‰‡æ— æ³•åŠ è½½]")
                    err_label.setStyleSheet("color: #666; font-style: italic;")
                    layout.addWidget(err_label)
        else:
            # === æ–‡æœ¬/æ–‡ä»¶æ¨¡å¼ ===
            if self.data[2]:
                content_str = self.data[2].strip()
                
                # è·å–ä¸€æ®µè¾ƒé•¿çš„æ–‡æœ¬ï¼Œè®© Label è‡ªåŠ¨æ¢è¡Œ
                preview_text = content_str[:300].replace('\n', ' ').replace('\r', '')
                if len(content_str) > 300:
                    preview_text += "..."
                    
                content = QLabel(preview_text)
                content.setStyleSheet("""
                    color: rgba(255,255,255,180); 
                    margin-top: 2px; 
                    background: transparent; 
                    font-size: 13px;
                    line-height: 1.4;
                """)
                content.setWordWrap(True)
                content.setAlignment(Qt.AlignTop | Qt.AlignLeft)
                # é™åˆ¶é«˜åº¦ï¼Œå¤§æ¦‚æ˜¾ç¤º 3 è¡Œæ–‡å­—çš„é«˜åº¦
                content.setMaximumHeight(65) 
                layout.addWidget(content)
            
        # --- 3. åº•éƒ¨ï¼šæ—¶é—´ + æ ‡ç­¾ ---
        bot = QHBoxLayout()
        bot.setSpacing(6)
        
        # æ—¶é—´
        time_str = self.data[7][:16] # YYYY-MM-DD HH:mm
        time_label = QLabel(f'ğŸ•’ {time_str}')
        time_label.setStyleSheet("color:rgba(255,255,255,100); font-size:11px; background:transparent;")
        bot.addWidget(time_label)
        
        bot.addStretch()
        
        # æ ‡ç­¾
        tags = self.db.get_tags(self.id)
        visible_tags = tags[:3]
        remaining = len(tags) - 3
        
        for tag in visible_tags:
            tag_label = QLabel(f"#{tag}")
            tag_label.setStyleSheet("""
                background: rgba(255,255,255,0.1); 
                border-radius: 4px; 
                padding: 2px 6px; 
                font-size: 10px; 
                color: rgba(255,255,255,180);
            """)
            bot.addWidget(tag_label)
            
        if remaining > 0:
            more_label = QLabel(f'+{remaining}')
            more_label.setStyleSheet("""
                background: rgba(74,144,226,0.3); 
                border-radius: 4px; 
                padding: 2px 6px; 
                font-size: 10px; 
                color: #4a90e2;
                font-weight:bold;
            """)
            bot.addWidget(more_label)
            
        layout.addLayout(bot)
        self.update_selection(False)

    def update_selection(self, selected):
        bg_color = self.data[3]
        
        # åŸºç¡€æ ·å¼
        base_style = f"""
            IdeaCard {{
                background-color: {bg_color};
                {STYLES['card_base']}
                padding: 0px;
            }}
            QLabel {{
                background-color: transparent;
                border: none;
            }}
        """

        if selected:
            # é€‰ä¸­çŠ¶æ€ï¼šç™½è‰²ç²—è¾¹æ¡†
            border_style = "border: 2px solid white;"
        else:
            # æœªé€‰ä¸­çŠ¶æ€ï¼šé€æ˜å¾®å¼±è¾¹æ¡†ï¼Œæ‚¬åœå˜äº®
            border_style = """
                border: 1px solid rgba(255,255,255,0.1);
            """
            
        # åˆå¹¶ hover æ•ˆæœåˆ°æ ·å¼è¡¨ä¸­
        final_style = base_style + f"""
            IdeaCard {{ {border_style} }}
            IdeaCard:hover {{
                border: 2px solid rgba(255,255,255,0.4);
            }}
        """
        
        # å¦‚æœé€‰ä¸­äº†ï¼Œéœ€è¦è¦†ç›– hover æ ·å¼ï¼Œä¿æŒé€‰ä¸­çŠ¶æ€çš„è¾¹æ¡†
        if selected:
            final_style += """
                IdeaCard:hover {
                    border: 2px solid white;
                }
            """
            
        self.setStyleSheet(final_style)

    def mousePressEvent(self, e):
        if e.button() == Qt.LeftButton:
            self._drag_start_pos = e.pos()
            self._is_potential_click = True
        super().mousePressEvent(e)

    def mouseMoveEvent(self, e):
        if not (e.buttons() & Qt.LeftButton) or not self._drag_start_pos:
            return
        
        if (e.pos() - self._drag_start_pos).manhattanLength() < QApplication.startDragDistance():
            return
        
        # æ‹–æ‹½å¼€å§‹ï¼Œå–æ¶ˆç‚¹å‡»åˆ¤å®š
        self._is_potential_click = False
        
        drag = QDrag(self)
        mime = QMimeData()
        
        # --- æ‰¹é‡æ‹–æ‹½æ”¯æŒ ---
        ids_to_move = [self.id]
        if self.get_selected_ids_func:
            selected_ids = self.get_selected_ids_func()
            if self.id in selected_ids:
                ids_to_move = selected_ids
        
        mime.setData('application/x-idea-ids', (','.join(map(str, ids_to_move))).encode('utf-8'))
        mime.setData('application/x-idea-id', str(self.id).encode())
        
        drag.setMimeData(mime)
        
        pixmap = self.grab().scaledToWidth(200, Qt.SmoothTransformation)
        drag.setPixmap(pixmap)
        drag.setHotSpot(e.pos())
        
        drag.exec_(Qt.MoveAction)
        
    def mouseReleaseEvent(self, e):
        if self._is_potential_click and e.button() == Qt.LeftButton:
            modifiers = QApplication.keyboardModifiers()
            is_ctrl = bool(modifiers & Qt.ControlModifier)
            is_shift = bool(modifiers & Qt.ShiftModifier)
            self.selection_requested.emit(self.id, is_ctrl, is_shift)

        self._drag_start_pos = None
        self._is_potential_click = False
        super().mouseReleaseEvent(e)

    def mouseDoubleClickEvent(self, e):
        if e.button() == Qt.LeftButton:
            self.double_clicked.emit(self.id)
        super().mouseDoubleClickEvent(e)
```

## æ–‡ä»¶: category_repository.py

```python
# data/repositories/category_repository.py

class CategoryRepository:
    def __init__(self, conn):
        self.conn = conn

    def get_all(self):
        c = self.conn.cursor()
        c.execute('SELECT * FROM categories ORDER BY sort_order ASC, name ASC')
        return c.fetchall()

    def add(self, name, parent_id=None):
        c = self.conn.cursor()
        if parent_id is None:
            c.execute("SELECT MAX(sort_order) FROM categories WHERE parent_id IS NULL")
        else:
            c.execute("SELECT MAX(sort_order) FROM categories WHERE parent_id = ?", (parent_id,))
        max_order = c.fetchone()[0]
        new_order = (max_order or 0) + 1
        
        c.execute('INSERT INTO categories (name, parent_id, sort_order) VALUES (?, ?, ?)', (name, parent_id, new_order))
        self.conn.commit()

    def rename(self, cat_id, new_name):
        c = self.conn.cursor()
        c.execute('UPDATE categories SET name=? WHERE id=?', (new_name, cat_id))
        self.conn.commit()

    def delete(self, cid):
        c = self.conn.cursor()
        # Note: Moving ideas should be a service-level concern
        c.execute('UPDATE ideas SET category_id=NULL WHERE category_id=?', (cid,))
        c.execute('DELETE FROM categories WHERE id=?', (cid,))
        self.conn.commit()

    def get_tree(self):
        class Partition:
            def __init__(self, id, name, color, parent_id, sort_order):
                self.id = id
                self.name = name
                self.color = color
                self.parent_id = parent_id
                self.sort_order = sort_order
                self.children = []

        c = self.conn.cursor()
        c.execute("SELECT id, name, color, parent_id, sort_order FROM categories ORDER BY sort_order ASC, name ASC")
        
        nodes = {row[0]: Partition(*row) for row in c.fetchall()}
        
        tree = []
        for node_id, node in nodes.items():
            if node.parent_id in nodes:
                nodes[node.parent_id].children.append(node)
            else:
                tree.append(node)
                
        return tree

    def save_order(self, update_list):
        c = self.conn.cursor()
        try:
            c.execute("BEGIN TRANSACTION")
            for item in update_list:
                c.execute(
                    "UPDATE categories SET sort_order = ?, parent_id = ? WHERE id = ?",
                    (item['sort_order'], item['parent_id'], item['id'])
                )
            c.execute("COMMIT")
        except Exception as e:
            c.execute("ROLLBACK")
            # Should raise this exception to be handled by the service layer
            raise e
```

## æ–‡ä»¶: clipboard.py

```python
# -*- coding: utf-8 -*-
# services/clipboard.py
import datetime
import os
import uuid
import hashlib
from PyQt5.QtCore import QObject, pyqtSignal, QBuffer
from PyQt5.QtGui import QImage
from PyQt5.QtWidgets import QApplication

class ClipboardManager(QObject):
    """
    ç®¡ç†å‰ªè´´æ¿æ•°æ®ï¼Œå¤„ç†æ•°æ®å¹¶å°†å…¶å­˜å…¥æ•°æ®åº“ã€‚
    """
    data_captured = pyqtSignal(int)

    def __init__(self, db_manager):
        super().__init__()
        self.db = db_manager
        self._last_hash = None

    def _hash_data(self, data):
        """ä¸ºæ•°æ®åˆ›å»ºä¸€ä¸ªç®€å•çš„å“ˆå¸Œå€¼ä»¥æ£€æŸ¥é‡å¤ã€‚"""
        if isinstance(data, QImage):
            return hash(data.bits().tobytes())
        return hashlib.md5(str(data).encode('utf-8')).hexdigest()

    def process_clipboard(self, mime_data, category_id=None):
        """
        å¤„ç†æ¥è‡ªå‰ªè´´æ¿çš„ MIME æ•°æ®ã€‚
        """
        # 1. å±è”½å†…éƒ¨æ“ä½œ
        if QApplication.activeWindow() is not None:
            return

        extra_tags = set() # ç”¨äºæ”¶é›†æ™ºèƒ½åˆ†æçš„æ ‡ç­¾

        try:
            # --- ä¼˜å…ˆå¤„ç† æ–‡ä»¶/æ–‡ä»¶å¤¹ ---
            if mime_data.hasUrls():
                urls = mime_data.urls()
                filepaths = [url.toLocalFile() for url in urls if url.isLocalFile()]
                
                if filepaths:
                    content = ";".join(filepaths)
                    current_hash = self._hash_data(content)
                    
                    if current_hash != self._last_hash:
                        
                        # ã€æ™ºèƒ½æ‰“æ ‡é€»è¾‘ï¼šæ–‡ä»¶ä¸æ–‡ä»¶å¤¹ã€‘
                        for path in filepaths:
                            if os.path.isdir(path):
                                extra_tags.add("æ–‡ä»¶å¤¹")
                            elif os.path.isfile(path):
                                # æå–æ‰©å±•åï¼Œè½¬å°å†™ï¼Œå»ç‚¹
                                ext = os.path.splitext(path)[1].lower().lstrip('.')
                                if ext:
                                    extra_tags.add(ext)

                        result = self.db.add_clipboard_item(item_type='file', content=content, category_id=category_id)
                        self._last_hash = current_hash
                        
                        if result:
                            idea_id, is_new = result
                            if is_new:
                                # ã€åº”ç”¨æ™ºèƒ½æ ‡ç­¾ã€‘
                                if extra_tags:
                                    self.db.add_tags_to_multiple_ideas([idea_id], list(extra_tags))
                                self.data_captured.emit(idea_id)
                        return

            # --- å¤„ç†å›¾ç‰‡ ---
            if mime_data.hasImage():
                image = mime_data.imageData()
                buffer = QBuffer()
                buffer.open(QBuffer.ReadWrite)
                image.save(buffer, "PNG")
                image_bytes = buffer.data()
                
                current_hash = hashlib.md5(image_bytes).hexdigest()
                
                if current_hash != self._last_hash:
                    result = self.db.add_clipboard_item(item_type='image', content='[Image Data]', data_blob=image_bytes, category_id=category_id)
                    self._last_hash = current_hash
                    
                    if result:
                        idea_id, is_new = result
                        if is_new:
                            self.data_captured.emit(idea_id)
                    return

            # --- å¤„ç†æ–‡æœ¬ (å«ç½‘å€è¯†åˆ«) ---
            if mime_data.hasText():
                text = mime_data.text()
                if not text.strip(): return
                
                current_hash = self._hash_data(text)
                if current_hash != self._last_hash:
                    
                    # ã€æ™ºèƒ½æ‰“æ ‡é€»è¾‘ï¼šç½‘å€ã€‘
                    stripped_text = text.strip()
                    if stripped_text.startswith(('http://', 'https://')):
                        extra_tags.add("ç½‘å€")
                        extra_tags.add("é“¾æ¥")
                    
                    result = self.db.add_clipboard_item(item_type='text', content=text, category_id=category_id)
                    self._last_hash = current_hash
                    
                    if result:
                        idea_id, is_new = result
                        if is_new:
                            # ã€åº”ç”¨æ™ºèƒ½æ ‡ç­¾ã€‘
                            if extra_tags:
                                self.db.add_tags_to_multiple_ideas([idea_id], list(extra_tags))
                            self.data_captured.emit(idea_id)
                    return

        except Exception as e:
            pass
```

## æ–‡ä»¶: clipboard_service.py

```python
# services/clipboard_service.py
import os
from PyQt5.QtCore import QObject, pyqtSignal, QBuffer
from PyQt5.QtGui import QImage

class ClipboardService(QObject):
    data_captured = pyqtSignal()

    def __init__(self, idea_repo, tag_repo, hash_calculator):
        super().__init__()
        self.idea_repo = idea_repo
        self.tag_repo = tag_repo
        self.hasher = hash_calculator

    def process_mime_data(self, mime_data, category_id=None):
        try:
            if mime_data.hasUrls():
                urls = mime_data.urls()
                filepaths = [url.toLocalFile() for url in urls if url.isLocalFile()]
                if filepaths:
                    content = ";".join(filepaths)
                    self._save_clipboard_item('file', content, category_id=category_id)
                    return

            if mime_data.hasImage():
                image = mime_data.imageData()
                buffer = QBuffer()
                buffer.open(QBuffer.ReadWrite)
                image.save(buffer, "PNG")
                image_bytes = buffer.data()
                self._save_clipboard_item('image', '[Image Data]', data_blob=image_bytes, category_id=category_id)
                return

            if mime_data.hasText():
                text = mime_data.text()
                if text:
                    self._save_clipboard_item('text', text, category_id=category_id)
                    return
        except Exception as e:
            # Proper logging should be added here
            pass

    def _save_clipboard_item(self, item_type, content, data_blob=None, category_id=None):
        content_hash = self.hasher.compute(content, data_blob)
        if not content_hash:
            return

        existing_idea = self.idea_repo.find_by_hash(content_hash)

        if existing_idea:
            idea_id = existing_idea[0]
            self.idea_repo.update_timestamp(idea_id)
            return idea_id
        else:
            if item_type == 'text':
                title = content.strip().split('\\n')[0][:50]
            elif item_type == 'image':
                title = "[å›¾ç‰‡]"
            elif item_type == 'file':
                title = f"[æ–‡ä»¶] {os.path.basename(content.split(';')[0])}"
            else:
                title = "æœªå‘½å"
            
            idea_id = self.idea_repo.add(
                title=title,
                content=content,
                color=None, # Use default color
                category_id=category_id,
                item_type=item_type,
                data_blob=data_blob,
                content_hash=content_hash
            )
            
            # Automatically add "å‰ªè´´æ¿" tag
            existing_tags = self.tag_repo.get_tags_for_idea(idea_id)
            if "å‰ªè´´æ¿" not in existing_tags:
                existing_tags.append("å‰ªè´´æ¿")
                self.tag_repo.update_tags_for_idea(idea_id, existing_tags)
            
            self.data_captured.emit()
            return idea_id
```

## æ–‡ä»¶: common_tags.py

```python
# -*- coding: utf-8 -*-
# ui/common_tags.py

from PyQt5.QtWidgets import (QWidget, QPushButton, QMenu, QInputDialog, 
                             QLayout, QSizePolicy)
from PyQt5.QtCore import Qt, pyqtSignal, QRect, QSize, QPoint
from core.config import COLORS
from core.settings import load_setting, save_setting

# --- æ ¸å¿ƒç»„ä»¶ï¼šæµå¼å¸ƒå±€ ---
class FlowLayout(QLayout):
    def __init__(self, parent=None, margin=0, spacing=-1):
        super(FlowLayout, self).__init__(parent)
        if parent is not None:
            self.setContentsMargins(margin, margin, margin, margin)
        self.setSpacing(spacing)
        self.itemList = []

    def __del__(self):
        item = self.takeAt(0)
        while item:
            item = self.takeAt(0)

    def addItem(self, item):
        self.itemList.append(item)

    def count(self):
        return len(self.itemList)

    def itemAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList[index]
        return None

    def takeAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList.pop(index)
        return None

    def expandingDirections(self):
        return Qt.Orientations(Qt.Orientation(0))

    def hasHeightForWidth(self):
        return True

    def heightForWidth(self, width):
        height = self.doLayout(QRect(0, 0, width, 0), True)
        return height

    def setGeometry(self, rect):
        super(FlowLayout, self).setGeometry(rect)
        self.doLayout(rect, False)

    def sizeHint(self):
        return self.minimumSize()

    def minimumSize(self):
        size = QSize()
        for item in self.itemList:
            size = size.expandedTo(item.minimumSize())
        margin = self.contentsMargins()
        size += QSize(margin.left() + margin.right(), margin.top() + margin.bottom())
        return size

    def doLayout(self, rect, testOnly):
        x = rect.x()
        y = rect.y()
        lineHeight = 0
        spacing = self.spacing()

        for item in self.itemList:
            wid = item.widget()
            spaceX = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Horizontal)
            spaceY = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Vertical)
            
            nextX = x + item.sizeHint().width() + spaceX
            if nextX - spaceX > rect.right() and lineHeight > 0:
                x = rect.x()
                y = y + lineHeight + spaceY
                nextX = x + item.sizeHint().width() + spaceX
                lineHeight = 0

            if not testOnly:
                item.setGeometry(QRect(QPoint(x, y), item.sizeHint()))

            x = nextX
            lineHeight = max(lineHeight, item.sizeHint().height())

        return y + lineHeight - rect.y()

# --- ä¸»ç±» ---
class CommonTags(QWidget):
    tag_toggled = pyqtSignal(str, bool) 
    manager_requested = pyqtSignal()
    refresh_requested = pyqtSignal()

    def __init__(self, parent=None):
        super().__init__(parent)
        self.limit = load_setting('common_tags_limit', 5)
        self.tag_buttons = [] 
        
        self._init_ui()
        self.reload_tags()

    def _init_ui(self):
        # ã€æ ¸å¿ƒä¿®å¤ã€‘é‡å‘½åå˜é‡ä¸º flow_layoutï¼Œé¿å…é®æŒ¡ QWidget.layout() æ–¹æ³•
        self.flow_layout = FlowLayout(self, margin=0, spacing=6)
        
        self.setAttribute(Qt.WA_TranslucentBackground)
        
        self.setMinimumWidth(320) 
        self.setMaximumWidth(380) 
        self.setSizePolicy(QSizePolicy.Preferred, QSizePolicy.Minimum)
        
        self.setContextMenuPolicy(Qt.CustomContextMenu)
        self.customContextMenuRequested.connect(self._show_context_menu)

    def reload_tags(self):
        # ã€æ ¸å¿ƒä¿®å¤ã€‘å®‰å…¨çš„æ¸…ç†é€»è¾‘
        if self.flow_layout:
            while self.flow_layout.count():
                item = self.flow_layout.takeAt(0)
                if item and item.widget():
                    item.widget().deleteLater()
        
        self.tag_buttons.clear()

        raw_tags = load_setting('manual_common_tags', ['å·¥ä½œ', 'å¾…åŠ', 'é‡è¦'])
        limit = load_setting('common_tags_limit', 5)

        processed_tags = []
        for item in raw_tags:
            if isinstance(item, str):
                processed_tags.append({'name': item, 'visible': True})
            elif isinstance(item, dict):
                processed_tags.append(item)
        
        visible_tags = [t for t in processed_tags if t.get('visible', True)]
        display_tags = visible_tags[:limit]

        for tag in display_tags:
            name = tag['name']
            btn = QPushButton(name)
            btn.setCheckable(True)
            btn.setCursor(Qt.PointingHandCursor)
            btn.setProperty("tag_name", name)
            
            self._update_btn_style(btn)
            
            btn.toggled.connect(lambda checked, b=btn, n=name: self._on_btn_toggled(b, n, checked))
            
            self.flow_layout.addWidget(btn)
            self.tag_buttons.append(btn)

        btn_edit = QPushButton("âš™")
        btn_edit.setToolTip("ç®¡ç†æ ‡ç­¾")
        btn_edit.setCursor(Qt.PointingHandCursor)
        btn_edit.setStyleSheet(f"""
            QPushButton {{
                background-color: rgba(255, 255, 255, 0.05);
                color: #666;
                border: none;
                border-radius: 10px;
                width: 20px;
                height: 20px;
                padding: 0px;
                font-size: 12px;
            }}
            QPushButton:hover {{
                background-color: rgba(255, 255, 255, 0.1);
                color: {COLORS['primary']};
            }}
        """)
        btn_edit.clicked.connect(self.manager_requested.emit)
        self.flow_layout.addWidget(btn_edit)
        
        self.refresh_requested.emit()

    def reset_selection(self):
        for btn in self.tag_buttons:
            btn.blockSignals(True)
            btn.setChecked(False)
            self._update_btn_style(btn)
            btn.blockSignals(False)

    def _on_btn_toggled(self, btn, name, checked):
        self._update_btn_style(btn)
        self.tag_toggled.emit(name, checked)

    def _update_btn_style(self, btn):
        checked = btn.isChecked()
        name = btn.property("tag_name")
        
        if checked:
            btn.setText(f"âœ“ {name}")
            btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: {COLORS['primary']};
                    color: white;
                    border: 1px solid {COLORS['primary']};
                    border-radius: 12px;
                    padding: 3px 10px;
                    font-size: 11px;
                    font-family: "Microsoft YaHei", sans-serif;
                    font-weight: bold;
                }}
            """)
        else:
            btn.setText(name)
            btn.setStyleSheet(f"""
                QPushButton {{
                    background-color: rgba(255, 255, 255, 0.08);
                    color: #CCC;
                    border: 1px solid transparent;
                    border-radius: 12px;
                    padding: 3px 10px;
                    font-size: 11px;
                    font-family: "Microsoft YaHei", sans-serif;
                }}
                QPushButton:hover {{
                    background-color: rgba(255, 255, 255, 0.15);
                    border: 1px solid #555;
                    color: white;
                }}
            """)
        
        # ã€æ ¸å¿ƒä¿®å¤ã€‘ç§»é™¤ adjustSize()ï¼Œé˜²æ­¢åœ¨å¸ƒå±€è¿‡ç¨‹ä¸­è§¦å‘é‡ç»˜å¾ªç¯å¯¼è‡´å´©æºƒ
        # æµå¼å¸ƒå±€ä¼šè‡ªåŠ¨å¤„ç†å¤§å°

    def _show_context_menu(self, pos):
        menu = QMenu(self)
        menu.setStyleSheet(f"""
            QMenu {{ background-color: #2D2D2D; color: #EEE; border: 1px solid #444; border-radius: 6px; padding: 4px; }}
            QMenu::item {{ padding: 6px 20px; border-radius: 4px; }}
            QMenu::item:selected {{ background-color: {COLORS['primary']}; color: white; }}
        """)
        action_set_num = menu.addAction(f"ğŸ”¢ æ˜¾ç¤ºæ•°é‡ (å½“å‰: {self.limit})")
        action_set_num.triggered.connect(self._set_tag_limit)
        menu.exec_(self.mapToGlobal(pos))

    def _set_tag_limit(self):
        num, ok = QInputDialog.getInt(self, "è®¾ç½®", "æ˜¾ç¤ºæ•°é‡:", value=self.limit, min=1, max=20)
        if ok:
            self.limit = num
            save_setting('common_tags_limit', num)
            self.reload_tags()
```

## æ–‡ä»¶: common_tags_manager.py

```python
ï»¿# -*- coding: utf-8 -*-
# ui/common_tags_manager.py

from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QListWidget, 
                             QLineEdit, QPushButton, QLabel, QListWidgetItem, 
                             QMessageBox, QAbstractItemView, QSpinBox, QCheckBox, QWidget, QGraphicsDropShadowEffect)
from PyQt5.QtCore import Qt, QSize
from PyQt5.QtGui import QColor
from core.config import COLORS
from core.settings import load_setting, save_setting

class CommonTagsManager(QDialog):
    """
    å¸¸ç”¨æ ‡ç­¾ç®¡ç†ç•Œé¢ (ç°ä»£å¡ç‰‡é£æ ¼ç‰ˆ)
    - è§†è§‰å‡çº§ï¼šç‹¬ç«‹çš„åœ†è§’å¡ç‰‡åˆ—è¡¨ï¼Œå»é™¤ä¼ ç»Ÿç½‘æ ¼æ„Ÿ
    - ä¿®å¤ï¼šæ»šåŠ¨æ¡æ ·å¼ç»Ÿä¸€ä¸ºç°ä»£æç®€é£æ ¼
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        
        # åŠ è½½æ•°æ®
        raw_tags = load_setting('manual_common_tags', ['å·¥ä½œ', 'å¾…åŠ', 'é‡è¦'])
        self.tags_data = []
        for item in raw_tags:
            if isinstance(item, str):
                self.tags_data.append({'name': item, 'visible': True})
            elif isinstance(item, dict):
                self.tags_data.append(item)
                
        self.limit = load_setting('common_tags_limit', 5)
        
        self.setWindowTitle("ğŸ·ï¸ ç®¡ç†å¸¸ç”¨æ ‡ç­¾")
        self.setWindowFlags(Qt.Dialog | Qt.FramelessWindowHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setFixedSize(340, 520) 
        
        self._init_ui()
        self._refresh_list()

    def _init_ui(self):
        # ä¸»å®¹å™¨
        container = QWidget(self)
        container.setGeometry(10, 10, 320, 500) 
        container.setStyleSheet(f"""
            QWidget {{
                background-color: #1E1E1E;
                border: 1px solid #333;
                border-radius: 12px;
                color: #EEE;
            }}
        """)
        
        # çª—å£é˜´å½±
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(20)
        shadow.setXOffset(0)
        shadow.setYOffset(5)
        shadow.setColor(QColor(0, 0, 0, 100))
        container.setGraphicsEffect(shadow)

        # --- ä¸»å¸ƒå±€ ---
        layout = QVBoxLayout(container)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        # 1. é¡¶éƒ¨æ ‡é¢˜æ  (æ ‡é¢˜ + å…³é—­æŒ‰é’®)
        header_layout = QHBoxLayout()
        header_layout.setContentsMargins(0, 0, 0, 0)
        
        title = QLabel("ç®¡ç†å¸¸ç”¨æ ‡ç­¾")
        title.setStyleSheet("font-weight: bold; font-size: 15px; border: none; color: #DDD;")
        header_layout.addWidget(title)
        
        header_layout.addStretch()
        
        self.btn_close = QPushButton("Ã—")
        self.btn_close.setFixedSize(32, 32)
        self.btn_close.setCursor(Qt.PointingHandCursor)
        self.btn_close.setToolTip("ä¿å­˜å¹¶å…³é—­")
        self.btn_close.clicked.connect(self._save_and_close)
        self.btn_close.setStyleSheet("""
            QPushButton { 
                background-color: transparent; 
                border: none; 
                font-size: 20px; 
                color: #888; 
                font-family: Arial;
                border-radius: 4px;
            } 
            QPushButton:hover { 
                background-color: #E81123; 
                color: white; 
            }
        """)
        header_layout.addWidget(self.btn_close)
        
        layout.addLayout(header_layout)
        
        # 2. è¾“å…¥åŒº
        input_container = QWidget()
        input_container.setStyleSheet("background: transparent; border: none;")
        input_layout = QHBoxLayout(input_container)
        input_layout.setContentsMargins(0, 0, 0, 0)
        input_layout.setSpacing(8)
        
        self.inp_tag = QLineEdit()
        self.inp_tag.setPlaceholderText("è¾“å…¥æ–°æ ‡ç­¾...")
        self.inp_tag.setStyleSheet(f"""
            QLineEdit {{
                background-color: #2D2D2D; 
                border: 1px solid #444; 
                border-radius: 6px; 
                padding: 8px 10px; 
                color: white;
                font-size: 13px;
            }}
            QLineEdit:focus {{ border-color: {COLORS['primary']}; background-color: #333; }}
        """)
        self.inp_tag.returnPressed.connect(self._add_tag)
        
        btn_add = QPushButton("æ·»åŠ ")
        btn_add.setCursor(Qt.PointingHandCursor)
        btn_add.setStyleSheet(f"""
            QPushButton {{
                background-color: {COLORS['primary']}; 
                color: white; 
                border: none; 
                border-radius: 6px; 
                padding: 8px 16px;
                font-weight: bold;
                font-size: 13px;
            }}
            QPushButton:hover {{ background-color: #357ABD; }}
        """)
        btn_add.clicked.connect(self._add_tag)
        
        input_layout.addWidget(self.inp_tag)
        input_layout.addWidget(btn_add)
        layout.addWidget(input_container)
        
        # 3. æ•°é‡é™åˆ¶
        limit_layout = QHBoxLayout()
        lbl_limit = QLabel("æ‚¬æµ®æ¡æœ€å¤§æ˜¾ç¤ºæ•°é‡:")
        lbl_limit.setStyleSheet("color: #AAA; font-size: 12px; border:none;")
        
        self.spin_limit = QSpinBox()
        self.spin_limit.setRange(1, 10)
        self.spin_limit.setValue(self.limit)
        self.spin_limit.setFixedWidth(60)
        self.spin_limit.setStyleSheet("""
            QSpinBox { 
                background-color: #2D2D2D; 
                border: 1px solid #444; 
                color: white; 
                padding: 4px; 
                border-radius: 4px; 
            }
            QSpinBox:focus { border-color: #555; }
            QSpinBox::up-button, QSpinBox::down-button { background: none; border: none; }
        """)
        
        limit_layout.addWidget(lbl_limit)
        limit_layout.addWidget(self.spin_limit)
        limit_layout.addStretch()
        layout.addLayout(limit_layout)
        
        # 4. åˆ—è¡¨åŒº
        lbl_hint = QLabel("ğŸ’¡ æ‹–æ‹½è°ƒæ•´é¡ºåºï¼Œå‹¾é€‰æ§åˆ¶æ˜¾ç¤º")
        lbl_hint.setStyleSheet("color: #666; font-size: 11px; border:none; margin-bottom: 5px;")
        layout.addWidget(lbl_hint)

        self.list_widget = QListWidget()
        # ã€å…³é”®ä¿®å¤ã€‘åœ¨æ­¤å¤„æ³¨å…¥ QScrollBar æ ·å¼ï¼Œè¦†ç›–ç³»ç»Ÿé»˜è®¤
        self.list_widget.setStyleSheet(f"""
            QListWidget {{ 
                background-color: transparent; 
                border: none; 
                outline: none; 
            }}
            QListWidget::item {{ 
                background-color: #2D2D2D; 
                color: #DDD; 
                border: 1px solid #3A3A3A;
                border-radius: 8px; 
                margin-bottom: 6px; 
                padding: 8px 10px; 
            }}
            QListWidget::item:hover {{ 
                background-color: #333333; 
                border: 1px solid #555;
            }}
            QListWidget::item:selected {{ 
                background-color: #2D2D2D; 
                border: 1px solid {COLORS['primary']}; 
                color: white; 
            }}
            QListWidget::indicator {{ 
                width: 16px; height: 16px; 
                border-radius: 4px; 
                border: 1px solid #666; 
                background: transparent;
            }}
            QListWidget::indicator:checked {{ 
                background-color: {COLORS['primary']}; 
                border-color: {COLORS['primary']}; 
                image: url(none); 
            }}
            
            /* --- ç°ä»£æ»šåŠ¨æ¡æ ·å¼ä¿®å¤ --- */
            QScrollBar:vertical {{
                border: none;
                background: transparent;
                width: 6px;
                margin: 0px;
            }}
            QScrollBar::handle:vertical {{
                background: #444;
                border-radius: 3px;
                min-height: 20px;
            }}
            QScrollBar::handle:vertical:hover {{
                background: #555;
            }}
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{
                height: 0px;
            }}
            QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {{
                background: none;
            }}
        """)
        
        self.list_widget.setDragDropMode(QAbstractItemView.InternalMove)
        self.list_widget.setDefaultDropAction(Qt.MoveAction)
        self.list_widget.setSelectionMode(QAbstractItemView.SingleSelection)
        self.list_widget.setVerticalScrollMode(QAbstractItemView.ScrollPerPixel) 
        
        layout.addWidget(self.list_widget)
        
        # 5. åº•éƒ¨æŒ‰é’®
        btn_del = QPushButton("åˆ é™¤é€‰ä¸­é¡¹")
        btn_del.setCursor(Qt.PointingHandCursor)
        btn_del.setStyleSheet(f"""
            QPushButton {{
                background-color: rgba(231, 76, 60, 0.1); 
                color: {COLORS['danger']}; 
                border: 1px solid {COLORS['danger']}; 
                border-radius: 6px; 
                padding: 8px;
                font-size: 13px;
            }}
            QPushButton:hover {{ 
                background-color: {COLORS['danger']}; 
                color: white; 
            }}
        """)
        btn_del.clicked.connect(self._del_tag)
        layout.addWidget(btn_del)
        
        # æ‹–æ‹½çª—å£æ”¯æŒ
        self.drag_pos = None

    def _refresh_list(self):
        """å°†æ•°æ®æ¸²æŸ“åˆ°åˆ—è¡¨"""
        self.list_widget.clear()
        for tag_data in self.tags_data:
            item = QListWidgetItem(tag_data['name'])
            item.setFlags(item.flags() | Qt.ItemIsUserCheckable | Qt.ItemIsDragEnabled)
            state = Qt.Checked if tag_data.get('visible', True) else Qt.Unchecked
            item.setCheckState(state)
            self.list_widget.addItem(item)

    def _add_tag(self):
        text = self.inp_tag.text().strip()
        if not text: return
        
        for i in range(self.list_widget.count()):
            if self.list_widget.item(i).text() == text:
                QMessageBox.warning(self, "æç¤º", "è¯¥æ ‡ç­¾å·²å­˜åœ¨")
                return
        
        item = QListWidgetItem(text)
        item.setFlags(item.flags() | Qt.ItemIsUserCheckable | Qt.ItemIsDragEnabled)
        item.setCheckState(Qt.Checked)
        self.list_widget.addItem(item)
        self.inp_tag.clear()
        self.list_widget.scrollToBottom()

    def _del_tag(self):
        row = self.list_widget.currentRow()
        if row >= 0:
            self.list_widget.takeItem(row)

    def _save_and_close(self):
        new_tags_data = []
        for i in range(self.list_widget.count()):
            item = self.list_widget.item(i)
            new_tags_data.append({
                'name': item.text(),
                'visible': (item.checkState() == Qt.Checked)
            })
            
        save_setting('manual_common_tags', new_tags_data)
        save_setting('common_tags_limit', self.spin_limit.value())
        self.accept()

    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            self.drag_pos = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()

    def mouseMoveEvent(self, event):
        if event.buttons() == Qt.LeftButton and self.drag_pos:
            self.move(event.globalPos() - self.drag_pos)
            event.accept()
```

## æ–‡ä»¶: config.py

```python
# core/config.py
DB_NAME = 'ideas.db'
BACKUP_DIR = 'backups'

COLORS = {
    'primary': '#4a90e2',   # æ ¸å¿ƒè“ (UIæŒ‰é’®ã€é«˜äº®)
    'success': '#2ecc71',   # æˆåŠŸç»¿
    'warning': '#f39c12',   # è­¦å‘Šé»„ (åæ©™é»„)
    'danger':  '#e74c3c',   # å±é™©çº¢
    'info':    '#9b59b6',   # ä¿¡æ¯ç´«
    'teal':    '#1abc9c',   # é’è‰²
    
    # ã€æ–°å¢ã€‘æ˜ç¡®å®šä¹‰çš„æ©™è‰² - ç”¨äºæ–°å»ºç¼–è¾‘çª—å£é»˜è®¤
    'orange':  '#FF8C00',   # æ·±æ©™è‰²
    
    # é»˜è®¤ç¬”è®°é¢œè‰² (æ·±ç°è‰²) - ç”¨äºå‰ªè´´æ¿è‡ªåŠ¨æŠ“å–
    'default_note': '#666666', 
    
    'bg_dark': '#1e1e1e',   # çª—å£èƒŒæ™¯ (æœ€æ·±)
    'bg_mid':  '#252526',   # ä¾§è¾¹æ /è¾“å…¥æ¡†èƒŒæ™¯ (æ¬¡æ·±)
    'bg_light': '#333333',  # è¾¹æ¡†/åˆ†å‰²çº¿
    
    'text':    '#cccccc',   # ä¸»æ–‡æœ¬
    'text_sub': '#858585'   # å‰¯æ–‡æœ¬
}

STYLES = {
    # === ä¸»çª—å£ç»“æ„ ===
    'main_window': f"""
        QWidget {{ background-color: {COLORS['bg_dark']}; color: {COLORS['text']}; font-family: "Microsoft YaHei", "Segoe UI", sans-serif; }}
        QSplitter::handle {{ background-color: {COLORS['bg_light']}; }}
        /* æ»šåŠ¨æ¡ç¾åŒ– V2 */
        QScrollBar:vertical {{
            border: none;
            background: transparent; /* èƒŒæ™¯é€æ˜ */
            width: 8px; /* å˜ç»†ä¸€ç‚¹ */
            margin: 0px;
        }}
        QScrollBar::handle:vertical {{
            background: #555; /* æ»‘å—é¢œè‰² */
            min-height: 25px;
            border-radius: 4px; /* åœ†è§’ */
        }}
        QScrollBar::handle:vertical:hover {{
            background: #666; /* æ‚¬åœæ—¶é¢œè‰² */
        }}
        QScrollBar::handle:vertical:pressed {{
            background: {COLORS['primary']}; /* æŒ‰ä¸‹æ—¶é¢œè‰² */
        }}
        /* ä¸Šä¸‹ç®­å¤´æŒ‰é’®ä¸æ˜¾ç¤º */
        QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{
            height: 0px;
        }}
        /* æ»‘é“ä¸æ˜¾ç¤º */
        QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {{
            background: none;
        }}
    """,
    
    # === ä¾§è¾¹æ  ===
    'sidebar': f"""
        QTreeWidget {{
            background-color: {COLORS['bg_mid']};
            color: #ddd;
            border: none;
            font-size: 13px;
            padding: 8px;
            outline: none;
        }}
        QTreeWidget::item {{
            height: 30px;
            padding: 2px 4px;
            border-radius: 4px;
            margin-bottom: 2px;
        }}
        QTreeWidget::item:hover {{ background-color: #2a2d2e; }}
        QTreeWidget::item:selected {{ background-color: #37373d; color: white; }}
    """,
    
    # === å¼¹çª—é€šç”¨æ ·å¼ ===
    'dialog': f"""
        QDialog {{ background-color: {COLORS['bg_dark']}; color: {COLORS['text']}; }}
        QLabel {{
            color: {COLORS['text_sub']};
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }}
        QLineEdit, QTextEdit, QComboBox {{
            background-color: {COLORS['bg_mid']};
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px;
            color: #eee;
            font-size: 13px;
            selection-background-color: {COLORS['primary']};
        }}
        QLineEdit:focus, QTextEdit:focus, QComboBox:focus {{
            border: 1px solid {COLORS['primary']};
            background-color: #2a2a2a;
        }}
        QComboBox {{ padding-right: 20px; }}
        QComboBox::drop-down {{
            subcontrol-origin: padding;
            subcontrol-position: top right;
            width: 20px;
            border-left-width: 0px;
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }}
        QComboBox::down-arrow {{
            width: 0; 
            height: 0; 
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 5px solid #888;
            margin-right: 6px;
        }}
        QComboBox QAbstractItemView {{
            border: 1px solid {COLORS['primary']};
            background-color: {COLORS['bg_mid']};
            color: #eee;
            selection-background-color: {COLORS['primary']};
            selection-color: white;
            outline: none;
            padding: 4px;
        }}
    """,
    
    'btn_primary': f"""
        QPushButton {{
            background-color: {COLORS['primary']};
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
        }}
        QPushButton:hover {{ background-color: #357abd; }}
        QPushButton:pressed {{ background-color: #2a5d8f; }}
    """,

    'btn_icon': f"""
        QPushButton {{
            background-color: {COLORS['bg_light']};
            border: 1px solid #444;
            border-radius: 4px;
            min-width: 32px;
            min-height: 32px;
        }}
        QPushButton:hover {{ background-color: {COLORS['primary']}; border-color: {COLORS['primary']}; }}
        QPushButton:pressed {{ background-color: #2a5d8f; }}
        QPushButton:disabled {{ background-color: #252526; color: #555; border-color: #333; }}
    """,
    
    'input': f"""
        QLineEdit {{
            background-color: {COLORS['bg_mid']};
            border: 1px solid {COLORS['bg_light']};
            border-radius: 16px;
            padding: 6px 12px;
            color: #eee;
            font-size: 13px;
        }}
        QLineEdit:focus {{ border: 1px solid {COLORS['primary']}; }}
        QLineEdit::clear-button {{
            background: transparent;
            border-radius: 9px;
            margin-right: 4px;
        }}
        QLineEdit::clear-button:hover {{
            background: #555;
        }}
    """,
    
    'card_base': "border-radius: 12px;"
}
```

## æ–‡ä»¶: db_manager.py

```python
# -*- coding: utf-8 -*-
# data/db_manager.py
import sqlite3
import hashlib
import os
import random
from core.config import DB_NAME, COLORS

class DatabaseManager:
    def __init__(self):
        self.conn = sqlite3.connect(DB_NAME)
        self._init_schema()

    def _init_schema(self):
        c = self.conn.cursor()
        
        c.execute(f'''CREATE TABLE IF NOT EXISTS ideas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL, content TEXT, color TEXT DEFAULT '{COLORS['default_note']}',
            is_pinned INTEGER DEFAULT 0, is_favorite INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            category_id INTEGER, is_deleted INTEGER DEFAULT 0
        )''')
        c.execute('CREATE TABLE IF NOT EXISTS tags (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT UNIQUE NOT NULL)')
        c.execute('''CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT, 
            name TEXT NOT NULL, 
            parent_id INTEGER, 
            color TEXT DEFAULT "#808080",
            sort_order INTEGER DEFAULT 0
        )''')
        c.execute('CREATE TABLE IF NOT EXISTS idea_tags (idea_id INTEGER, tag_id INTEGER, PRIMARY KEY (idea_id, tag_id))')
        
        c.execute("PRAGMA table_info(ideas)")
        cols = [i[1] for i in c.fetchall()]
        if 'category_id' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN category_id INTEGER')
            except: pass
        if 'is_deleted' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN is_deleted INTEGER DEFAULT 0')
            except: pass
        if 'item_type' not in cols:
            try: c.execute("ALTER TABLE ideas ADD COLUMN item_type TEXT DEFAULT 'text'")
            except: pass
        if 'data_blob' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN data_blob BLOB')
            except: pass
        if 'content_hash' not in cols:
            try:
                c.execute('ALTER TABLE ideas ADD COLUMN content_hash TEXT')
                c.execute('CREATE INDEX IF NOT EXISTS idx_content_hash ON ideas(content_hash)')
            except: pass
        
        c.execute("PRAGMA table_info(categories)")
        cat_cols = [i[1] for i in c.fetchall()]
        if 'sort_order' not in cat_cols:
            try: c.execute('ALTER TABLE categories ADD COLUMN sort_order INTEGER DEFAULT 0')
            except: pass
        if 'preset_tags' not in cat_cols:
            try: c.execute('ALTER TABLE categories ADD COLUMN preset_tags TEXT')
            except: pass
            
        self.conn.commit()

    def add_idea(self, title, content, color=None, tags=[], category_id=None, item_type='text', data_blob=None):
        if color is None:
            color = COLORS['default_note']
            
        c = self.conn.cursor()
        c.execute(
            'INSERT INTO ideas (title, content, color, category_id, item_type, data_blob) VALUES (?,?,?,?,?,?)',
            (title, content, color, category_id, item_type, data_blob)
        )
        iid = c.lastrowid
        self._update_tags(iid, tags)
        self.conn.commit()
        return iid

    def update_idea(self, iid, title, content, color, tags, category_id=None, item_type='text', data_blob=None):
        c = self.conn.cursor()
        c.execute(
            'UPDATE ideas SET title=?, content=?, color=?, category_id=?, item_type=?, data_blob=?, updated_at=CURRENT_TIMESTAMP WHERE id=?',
            (title, content, color, category_id, item_type, data_blob, iid)
        )
        self._update_tags(iid, tags)
        self.conn.commit()

    def _update_tags(self, iid, tags):
        c = self.conn.cursor()
        c.execute('DELETE FROM idea_tags WHERE idea_id=?', (iid,))
        if not tags: return
        for t in tags:
            t = t.strip()
            if t:
                c.execute('INSERT OR IGNORE INTO tags (name) VALUES (?)', (t,))
                c.execute('SELECT id FROM tags WHERE name=?', (t,))
                tid = c.fetchone()[0]
                c.execute('INSERT INTO idea_tags VALUES (?,?)', (iid, tid))

    def _append_tags(self, iid, tags):
        c = self.conn.cursor()
        for t in tags:
            t = t.strip()
            if t:
                c.execute('INSERT OR IGNORE INTO tags (name) VALUES (?)', (t,))
                c.execute('SELECT id FROM tags WHERE name=?', (t,))
                tid = c.fetchone()[0]
                c.execute('INSERT OR IGNORE INTO idea_tags VALUES (?,?)', (iid, tid))

    def add_tags_to_multiple_ideas(self, idea_ids, tags_list):
        if not idea_ids or not tags_list: return
        c = self.conn.cursor()
        for tag_name in tags_list:
            tag_name = tag_name.strip()
            if not tag_name: continue
            c.execute('INSERT OR IGNORE INTO tags (name) VALUES (?)', (tag_name,))
            c.execute('SELECT id FROM tags WHERE name=?', (tag_name,))
            tid = c.fetchone()[0]
            for iid in idea_ids:
                c.execute('INSERT OR IGNORE INTO idea_tags (idea_id, tag_id) VALUES (?,?)', (iid, tid))
        self.conn.commit()

    def remove_tag_from_multiple_ideas(self, idea_ids, tag_name):
        if not idea_ids or not tag_name: return
        c = self.conn.cursor()
        c.execute('SELECT id FROM tags WHERE name=?', (tag_name,))
        res = c.fetchone()
        if not res: return
        tid = res[0]
        placeholders = ','.join('?' * len(idea_ids))
        sql = f'DELETE FROM idea_tags WHERE tag_id=? AND idea_id IN ({placeholders})'
        c.execute(sql, (tid, *idea_ids))
        self.conn.commit()

    def get_union_tags(self, idea_ids):
        if not idea_ids: return []
        c = self.conn.cursor()
        placeholders = ','.join('?' * len(idea_ids))
        sql = f'''
            SELECT DISTINCT t.name 
            FROM tags t 
            JOIN idea_tags it ON t.id = it.tag_id 
            WHERE it.idea_id IN ({placeholders})
            ORDER BY t.name ASC
        '''
        c.execute(sql, tuple(idea_ids))
        return [r[0] for r in c.fetchall()]

    # ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¢åŠ  is_new è¿”å›å€¼
    def add_clipboard_item(self, item_type, content, data_blob=None, category_id=None):
        c = self.conn.cursor()
        hasher = hashlib.sha256()
        if item_type == 'text' or item_type == 'file':
            hasher.update(content.encode('utf-8'))
        elif item_type == 'image' and data_blob:
            hasher.update(data_blob)
        content_hash = hasher.hexdigest()

        c.execute("SELECT id FROM ideas WHERE content_hash = ?", (content_hash,))
        existing_idea = c.fetchone()

        if existing_idea:
            idea_id = existing_idea[0]
            c.execute("UPDATE ideas SET updated_at = CURRENT_TIMESTAMP WHERE id = ?", (idea_id,))
            self.conn.commit()
            # è¿”å› False è¡¨ç¤ºæ˜¯æ—§æ•°æ®
            return idea_id, False 
        else:
            if item_type == 'text':
                title = content.strip().split('\n')[0][:50]
            elif item_type == 'image':
                title = "[å›¾ç‰‡]"
            elif item_type == 'file':
                title = f"[æ–‡ä»¶] {os.path.basename(content.split(';')[0])}"
            else:
                title = "æœªå‘½å"

            default_color = COLORS['default_note']
            c.execute(
                'INSERT INTO ideas (title, content, item_type, data_blob, category_id, content_hash, color) VALUES (?,?,?,?,?,?,?)',
                (title, content, item_type, data_blob, category_id, content_hash, default_color)
            )
            idea_id = c.lastrowid
            
            self._update_tags(idea_id, ["å‰ªè´´æ¿"])
            self.conn.commit()
            # è¿”å› True è¡¨ç¤ºæ˜¯æ–°æ•°æ®
            return idea_id, True

    def toggle_field(self, iid, field):
        c = self.conn.cursor()
        c.execute(f'UPDATE ideas SET {field} = NOT {field} WHERE id=?', (iid,))
        self.conn.commit()

    def set_deleted(self, iid, state):
        c = self.conn.cursor()
        c.execute('UPDATE ideas SET is_deleted=?, updated_at=CURRENT_TIMESTAMP WHERE id=?', (1 if state else 0, iid))
        self.conn.commit()

    def set_favorite(self, iid, state):
        c = self.conn.cursor()
        c.execute('UPDATE ideas SET is_favorite=? WHERE id=?', (1 if state else 0, iid))
        self.conn.commit()

    def move_category(self, iid, cat_id):
        c = self.conn.cursor()
        c.execute('UPDATE ideas SET category_id=? WHERE id=?', (cat_id, iid))
        if cat_id is not None:
            c.execute('SELECT color, preset_tags FROM categories WHERE id=?', (cat_id,))
            result = c.fetchone()
            if result:
                cat_color = result[0]
                preset_tags_str = result[1]
                if cat_color:
                    c.execute('UPDATE ideas SET color=? WHERE id=?', (cat_color, iid))
                if preset_tags_str:
                    tags_list = [t.strip() for t in preset_tags_str.split(',') if t.strip()]
                    if tags_list:
                        self._append_tags(iid, tags_list)
        self.conn.commit()

    def delete_permanent(self, iid):
        c = self.conn.cursor()
        c.execute('DELETE FROM ideas WHERE id=?', (iid,))
        self.conn.commit()

    def get_idea(self, iid, include_blob=False):
        c = self.conn.cursor()
        if include_blob:
            c.execute('SELECT * FROM ideas WHERE id=?', (iid,))
        else:
            c.execute('SELECT id, title, content, color, is_pinned, is_favorite, created_at, updated_at, category_id, item_type FROM ideas WHERE id=?', (iid,))
        return c.fetchone()

    def get_ideas(self, search, f_type, f_val, page=None, page_size=20, tag_filter=None):
        c = self.conn.cursor()
        q = "SELECT DISTINCT i.* FROM ideas i LEFT JOIN idea_tags it ON i.id=it.idea_id LEFT JOIN tags t ON it.tag_id=t.id WHERE 1=1"
        p = []
        
        if f_type == 'trash': q += ' AND i.is_deleted=1'
        else: q += ' AND (i.is_deleted=0 OR i.is_deleted IS NULL)'
        
        if f_type == 'category':
            if f_val is None: q += ' AND i.category_id IS NULL'
            else: q += ' AND i.category_id=?'; p.append(f_val)
        elif f_type == 'today': q += " AND date(i.updated_at,'localtime')=date('now','localtime')"
        elif f_type == 'clipboard': q += " AND i.id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = 'å‰ªè´´æ¿'))"
        elif f_type == 'untagged': q += ' AND i.id NOT IN (SELECT idea_id FROM idea_tags)'
        elif f_type == 'favorite': q += ' AND i.is_favorite=1'
        
        if tag_filter:
            q += " AND i.id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = ?))"
            p.append(tag_filter)
        
        if search:
            q += ' AND (i.title LIKE ? OR i.content LIKE ? OR t.name LIKE ?)'
            p.extend([f'%{search}%']*3)
            
        if f_type == 'trash':
            q += ' ORDER BY i.updated_at DESC'
        else:
            q += ' ORDER BY i.is_pinned DESC, i.updated_at DESC'
            
        if page is not None and page_size is not None:
            limit = page_size
            offset = (page - 1) * page_size
            q += ' LIMIT ? OFFSET ?'
            p.extend([limit, offset])
            
        c.execute(q, p)
        return c.fetchall()

    def get_ideas_count(self, search, f_type, f_val, tag_filter=None):
        c = self.conn.cursor()
        q = "SELECT COUNT(DISTINCT i.id) FROM ideas i LEFT JOIN idea_tags it ON i.id=it.idea_id LEFT JOIN tags t ON it.tag_id=t.id WHERE 1=1"
        p = []
        
        if f_type == 'trash': q += ' AND i.is_deleted=1'
        else: q += ' AND (i.is_deleted=0 OR i.is_deleted IS NULL)'
        
        if f_type == 'category':
            if f_val is None: q += ' AND i.category_id IS NULL'
            else: q += ' AND i.category_id=?'; p.append(f_val)
        elif f_type == 'today': q += " AND date(i.updated_at,'localtime')=date('now','localtime')"
        elif f_type == 'clipboard': q += " AND i.id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = 'å‰ªè´´æ¿'))"
        elif f_type == 'untagged': q += ' AND i.id NOT IN (SELECT idea_id FROM idea_tags)'
        elif f_type == 'favorite': q += ' AND i.is_favorite=1'
        
        if tag_filter:
            q += " AND i.id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = ?))"
            p.append(tag_filter)
            
        if search:
            q += ' AND (i.title LIKE ? OR i.content LIKE ? OR t.name LIKE ?)'
            p.extend([f'%{search}%']*3)
            
        c.execute(q, p)
        return c.fetchone()[0]

    def get_tags(self, iid):
        c = self.conn.cursor()
        c.execute('SELECT t.name FROM tags t JOIN idea_tags it ON t.id=it.tag_id WHERE it.idea_id=?', (iid,))
        return [r[0] for r in c.fetchall()]

    def get_all_tags(self):
        c = self.conn.cursor()
        c.execute('SELECT name FROM tags ORDER BY name')
        return [r[0] for r in c.fetchall()]

    def get_categories(self):
        c = self.conn.cursor()
        c.execute('SELECT * FROM categories ORDER BY sort_order ASC, name ASC')
        return c.fetchall()

    def add_category(self, name, parent_id=None):
        c = self.conn.cursor()
        if parent_id is None:
            c.execute("SELECT MAX(sort_order) FROM categories WHERE parent_id IS NULL")
        else:
            c.execute("SELECT MAX(sort_order) FROM categories WHERE parent_id = ?", (parent_id,))
        max_order = c.fetchone()[0]
        new_order = (max_order or 0) + 1
        
        palette = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEEAD',
            '#D4A5A5', '#9B59B6', '#3498DB', '#E67E22', '#2ECC71',
            '#E74C3C', '#F1C40F', '#1ABC9C', '#34495E', '#95A5A6'
        ]
        chosen_color = random.choice(palette)
        
        c.execute(
            'INSERT INTO categories (name, parent_id, sort_order, color) VALUES (?, ?, ?, ?)', 
            (name, parent_id, new_order, chosen_color)
        )
        self.conn.commit()

    def rename_category(self, cat_id, new_name):
        c = self.conn.cursor()
        c.execute('UPDATE categories SET name=? WHERE id=?', (new_name, cat_id))
        self.conn.commit()
    
    def set_category_color(self, cat_id, color):
        c = self.conn.cursor()
        c.execute('UPDATE categories SET color=? WHERE id=?', (color, cat_id))
        self.conn.commit()

    def set_category_preset_tags(self, cat_id, tags_str):
        c = self.conn.cursor()
        c.execute('UPDATE categories SET preset_tags=? WHERE id=?', (tags_str, cat_id))
        self.conn.commit()

    def get_category_preset_tags(self, cat_id):
        c = self.conn.cursor()
        c.execute('SELECT preset_tags FROM categories WHERE id=?', (cat_id,))
        res = c.fetchone()
        return res[0] if res else ""

    def apply_preset_tags_to_category_items(self, cat_id, tags_list):
        if not tags_list: return
        c = self.conn.cursor()
        c.execute('SELECT id FROM ideas WHERE category_id=? AND is_deleted=0', (cat_id,))
        items = c.fetchall()
        for (iid,) in items:
            self._append_tags(iid, tags_list)
        self.conn.commit()

    def delete_category(self, cid):
        c = self.conn.cursor()
        c.execute('UPDATE ideas SET category_id=NULL WHERE category_id=?', (cid,))
        c.execute('DELETE FROM categories WHERE id=?', (cid,))
        self.conn.commit()

    def get_counts(self):
        c = self.conn.cursor()
        d = {}
        queries = {
            'all': "is_deleted=0 OR is_deleted IS NULL",
            'today': "(is_deleted=0 OR is_deleted IS NULL) AND date(updated_at,'localtime')=date('now','localtime')",
            'clipboard': "(is_deleted=0 OR is_deleted IS NULL) AND id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = 'å‰ªè´´æ¿'))",
            'uncategorized': "(is_deleted=0 OR is_deleted IS NULL) AND category_id IS NULL",
            'untagged': "(is_deleted=0 OR is_deleted IS NULL) AND id NOT IN (SELECT idea_id FROM idea_tags)",
            'favorite': "(is_deleted=0 OR is_deleted IS NULL) AND is_favorite=1",
            'trash': "is_deleted=1"
        }
        for k, v in queries.items():
            c.execute(f"SELECT COUNT(*) FROM ideas WHERE {v}")
            d[k] = c.fetchone()[0]
            
        c.execute("SELECT category_id, COUNT(*) FROM ideas WHERE (is_deleted=0 OR is_deleted IS NULL) GROUP BY category_id")
        d['categories'] = dict(c.fetchall())
        return d

    def get_top_tags(self):
        c = self.conn.cursor()
        c.execute('''SELECT t.name, COUNT(it.idea_id) as c FROM tags t 
                     JOIN idea_tags it ON t.id=it.tag_id JOIN ideas i ON it.idea_id=i.id 
                     WHERE i.is_deleted=0 GROUP BY t.id ORDER BY c DESC LIMIT 5''')
        return c.fetchall()

    def get_partitions_tree(self):
        class Partition:
            def __init__(self, id, name, color, parent_id, sort_order):
                self.id = id
                self.name = name
                self.color = color
                self.parent_id = parent_id
                self.sort_order = sort_order
                self.children = []

        c = self.conn.cursor()
        c.execute("SELECT id, name, color, parent_id, sort_order FROM categories ORDER BY sort_order ASC, name ASC")
        
        nodes = {row[0]: Partition(*row) for row in c.fetchall()}
        
        tree = []
        for node_id, node in nodes.items():
            if node.parent_id in nodes:
                nodes[node.parent_id].children.append(node)
            else:
                tree.append(node)
                
        return tree

    def get_partition_item_counts(self):
        c = self.conn.cursor()
        counts = {'partitions': {}}

        c.execute("SELECT COUNT(*) FROM ideas WHERE is_deleted=0")
        counts['total'] = c.fetchone()[0]

        c.execute("SELECT COUNT(*) FROM ideas WHERE is_deleted=0 AND date(updated_at, 'localtime') = date('now', 'localtime')")
        counts['today_modified'] = c.fetchone()[0]
        
        c.execute("SELECT category_id, COUNT(*) FROM ideas WHERE is_deleted=0 GROUP BY category_id")
        for cat_id, count in c.fetchall():
            if cat_id is not None:
                counts['partitions'][cat_id] = count

        # Add missing counts
        c.execute("SELECT COUNT(*) FROM ideas i JOIN idea_tags it ON i.id = it.idea_id JOIN tags t ON it.tag_id = t.id WHERE t.name = 'å‰ªè´´æ¿' AND i.is_deleted=0")
        counts['clipboard'] = c.fetchone()[0]

        c.execute("SELECT COUNT(*) FROM ideas WHERE is_favorite=1 AND is_deleted=0")
        counts['favorite'] = c.fetchone()[0]

        return counts
    
    def save_category_order(self, update_list):
        c = self.conn.cursor()
        try:
            c.execute("BEGIN TRANSACTION")
            for item in update_list:
                c.execute(
                    "UPDATE categories SET sort_order = ?, parent_id = ? WHERE id = ?",
                    (item['sort_order'], item['parent_id'], item['id'])
                )
            c.execute("COMMIT")
        except Exception as e:
            c.execute("ROLLBACK")
            pass
        finally:
            self.conn.commit()

    def rename_tag(self, old_name, new_name):
        new_name = new_name.strip()
        if not new_name or old_name == new_name: return
        c = self.conn.cursor()
        c.execute("SELECT id FROM tags WHERE name=?", (old_name,))
        old_res = c.fetchone()
        if not old_res: return
        old_id = old_res[0]
        c.execute("SELECT id FROM tags WHERE name=?", (new_name,))
        new_res = c.fetchone()
        try:
            if new_res:
                new_id = new_res[0]
                c.execute("UPDATE OR IGNORE idea_tags SET tag_id=? WHERE tag_id=?", (new_id, old_id))
                c.execute("DELETE FROM idea_tags WHERE tag_id=?", (old_id,))
                c.execute("DELETE FROM tags WHERE id=?", (old_id,))
            else:
                c.execute("UPDATE tags SET name=? WHERE id=?", (new_name, old_id))
            self.conn.commit()
        except Exception as e:
            self.conn.rollback()

    def delete_tag(self, tag_name):
        c = self.conn.cursor()
        c.execute("SELECT id FROM tags WHERE name=?", (tag_name,))
        res = c.fetchone()
        if res:
            tag_id = res[0]
            c.execute("DELETE FROM idea_tags WHERE tag_id=?", (tag_id,))
            c.execute("DELETE FROM tags WHERE id=?", (tag_id,))
            self.conn.commit()
```

## æ–‡ä»¶: dialogs.py

```python
# ui/dialogs.py
import sys
from PyQt5.QtWidgets import QCompleter
from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QGridLayout, QHBoxLayout,
                              QLabel, QLineEdit, QTextEdit, QComboBox, QPushButton,
                              QProgressBar, QFrame, QApplication, QMessageBox, QShortcut,
                             QSpacerItem, QSizePolicy, QSplitter, QWidget, QScrollBar,
                             QGraphicsDropShadowEffect, QCheckBox)
from PyQt5.QtGui import QKeySequence, QColor, QCursor, QTextDocument, QTextCursor, QTextListFormat, QTextCharFormat
from PyQt5.QtCore import Qt, QPoint, QRect, QEvent, pyqtSignal
from core.config import STYLES, COLORS
from core.settings import save_setting, load_setting
from .components.rich_text_edit import RichTextEdit

# è‡ªå®šä¹‰æ·±ç°è‰²æ»šåŠ¨æ¡æ ·å¼
SCROLLBAR_STYLE = """
QScrollBar:vertical {
    border: none;
    background: #222222;
    width: 10px;
    margin: 0px 0px 0px 0px;
}
QScrollBar::handle:vertical {
    background: #555555;
    min-height: 20px;
    border-radius: 5px;
}
QScrollBar::handle:vertical:hover {
    background: #666666;
}
QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
    height: 0px;
}
QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {
    background: none;
}
QScrollBar:horizontal {
    border: none;
    background: #222222;
    height: 10px;
    margin: 0px 0px 0px 0px;
}
QScrollBar::handle:horizontal {
    background: #555555;
    min-width: 20px;
    border-radius: 5px;
}
QScrollBar::handle:horizontal:hover {
    background: #666666;
}
QScrollBar::add-line:horizontal, QScrollBar::sub-line:horizontal {
    width: 0px;
}
QScrollBar::add-page:horizontal, QScrollBar::sub-page:horizontal {
    background: none;
}
"""

class BaseDialog(QDialog):
    def __init__(self, parent=None, window_title="å¿«é€Ÿç¬”è®°"):
        super().__init__(parent)
        # ã€å…³é”®ä¿®å¤ã€‘æ”¹ä¸ºéæ¨¡æ€çª—å£ï¼Œå…è®¸ä¸å…¶ä»–çª—å£å¹¶å­˜
        self.setWindowFlags(Qt.Window | Qt.FramelessWindowHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        # ã€æ–°å¢ã€‘è®¾ç½®çª—å£æ ‡é¢˜ï¼ˆå½±å“ä»»åŠ¡æ æ˜¾ç¤ºï¼‰
        self.setWindowTitle(window_title)
        
        self._setup_container()
    
    def _setup_container(self):
        """è®¾ç½®å¸¦é˜´å½±çš„ä¸»å®¹å™¨"""
        self.outer_layout = QVBoxLayout(self)
        self.outer_layout.setContentsMargins(15, 15, 15, 15)
        
        self.content_container = QWidget()
        self.content_container.setObjectName("DialogContainer")
        self.content_container.setStyleSheet(f"""
            #DialogContainer {{
                background-color: {COLORS['bg_dark']};
                border-radius: 12px;
            }}
        """ + STYLES['dialog'] + SCROLLBAR_STYLE)
        
        self.outer_layout.addWidget(self.content_container)
        
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(30)
        shadow.setXOffset(0)
        shadow.setYOffset(6)
        shadow.setColor(QColor(0, 0, 0, 120))
        self.content_container.setGraphicsEffect(shadow)
        
        return self.content_container

class EditDialog(BaseDialog):
    RESIZE_MARGIN = 10
    data_saved = pyqtSignal()

    def __init__(self, db, idea_id=None, parent=None, category_id_for_new=None):
        # ã€ä¿®å¤ã€‘æ ¹æ®æ˜¯ç¼–è¾‘è¿˜æ˜¯æ–°å»ºè®¾ç½®ä¸åŒçš„æ ‡é¢˜
        window_title = "ç¼–è¾‘ç¬”è®°" if idea_id else "æ–°å»ºç¬”è®°"
        super().__init__(parent, window_title=window_title)
        self.db = db
        self.idea_id = idea_id
        
        # ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½é»˜è®¤é¢œè‰²é€»è¾‘
        saved_default = load_setting('user_default_color')
        if saved_default:
            # ç”¨æˆ·å·²è®¾ç½®é»˜è®¤é¢œè‰²
            self.selected_color = saved_default
            self.is_using_saved_default = True
        else:
            # æœªè®¾ç½®ï¼Œä½¿ç”¨æ©™è‰²
            self.selected_color = COLORS['orange']
            self.is_using_saved_default = False
        
        self.category_id = None 
        self.category_id_for_new = category_id_for_new 
        
        self._resize_area = None
        self._drag_pos = None
        self._resize_start_pos = None
        self._resize_start_geometry = None
        
        self.setMouseTracking(True)
        
        self._init_ui()
        if idea_id: 
            self._load_data()
        elif category_id_for_new:
             idx = self.category_combo.findData(category_id_for_new)
             if idx >= 0: self.category_combo.setCurrentIndex(idx)
            
        # å®‰è£…äº‹ä»¶è¿‡æ»¤å™¨ä»¥æ”¯æŒé”®ç›˜å¯¼èˆª
        self.title_inp.installEventFilter(self)
        self.tags_inp.installEventFilter(self)

    def eventFilter(self, obj, event):
        if event.type() == QEvent.KeyPress:
            if event.key() == Qt.Key_Down:
                if obj == self.title_inp:
                    self.tags_inp.setFocus()
                    return True
                elif obj == self.tags_inp:
                    self.content_inp.setFocus()
                    return True
            elif event.key() == Qt.Key_Up:
                if obj == self.tags_inp:
                    self.title_inp.setFocus()
                    return True
        return super().eventFilter(obj, event)
        
    def _init_ui(self):
        self.resize(950, 650)
        
        main_layout = QVBoxLayout(self.content_container)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.setSpacing(0)
        
        # 1. è‡ªå®šä¹‰æ ‡é¢˜æ 
        self.title_bar = QWidget()
        self.title_bar.setFixedHeight(40)
        self.title_bar.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_mid']};
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
                border-bottom: 1px solid {COLORS['bg_light']};
            }}
        """)
        tb_layout = QHBoxLayout(self.title_bar)
        tb_layout.setContentsMargins(15, 0, 10, 0)
        
        self.win_title = QLabel('âœ¨ è®°å½•çµæ„Ÿ' if not self.idea_id else 'âœï¸ ç¼–è¾‘ç¬”è®°')
        self.win_title.setStyleSheet("font-weight: bold; color: #ddd; font-size: 13px; border: none; background: transparent;")
        tb_layout.addWidget(self.win_title)
        
        tb_layout.addStretch()
        
        ctrl_btn_style = """
            QPushButton { background: transparent; border: none; color: #aaa; border-radius: 4px; font-size: 14px; width: 30px; height: 30px; }
            QPushButton:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }
        """
        close_btn_style = """
            QPushButton { background: transparent; border: none; color: #aaa; border-radius: 4px; font-size: 16px; width: 30px; height: 30px; }
            QPushButton:hover { background-color: #e74c3c; color: white; }
        """
        
        btn_min = QPushButton("â”€")
        btn_min.setStyleSheet(ctrl_btn_style)
        btn_min.clicked.connect(self.showMinimized)
        
        self.btn_max = QPushButton("â–¡")
        self.btn_max.setStyleSheet(ctrl_btn_style)
        self.btn_max.clicked.connect(self._toggle_maximize)
        
        btn_close = QPushButton("Ã—")
        btn_close.setStyleSheet(close_btn_style)
        btn_close.clicked.connect(self.close)  # ã€ä¿®å¤ã€‘æ”¹ä¸º close() è€Œé reject()
        
        tb_layout.addWidget(btn_min)
        tb_layout.addWidget(self.btn_max)
        tb_layout.addWidget(btn_close)
        
        main_layout.addWidget(self.title_bar)
        
        # 2. å†…å®¹åŒºåŸŸ
        content_widget = QWidget()
        content_layout = QHBoxLayout(content_widget)
        content_layout.setContentsMargins(10, 10, 10, 10)
        
        self.splitter = QSplitter(Qt.Horizontal)
        self.splitter.setStyleSheet(f"""
            QSplitter::handle {{
                background-color: {COLORS['bg_mid']};
                width: 2px;
                margin: 0 5px;
            }}
            QSplitter::handle:hover {{
                background-color: {COLORS['primary']};
            }}
        """)
        
        # å·¦ä¾§å®¹å™¨
        left_container = QWidget()
        left_panel = QVBoxLayout(left_container)
        left_panel.setContentsMargins(5, 5, 5, 5)
        left_panel.setSpacing(12)
        
        # --- åˆ†åŒºé€‰æ‹© ---
        left_panel.addWidget(QLabel('ğŸ“‚ åˆ†åŒº'))
        self.category_combo = QComboBox()
        self.category_combo.setFixedHeight(40)
        self.category_combo.setStyleSheet(STYLES['combo_box'] if 'combo_box' in STYLES else f"""
            QComboBox {{
                background-color: {COLORS['bg_mid']};
                border: 1px solid {COLORS['bg_light']};
                border-radius: 6px;
                padding: 5px;
                color: #ddd;
            }}
            QComboBox::drop-down {{ border: none; }}
            QComboBox QAbstractItemView {{
                background-color: {COLORS['bg_dark']};
                selection-background-color: {COLORS['primary']};
            }}
        """)
        
        # åŠ è½½åˆ†åŒºæ•°æ®
        self.category_combo.addItem("ğŸš« æœªåˆ†ç±»", None)
        cats = self.db.get_categories()
        for c in cats:
            # c: (id, name, parent_id, color, sort_order, ...)
            self.category_combo.addItem(f"ğŸ“ {c[1]}", c[0])
            
        left_panel.addWidget(self.category_combo)

        # --- æ ‡é¢˜è¾“å…¥ ---
        left_panel.addWidget(QLabel('ğŸ“Œ æ ‡é¢˜'))
        self.title_inp = QLineEdit()
        self.title_inp.setPlaceholderText("è¯·è¾“å…¥çµæ„Ÿæ ‡é¢˜...")
        self.title_inp.setFixedHeight(40)
        left_panel.addWidget(self.title_inp)
        
        # --- æ ‡ç­¾è¾“å…¥ (å¸¦æ™ºèƒ½è¡¥å…¨) ---
        left_panel.addWidget(QLabel('ğŸ·ï¸ æ ‡ç­¾ (æ™ºèƒ½è¡¥å…¨)'))
        self.tags_inp = QLineEdit()
        self.tags_inp.setPlaceholderText("ä½¿ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: å·¥ä½œ, å¾…åŠ")
        self.tags_inp.setFixedHeight(40)
        
        # åˆå§‹åŒ–è¡¥å…¨å™¨
        self._init_completer()
        
        left_panel.addWidget(self.tags_inp)
        
        left_panel.addSpacing(10)
        left_panel.addWidget(QLabel('ğŸ¨ æ ‡è®°é¢œè‰²'))
        color_layout = QGridLayout()
        color_layout.setSpacing(10)
        
        self.color_btns = []
        colors = [
            COLORS['orange'],
            COLORS['default_note'],
            COLORS['primary'],
            COLORS['success'],
            COLORS['danger'],
            COLORS['info']
        ]
                  
        for i, c in enumerate(colors):
            btn = QPushButton()
            btn.setFixedSize(34, 34)
            btn.setCursor(Qt.PointingHandCursor)
            btn.setStyleSheet(f"QPushButton {{ background-color: {c}; border-radius: 17px; border: 2px solid transparent; }}")
            btn.clicked.connect(lambda _, x=c: self._set_color(x))
            self.color_btns.append(btn)
            color_layout.addWidget(btn, i // 3, i % 3)
            
        left_panel.addLayout(color_layout)
        
        # ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½é»˜è®¤é¢œè‰²å¤é€‰æ¡†
        self.chk_set_default = QCheckBox("è®¾ä¸ºé»˜è®¤é¢œè‰²")
        self.chk_set_default.setStyleSheet(f"""
            QCheckBox {{ color: {COLORS['text_sub']}; font-size: 12px; margin-top: 5px; }}
            QCheckBox::indicator {{ width: 14px; height: 14px; border: 1px solid #555; border-radius: 3px; background: transparent; }}
            QCheckBox::indicator:checked {{ background-color: {COLORS['primary']}; border-color: {COLORS['primary']}; }}
        """)
        # ã€æ–°å¢ã€‘å¦‚æœå½“å‰é¢œè‰²æ˜¯å·²ä¿å­˜çš„é»˜è®¤é¢œè‰²ï¼Œè‡ªåŠ¨å‹¾é€‰
        if self.is_using_saved_default:
            self.chk_set_default.setChecked(True)
        
        left_panel.addWidget(self.chk_set_default)
        
        left_panel.addStretch()
        
        self.save_btn = QPushButton('ğŸ’¾ ä¿å­˜ (Ctrl+S)')
        self.save_btn.setCursor(Qt.PointingHandCursor)
        self.save_btn.setFixedHeight(50)
        self.save_btn.setStyleSheet(STYLES['btn_primary'])
        self.save_btn.clicked.connect(self._save_data)
        left_panel.addWidget(self.save_btn)
        
        # å³ä¾§å®¹å™¨
        right_container = QWidget()
        right_panel = QVBoxLayout(right_container)
        right_panel.setContentsMargins(5, 5, 5, 5)
        right_panel.setSpacing(10)
        
        # å·¥å…·æ  (æ ‡é¢˜ + åŠŸèƒ½æŒ‰é’®)
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel('ğŸ“ è¯¦ç»†å†…å®¹'))
        
        # --- åŸºæœ¬ç¼–è¾‘æŒ‰é’® ---
        btn_style = """
            QPushButton { background: transparent; border: 1px solid #444; border-radius: 4px; color: #ccc; margin-left: 2px; }
            QPushButton:hover { background-color: #444; color: white; }
        """
        
        def _create_tool_btn(text, tooltip, callback):
            btn = QPushButton(text)
            btn.setFixedSize(24, 24)
            btn.setToolTip(tooltip)
            btn.setStyleSheet(btn_style)
            btn.setCursor(Qt.PointingHandCursor)
            btn.clicked.connect(callback)
            header_layout.addWidget(btn)
            return btn

        header_layout.addSpacing(10)
        _create_tool_btn("â†©", "æ’¤é”€ (Ctrl+Z)", lambda: self.content_inp.undo())
        _create_tool_btn("â†ª", "é‡åš (Ctrl+Y)", lambda: self.content_inp.redo())
        header_layout.addSpacing(5)
        _create_tool_btn("â€¢", "æ— åºåˆ—è¡¨", lambda: self.content_inp.toggle_list(QTextListFormat.ListDisc))
        _create_tool_btn("1.", "æœ‰åºåˆ—è¡¨", lambda: self.content_inp.toggle_list(QTextListFormat.ListDecimal))
        _create_tool_btn("ğŸ§¹", "æ¸…é™¤æ ¼å¼", lambda: self.content_inp.setCurrentCharFormat(QTextCharFormat()))

        header_layout.addStretch()
        
        # é«˜äº®æŒ‰é’®ç»„
        highlight_colors = [
            ('#c0392b', 'ğŸ”´'), # çº¢
            ('#d35400', 'ğŸŸ '), # æ©™
            ('#f1c40f', 'ğŸŸ¡'), # é»„ (æ³¨æ„: æš—è‰²ä¸‹å¯èƒ½éœ€è¦æ·±ä¸€ç‚¹ï¼Œè¿™é‡Œç”¨é‡‘é»„è‰²)
            ('#27ae60', 'ğŸŸ¢'), # ç»¿
            ('#2980b9', 'ğŸ”µ'), # è“
            ('#8e44ad', 'ğŸŸ£'), # ç´«
            (None, 'ğŸš«')      # æ¸…é™¤
        ]
        
        for color, icon in highlight_colors:
            btn = QPushButton(icon)
            btn.setFixedSize(24, 24)
            btn.setCursor(Qt.PointingHandCursor)
            btn.setToolTip("æ¸…é™¤é«˜äº®" if color is None else "é«˜äº®æ–‡å­—")
            # æŒ‰é’®æ ·å¼
            btn.setStyleSheet(f"""
                QPushButton {{ 
                    background-color: transparent; 
                    border: 1px solid #444; 
                    border-radius: 4px; 
                    margin-left: 2px;
                }}
                QPushButton:hover {{ background-color: #444; }}
            """)
            btn.clicked.connect(lambda _, c=color: self.content_inp.highlight_selection(c))
            header_layout.addWidget(btn)
            
        right_panel.addLayout(header_layout)

        # æœç´¢æ  (é»˜è®¤éšè—)
        self.search_bar = QWidget()
        self.search_bar.setVisible(False)
        self.search_bar.setStyleSheet(f"background-color: {COLORS['bg_mid']}; border-radius: 6px; padding: 2px;")
        sb_layout = QHBoxLayout(self.search_bar)
        sb_layout.setContentsMargins(5, 2, 5, 2)
        sb_layout.setSpacing(5)
        
        self.search_inp = QLineEdit()
        self.search_inp.setPlaceholderText("æŸ¥æ‰¾å†…å®¹...")
        self.search_inp.setStyleSheet("border: none; background: transparent; color: #fff;")
        self.search_inp.returnPressed.connect(self._find_next)
        
        btn_prev = QPushButton("â¬†")
        btn_prev.setFixedSize(24, 24)
        btn_prev.clicked.connect(self._find_prev)
        btn_prev.setStyleSheet("background: transparent; border: none; color: #ccc;")
        
        btn_next = QPushButton("â¬‡")
        btn_next.setFixedSize(24, 24)
        btn_next.clicked.connect(self._find_next)
        btn_next.setStyleSheet("background: transparent; border: none; color: #ccc;")
        
        btn_cls = QPushButton("Ã—")
        btn_cls.setFixedSize(24, 24)
        btn_cls.clicked.connect(lambda: self.search_bar.hide())
        btn_cls.setStyleSheet("background: transparent; border: none; color: #ccc;")
        
        sb_layout.addWidget(QLabel("ğŸ”"))
        sb_layout.addWidget(self.search_inp)
        sb_layout.addWidget(btn_prev)
        sb_layout.addWidget(btn_next)
        sb_layout.addWidget(btn_cls)
        
        right_panel.addWidget(self.search_bar)

        self.content_inp = RichTextEdit()
        self.content_inp.setPlaceholderText("åœ¨è¿™é‡Œè®°å½•è¯¦ç»†å†…å®¹ï¼ˆæ”¯æŒç²˜è´´å›¾ç‰‡ï¼‰...")
        self.content_inp.setStyleSheet("""
            QTextEdit {
                background-color: #2a2a2a;
                border: 1px solid #444;
                border-radius: 8px;
                padding: 10px;
                font-size: 14px;
                color: #eee;
                selection-background-color: #4a90e2; 
            }
        """)
        
        # ç»‘å®š Ctrl+F
        shortcut_search = QShortcut(QKeySequence("Ctrl+F"), self.content_inp)
        shortcut_search.activated.connect(self._toggle_search_bar)
        
        right_panel.addWidget(self.content_inp)
        
        self.splitter.addWidget(left_container)
        self.splitter.addWidget(right_container)
        self.splitter.setSizes([300, 650])
        self.splitter.setStretchFactor(0, 0)
        self.splitter.setStretchFactor(1, 1)
        
        content_layout.addWidget(self.splitter)
        main_layout.addWidget(content_widget)
        
        QShortcut(QKeySequence("Ctrl+S"), self, self._save_data)
        QShortcut(QKeySequence("Escape"), self, self.close)
        QShortcut(QKeySequence("Ctrl+W"), self, self.close)
        
        self._set_color(self.selected_color)

    def _get_resize_area(self, pos):
        x, y = pos.x(), pos.y()
        w, h = self.width(), self.height()
        m = self.RESIZE_MARGIN
        
        areas = []
        if x < m: areas.append('left')
        elif x > w - m: areas.append('right')
        if y < m: areas.append('top')
        elif y > h - m: areas.append('bottom')
        return areas

    def _set_cursor_for_resize(self, areas):
        if not areas:
            self.setCursor(Qt.ArrowCursor)
            return
        
        if 'left' in areas and 'top' in areas: self.setCursor(Qt.SizeFDiagCursor)
        elif 'right' in areas and 'bottom' in areas: self.setCursor(Qt.SizeFDiagCursor)
        elif 'left' in areas and 'bottom' in areas: self.setCursor(Qt.SizeBDiagCursor)
        elif 'right' in areas and 'top' in areas: self.setCursor(Qt.SizeBDiagCursor)
        elif 'left' in areas or 'right' in areas: self.setCursor(Qt.SizeHorCursor)
        elif 'top' in areas or 'bottom' in areas: self.setCursor(Qt.SizeVerCursor)

    def mousePressEvent(self, e):
        if e.button() == Qt.LeftButton:
            areas = self._get_resize_area(e.pos())
            if areas:
                self._resize_area = areas
                self._resize_start_pos = e.globalPos()
                self._resize_start_geometry = self.geometry()
                self._drag_pos = None
            elif e.pos().y() < 60: 
                self._drag_pos = e.globalPos() - self.frameGeometry().topLeft()
                self._resize_area = None
            e.accept()

    def mouseMoveEvent(self, e):
        if e.buttons() == Qt.NoButton:
            areas = self._get_resize_area(e.pos())
            self._set_cursor_for_resize(areas)
            return

        if e.buttons() == Qt.LeftButton:
            if self._resize_area:
                delta = e.globalPos() - self._resize_start_pos
                rect = self._resize_start_geometry
                min_w, min_h = 600, 400
                new_rect = rect.adjusted(0,0,0,0)
                
                if 'left' in self._resize_area:
                    if rect.right() - (rect.left() + delta.x()) >= min_w:
                        new_rect.setLeft(rect.left() + delta.x())
                if 'right' in self._resize_area:
                    if (rect.width() + delta.x()) >= min_w:
                        new_rect.setWidth(rect.width() + delta.x())
                if 'top' in self._resize_area:
                    if rect.bottom() - (rect.top() + delta.y()) >= min_h:
                        new_rect.setTop(rect.top() + delta.y())
                if 'bottom' in self._resize_area:
                    if (rect.height() + delta.y()) >= min_h:
                        new_rect.setHeight(rect.height() + delta.y())
                
                self.setGeometry(new_rect)
            elif self._drag_pos:
                self.move(e.globalPos() - self._drag_pos)
            e.accept()

    def mouseReleaseEvent(self, e):
        self._drag_pos = None
        self._resize_area = None
        self.setCursor(Qt.ArrowCursor)

    def mouseDoubleClickEvent(self, e):
        if e.pos().y() < 60:
            self._toggle_maximize()

    def _toggle_maximize(self):
        if self.isMaximized():
            self.showNormal()
            self.btn_max.setText('â–¡')
            self.outer_layout.setContentsMargins(15, 15, 15, 15)
            
            # æ¢å¤åœ†è§’æ ·å¼
            self.content_container.setStyleSheet(f"""
                #DialogContainer {{
                    background-color: {COLORS['bg_dark']};
                    border-radius: 12px;
                }}
            """ + STYLES['dialog'] + SCROLLBAR_STYLE)
            
            self.title_bar.setStyleSheet(f"""
                QWidget {{
                    background-color: {COLORS['bg_mid']};
                    border-top-left-radius: 12px;
                    border-top-right-radius: 12px;
                    border-bottom: 1px solid {COLORS['bg_light']};
                }}
            """)
        else:
            self.showMaximized()
            self.btn_max.setText('â')
            self.outer_layout.setContentsMargins(0, 0, 0, 0)
            
            # å»é™¤åœ†è§’æ ·å¼ï¼ˆç›´è§’ï¼‰
            self.content_container.setStyleSheet(f"""
                #DialogContainer {{
                    background-color: {COLORS['bg_dark']};
                    border-radius: 0px;
                }}
            """ + STYLES['dialog'] + SCROLLBAR_STYLE)
            
            self.title_bar.setStyleSheet(f"""
                QWidget {{
                    background-color: {COLORS['bg_mid']};
                    border-radius: 0px;
                    border-bottom: 1px solid {COLORS['bg_light']};
                }}
            """)

    def _set_color(self, color):
        self.selected_color = color
        
        # ã€æ–°å¢ã€‘æ™ºèƒ½æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
        saved_default = load_setting('user_default_color')
        if saved_default == color:
            self.chk_set_default.setChecked(True)
        else:
            self.chk_set_default.setChecked(False)
        
        for btn in self.color_btns:
            style = btn.styleSheet()
            if color in style:
                new_style = f"background-color: {color}; border-radius: 17px; border: 3px solid white;"
            else:
                bg = style.split('background-color:')[1].split(';')[0].strip()
                new_style = f"background-color: {bg}; border-radius: 17px; border: 2px solid transparent;"
            btn.setStyleSheet(f"QPushButton {{ {new_style} }}")

    # --- æ™ºèƒ½æ ‡ç­¾è¡¥å…¨é€»è¾‘ ---
    def _init_completer(self):
        all_tags = self.db.get_all_tags()
        self.completer = QCompleter(all_tags, self)
        self.completer.setCaseSensitivity(Qt.CaseInsensitive)
        self.completer.setFilterMode(Qt.MatchContains)
        
        self.completer.setWidget(self.tags_inp)
        self.completer.activated.connect(self._on_completion_activated)
        self.tags_inp.textEdited.connect(self._update_completion_prefix)

    def _update_completion_prefix(self, text):
        cursor_pos = self.tags_inp.cursorPosition()
        text_before = text[:cursor_pos]
        
        # æ‰¾åˆ°å½“å‰æ­£åœ¨è¾“å…¥çš„æ ‡ç­¾ç‰‡æ®µï¼ˆæœ€åä¸€ä¸ªé€—å·åï¼‰
        last_comma = text_before.rfind(',')
        if last_comma != -1:
            prefix = text_before[last_comma+1:].strip()
        else:
            prefix = text_before.strip()
            
        if prefix:
            self.completer.setCompletionPrefix(prefix)
            if self.completer.completionCount() > 0:
                # å¼¹å‡ºå»ºè®®åˆ—è¡¨
                cr = self.tags_inp.cursorRect()
                cr.setWidth(self.completer.popup().sizeHintForColumn(0) + self.completer.popup().verticalScrollBar().sizeHint().width())
                self.completer.complete(cr)
            else:
                self.completer.popup().hide()
        else:
            self.completer.popup().hide()

    def _on_completion_activated(self, text):
        # æ›¿æ¢å½“å‰è¾“å…¥çš„ç‰‡æ®µä¸ºå®Œæ•´æ ‡ç­¾
        current_text = self.tags_inp.text()
        cursor_pos = self.tags_inp.cursorPosition()
        
        text_before = current_text[:cursor_pos]
        last_comma = text_before.rfind(',')
        
        start_replace = last_comma + 1 if last_comma != -1 else 0
        
        prefix = current_text[:start_replace]
        # ä¿ç•™å…‰æ ‡åçš„å†…å®¹(å¦‚æœæœ‰)
        suffix = current_text[cursor_pos:]
        
        new_text = prefix + text + ", " + suffix
        self.tags_inp.setText(new_text)
        # ç§»åŠ¨å…‰æ ‡åˆ°æ–°æ ‡ç­¾å
        self.tags_inp.setCursorPosition(len(prefix) + len(text) + 2)

    # --- æœç´¢åŠŸèƒ½ ---
    def _toggle_search_bar(self):
        self.search_bar.setVisible(not self.search_bar.isVisible())
        if self.search_bar.isVisible():
            self.search_inp.setFocus()
            sel = self.content_inp.textCursor().selectedText()
            if sel: self.search_inp.setText(sel)
        else:
            self.content_inp.setFocus()

    def _find_next(self):
        text = self.search_inp.text()
        if not text: return
        
        found = self.content_inp.find(text)
        if not found:
            # å¾ªç¯æŸ¥æ‰¾: ç§»åˆ°å¼€å¤´å†æŸ¥ä¸€æ¬¡
            curr = self.content_inp.textCursor()
            self.content_inp.moveCursor(QTextCursor.Start)
            if not self.content_inp.find(text):
                # ç¡®å®æ²¡æ‰¾åˆ°ï¼Œæ¢å¤å…‰æ ‡
                self.content_inp.setTextCursor(curr)

    def _find_prev(self):
        text = self.search_inp.text()
        if not text: return
        
        found = self.content_inp.find(text, QTextDocument.FindBackward)
        if not found:
            # å¾ªç¯æŸ¥æ‰¾: ç§»åˆ°ç»“å°¾å†æŸ¥ä¸€æ¬¡
            curr = self.content_inp.textCursor()
            self.content_inp.moveCursor(QTextCursor.End)
            if not self.content_inp.find(text, QTextDocument.FindBackward):
                self.content_inp.setTextCursor(curr)

    def _load_data(self):
        d = self.db.get_idea(self.idea_id, include_blob=True)
        if d:
            self.title_inp.setText(d[1])
            # ç´¢å¼•ä¿®æ­£: include_blob=True æ—¶ä½¿ç”¨ SELECT *ï¼Œå­—æ®µé¡ºåºå¦‚ä¸‹ï¼š
            # 0:id, 1:title, 2:content, 3:color, 4:pinned, 5:fav, 6:created, 7:updated, 8:cat_id, 9:is_deleted, 10:item_type, 11:data_blob
            item_type = d[10] if len(d) > 10 else 'text'
            
            if item_type != 'image':
                self.content_inp.setText(d[2])
            else:
                self.content_inp.clear() # å›¾ç‰‡æ¨¡å¼ä¸æ˜¾ç¤ºæ–‡å­—æ­£æ–‡
            
            self._set_color(d[3])
            self.category_id = d[8]
            if self.category_id is not None:
                idx = self.category_combo.findData(self.category_id)
                if idx >= 0:
                    self.category_combo.setCurrentIndex(idx)
            
            data_blob = d[11] if len(d) > 11 else None
            if item_type == 'image' and data_blob:
                self.content_inp.set_image_data(data_blob)

            self.tags_inp.setText(','.join(self.db.get_tags(self.idea_id)))

    def _save_data(self):
        title = self.title_inp.text().strip()
        if not title:
            self.title_inp.setPlaceholderText("âš ï¸ æ ‡é¢˜ä¸èƒ½ä¸ºç©º!")
            self.title_inp.setFocus()
            return

        tags = [t.strip() for t in self.tags_inp.text().split(',') if t.strip()]
        content = self.content_inp.toPlainText()
        color = self.selected_color
        
        # ã€æ ¸å¿ƒä¿®å¤ã€‘æ™ºèƒ½ä¿å­˜é»˜è®¤é¢œè‰²
        if self.chk_set_default.isChecked():
            save_setting('user_default_color', color)
        
        item_type = 'text'
        data_blob = self.content_inp.get_image_data()
        if data_blob:
            item_type = 'image'

        # è·å–å½“å‰é€‰ä¸­çš„åˆ†åŒºID
        cat_id = self.category_combo.currentData()

        if self.idea_id:
            self.db.update_idea(self.idea_id, title, content, color, tags, cat_id, item_type, data_blob)
        else:
            self.db.add_idea(title, content, color, tags, cat_id, item_type, data_blob)
        
        self.data_saved.emit()
        self.accept()

# === çœ‹æ¿çª—å£ ===
class StatsDialog(BaseDialog):
    def __init__(self, db, parent=None):
        super().__init__(parent)
        self.setWindowTitle('ğŸ“Š æ•°æ®çœ‹æ¿')
        self.resize(550, 450)
        
        layout = QVBoxLayout(self.content_container)
        layout.setContentsMargins(30, 30, 30, 30)
        layout.setSpacing(20)
        
        counts = db.get_counts()
        grid = QGridLayout()
        grid.setSpacing(15)
        grid.addWidget(self._box("ğŸ“š æ€»çµæ„Ÿ", counts['all'], COLORS['primary']), 0, 0)
        grid.addWidget(self._box("ğŸ“… ä»Šæ—¥æ–°å¢", counts['today'], COLORS['success']), 0, 1)
        grid.addWidget(self._box("â­ æˆ‘çš„æ”¶è—", counts['favorite'], COLORS['warning']), 1, 0)
        grid.addWidget(self._box("ğŸ·ï¸ å¾…æ•´ç†", counts['untagged'], COLORS['danger']), 1, 1)
        layout.addLayout(grid)
        
        layout.addSpacing(10)
        layout.addWidget(QLabel("ğŸ”¥ çƒ­é—¨æ ‡ç­¾ Top 5"))
        
        stats = db.get_top_tags()
        if not stats:
            layout.addWidget(QLabel("æš‚æ— æ ‡ç­¾æ•°æ®", styleSheet="color:#666; font-style:italic; font-weight:normal;"))
        else:
            max_val = stats[0][1]
            for name, cnt in stats:
                h = QHBoxLayout()
                lbl = QLabel(f"#{name}")
                lbl.setFixedWidth(80)
                lbl.setStyleSheet("color:#eee; font-weight:bold; margin:0;")
                h.addWidget(lbl)
                
                p = QProgressBar()
                p.setMaximum(max_val)
                p.setValue(cnt)
                p.setFixedHeight(18)
                p.setFormat(f" {cnt}")
                p.setStyleSheet(f"""
                    QProgressBar {{
                        background-color: {COLORS['bg_mid']};
                        border: none;
                        border-radius: 9px;
                        color: white;
                        text-align: center;
                    }}
                    QProgressBar::chunk {{
                        background-color: {COLORS['primary']};
                        border-radius: 9px;
                    }}
                """)
                h.addWidget(p)
                layout.addLayout(h)
                
        layout.addStretch()
        close_btn = QPushButton("å…³é—­")
        close_btn.setFixedHeight(40)
        close_btn.setStyleSheet(f"background-color:{COLORS['bg_mid']}; border:1px solid #444; color:#ccc; border-radius:5px;")
        close_btn.clicked.connect(self.accept)
        layout.addWidget(close_btn)

    def _box(self, t, v, c):
        f = QFrame()
        f.setStyleSheet(f"QFrame {{ background-color: {c}15; border: 1px solid {c}40; border-radius: 10px; }}")
        vl = QVBoxLayout(f)
        vl.setContentsMargins(15, 15, 15, 15)
        lbl_title = QLabel(t)
        lbl_title.setStyleSheet(f"color:{c}; font-size:13px; font-weight:bold; border:none; margin:0;")
        lbl_val = QLabel(str(v))
        lbl_val.setStyleSheet(f"color:{c}; font-size:28px; font-weight:bold; border:none; margin-top:5px;")
        vl.addWidget(lbl_title)
        vl.addWidget(lbl_val)
        return f

# === æå–çª—å£ ===
class ExtractDialog(BaseDialog):
    def __init__(self, db, parent=None):
        super().__init__(parent)
        self.setWindowTitle('ğŸ“‹ æå–å†…å®¹')
        self.resize(700, 600)
        
        layout = QVBoxLayout(self.content_container)
        layout.setContentsMargins(20, 20, 20, 20)
        
        self.txt = QTextEdit()
        self.txt.setReadOnly(True)
        self.txt.setPlaceholderText("æš‚æ— æ•°æ®...")
        layout.addWidget(self.txt)
        
        data = db.get_ideas('', 'all', None)
        text = '\n' + '-'*60 + '\n'
        text += '\n'.join([f"ã€{d[1]}ã€‘\n{d[2]}\n" + '-'*60 for d in data])
        self.txt.setText(text)
        
        layout.addSpacing(10)
        btn = QPushButton('ğŸ“‹ å¤åˆ¶å…¨éƒ¨åˆ°å‰ªè´´æ¿')
        btn.setFixedHeight(45)
        btn.setStyleSheet(STYLES['btn_primary'])
        btn.clicked.connect(lambda: (QApplication.clipboard().setText(text), QMessageBox.information(self,'æˆåŠŸ','âœ… å†…å®¹å·²å¤åˆ¶')))
        layout.addWidget(btn)

# === é¢„è§ˆçª—å£ ===
from PyQt5.QtGui import QPixmap, QImage
from PyQt5.QtWidgets import QDesktopWidget

class PreviewDialog(QDialog):
    def __init__(self, item_type, data, parent=None):
        super().__init__(parent)
        self.setWindowFlags(Qt.Dialog | Qt.FramelessWindowHint | Qt.Popup)
        self.setAttribute(Qt.WA_TranslucentBackground)
        
        self._init_ui(item_type, data)

        QShortcut(QKeySequence(Qt.Key_Escape), self, self.close)
        QShortcut(QKeySequence(Qt.Key_Space), self, self.close)

    def _init_ui(self, item_type, data):
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        
        container = QWidget()
        container.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_dark']};
                border: 2px solid {COLORS['bg_mid']};
                border-radius: 12px;
            }}
        """)
        container_layout = QVBoxLayout(container)
        main_layout.addWidget(container)

        if item_type == 'text':
            self._setup_text_preview(container_layout, data)
        elif item_type == 'image':
            self._setup_image_preview(container_layout, data)

    def _setup_text_preview(self, layout, text_data):
        self.resize(600, 500)
        
        text_edit = QTextEdit()
        text_edit.setReadOnly(True)
        text_edit.setText(text_data)
        text_edit.setStyleSheet(f"""
            QTextEdit {{
                background-color: transparent;
                border: none;
                padding: 15px;
                color: #ddd;
                font-size: 14px;
            }}
            {SCROLLBAR_STYLE}
        """)
        layout.addWidget(text_edit)

    def _setup_image_preview(self, layout, image_data):
        pixmap = QPixmap()
        pixmap.loadFromData(image_data)

        if pixmap.isNull():
            label = QLabel("æ— æ³•åŠ è½½å›¾ç‰‡")
            label.setAlignment(Qt.AlignCenter)
            label.setStyleSheet("color: #E81123; font-size: 16px;")
            layout.addWidget(label)
            self.resize(300, 200)
            return
            
        label = QLabel()
        label.setAlignment(Qt.AlignCenter)
        layout.addWidget(label)

        screen_geo = QDesktopWidget().availableGeometry(self)
        max_width = screen_geo.width() * 0.8
        max_height = screen_geo.height() * 0.8

        scaled_pixmap = pixmap.scaled(int(max_width), int(max_height), Qt.KeepAspectRatio, Qt.SmoothTransformation)
        label.setPixmap(scaled_pixmap)
        
        self.resize(scaled_pixmap.width() + 20, scaled_pixmap.height() + 20)

    def mousePressEvent(self, event):
        self.close()
```

## æ–‡ä»¶: enums.py

```python
# core/enums.py
from enum import Enum

class FilterType(Enum):
    ALL = "all"
    TODAY = "today"
    CATEGORY = "category"
    CLIPBOARD = "clipboard"
    UNCATEGORIZED = "uncategorized"
    UNTAGGED = "untagged"
    FAVORITE = "favorite"
    TRASH = "trash"
```

## æ–‡ä»¶: hash_calculator.py

```python
# services/hash_calculator.py
import hashlib

class HashCalculator:
    def compute(self, content, data_blob=None):
        """
        Computes the SHA256 hash for the given content.
        """
        hasher = hashlib.sha256()
        if data_blob:
            hasher.update(data_blob)
        elif content:
            hasher.update(str(content).encode('utf-8'))
        else:
            return None
        return hasher.hexdigest()
```

## æ–‡ä»¶: idea_repository.py

```python
# data/repositories/idea_repository.py
import sqlite3
import hashlib
import os
from core.enums import FilterType

class IdeaRepository:
    def __init__(self, conn):
        self.conn = conn

    def add(self, title, content, color, category_id=None, item_type='text', data_blob=None, content_hash=None):
        c = self.conn.cursor()
        c.execute(
            'INSERT INTO ideas (title, content, color, category_id, item_type, data_blob, content_hash) VALUES (?,?,?,?,?,?,?)',
            (title, content, color, category_id, item_type, data_blob, content_hash)
        )
        self.conn.commit()
        return c.lastrowid

    def update(self, iid, title, content, color, category_id=None, item_type='text', data_blob=None):
        c = self.conn.cursor()
        c.execute(
            'UPDATE ideas SET title=?, content=?, color=?, category_id=?, item_type=?, data_blob=?, updated_at=CURRENT_TIMESTAMP WHERE id=?',
            (title, content, color, category_id, item_type, data_blob, iid)
        )
        self.conn.commit()

    def find_by_hash(self, content_hash):
        c = self.conn.cursor()
        c.execute("SELECT id FROM ideas WHERE content_hash = ?", (content_hash,))
        return c.fetchone()

    def update_timestamp(self, iid):
        c = self.conn.cursor()
        c.execute("UPDATE ideas SET updated_at = CURRENT_TIMESTAMP WHERE id = ?", (iid,))
        self.conn.commit()

    def toggle_field(self, iid, field):
        if field not in ['is_pinned', 'is_favorite']:
            raise ValueError("Invalid field for toggling")
        c = self.conn.cursor()
        c.execute(f'UPDATE ideas SET {field} = NOT {field} WHERE id=?', (iid,))
        self.conn.commit()

    def set_deleted(self, iid, state):
        c = self.conn.cursor()
        c.execute('UPDATE ideas SET is_deleted=? WHERE id=?', (1 if state else 0, iid))
        self.conn.commit()

    def move_category(self, iid, cat_id):
        c = self.conn.cursor()
        c.execute('UPDATE ideas SET category_id=? WHERE id=?', (cat_id, iid))
        self.conn.commit()

    def delete_permanent(self, iid):
        c = self.conn.cursor()
        c.execute('DELETE FROM ideas WHERE id=?', (iid,))
        c.execute('DELETE FROM idea_tags WHERE idea_id=?', (iid,))
        self.conn.commit()

    def get_by_id(self, iid, include_blob=False):
        c = self.conn.cursor()
        if include_blob:
            c.execute('SELECT * FROM ideas WHERE id=?', (iid,))
        else:
            c.execute('SELECT id, title, content, color, is_pinned, is_favorite, created_at, updated_at, category_id, item_type FROM ideas WHERE id=?', (iid,))
        return c.fetchone()

    def get_all(self, search: str, f_type: FilterType, f_val):
        c = self.conn.cursor()
        q = "SELECT DISTINCT i.* FROM ideas i LEFT JOIN idea_tags it ON i.id=it.idea_id LEFT JOIN tags t ON it.tag_id=t.id WHERE 1=1"
        p = []
        
        if f_type == FilterType.TRASH:
            q += ' AND i.is_deleted=1'
        else:
            q += ' AND (i.is_deleted=0 OR i.is_deleted IS NULL)'
        
        if f_type == FilterType.CATEGORY:
            if f_val is None: q += ' AND i.category_id IS NULL'
            else: q += ' AND i.category_id=?'; p.append(f_val)
        elif f_type == FilterType.TODAY:
            q += " AND date(i.updated_at,'localtime')=date('now','localtime')"
        elif f_type == FilterType.CLIPBOARD:
            q += " AND i.id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = 'å‰ªè´´æ¿'))"
        elif f_type == FilterType.UNTAGGED:
            q += ' AND i.id NOT IN (SELECT idea_id FROM idea_tags)'
        elif f_type == FilterType.FAVORITE:
            q += ' AND i.is_favorite=1'
        elif f_type == FilterType.UNCATEGORIZED:
            q += ' AND i.category_id IS NULL'
        
        if search:
            q += ' AND (i.title LIKE ? OR i.content LIKE ? OR t.name LIKE ?)'
            p.extend([f'%{search}%']*3)
            
        q += ' ORDER BY i.is_pinned DESC, i.updated_at DESC'
        c.execute(q, p)
        return c.fetchall()

    def get_counts(self):
        c = self.conn.cursor()
        d = {}
        queries = {
            FilterType.ALL: "is_deleted=0 OR is_deleted IS NULL",
            FilterType.TODAY: "(is_deleted=0 OR is_deleted IS NULL) AND date(updated_at,'localtime')=date('now','localtime')",
            FilterType.CLIPBOARD: "(is_deleted=0 OR is_deleted IS NULL) AND id IN (SELECT idea_id FROM idea_tags WHERE tag_id = (SELECT id FROM tags WHERE name = 'å‰ªè´´æ¿'))",
            FilterType.UNCATEGORIZED: "(is_deleted=0 OR is_deleted IS NULL) AND category_id IS NULL",
            FilterType.UNTAGGED: "(is_deleted=0 OR is_deleted IS NULL) AND id NOT IN (SELECT idea_id FROM idea_tags)",
            FilterType.FAVORITE: "(is_deleted=0 OR is_deleted IS NULL) AND is_favorite=1",
            FilterType.TRASH: "is_deleted=1"
        }
        for k, v in queries.items():
            c.execute(f"SELECT COUNT(*) FROM ideas WHERE {v}")
            d[k.value] = c.fetchone()[0]
            
        c.execute("SELECT category_id, COUNT(*) FROM ideas WHERE (is_deleted=0 OR is_deleted IS NULL) GROUP BY category_id")
        d['categories'] = dict(c.fetchall())
        return d
```

## æ–‡ä»¶: idea_service.py

```python
# services/idea_service.py
from core.enums import FilterType

class IdeaService:
    def __init__(self, idea_repo, tag_repo, category_repo):
        self.idea_repo = idea_repo
        self.tag_repo = tag_repo
        self.category_repo = category_repo

    def add_idea(self, title, content, color, tags, category_id=None, item_type='text', data_blob=None):
        idea_id = self.idea_repo.add(title, content, color, category_id, item_type, data_blob)
        self.tag_repo.update_tags_for_idea(idea_id, tags)
        return idea_id

    def update_idea(self, iid, title, content, color, tags, category_id=None, item_type='text', data_blob=None):
        self.idea_repo.update(iid, title, content, color, category_id, item_type, data_blob)
        self.tag_repo.update_tags_for_idea(iid, tags)

    def update_tags_for_idea(self, idea_id, tags):
        self.tag_repo.update_tags_for_idea(idea_id, tags)

    def get_ideas_for_filter(self, search_text: str, filter_type_str: str, filter_value):
        try:
            filter_type_enum = FilterType(filter_type_str)
        except ValueError:
            filter_type_enum = FilterType.ALL
        return self.idea_repo.get_all(search_text, filter_type_enum, filter_value)

    def toggle_favorite(self, idea_id):
        self.idea_repo.toggle_field(idea_id, 'is_favorite')

    def toggle_pinned(self, idea_id):
        self.idea_repo.toggle_field(idea_id, 'is_pinned')

    def move_to_trash(self, idea_ids):
        for iid in idea_ids:
            self.idea_repo.set_deleted(iid, True)
    
    def restore_from_trash(self, idea_ids):
        for iid in idea_ids:
            self.idea_repo.set_deleted(iid, False)

    def delete_permanently(self, idea_ids):
        for iid in idea_ids:
            self.idea_repo.delete_permanent(iid)

    def move_to_category(self, idea_ids, category_id):
        for iid in idea_ids:
            self.idea_repo.move_category(iid, category_id)

    # --- Pass-through methods to repositories ---
    
    def get_idea_with_blob(self, iid):
        return self.idea_repo.get_by_id(iid, include_blob=True)

    def get_idea_tags(self, iid):
        return self.tag_repo.get_tags_for_idea(iid)

    def get_all_categories(self):
        return self.category_repo.get_all()

    def get_category_tree(self):
        return self.category_repo.get_tree()

    def get_all_tags_with_counts(self):
        return self.tag_repo.get_all_tags_with_counts()

    def get_stats_counts(self):
        return self.idea_repo.get_counts()

    def add_category(self, name, parent_id=None):
        self.category_repo.add(name, parent_id)

    def rename_category(self, cat_id, new_name):
        self.category_repo.rename(cat_id, new_name)

    def delete_category(self, cat_id):
        self.category_repo.delete(cat_id)

    def save_category_order(self, order_list):
        self.category_repo.save_order(order_list)
```

## æ–‡ä»¶: K Main_V3.py

```python
# K Main_V3.py (å·²ä¿®æ”¹ä¸ºéæ¨¡æ€)

import sys
import time
import os
from PyQt5.QtWidgets import QApplication, QMenu, QSystemTrayIcon, QDialog
from PyQt5.QtCore import QObject, Qt
from PyQt5.QtGui import QIcon
from PyQt5.QtNetwork import QLocalServer, QLocalSocket
from ui.quick_window import QuickWindow
from ui.main_window import MainWindow
from ui.ball import FloatingBall
from ui.action_popup import ActionPopup
from ui.common_tags_manager import CommonTagsManager
from ui.advanced_tag_selector import AdvancedTagSelector
from data.db_manager import DatabaseManager
from core.settings import load_setting

SERVER_NAME = "K_KUAIJIBIJI_SINGLE_INSTANCE_SERVER"

class AppManager(QObject):

    def __init__(self, app):
        super().__init__()
        self.app = app
        self.db_manager = None
        self.main_window = None
        self.quick_window = None
        self.ball = None
        self.popup = None 
        self.tray_icon = None
        
        # ã€æ–°å¢ã€‘ç”¨äºæŒæœ‰éæ¨¡æ€å¯¹è¯æ¡†çš„å¼•ç”¨ï¼Œé˜²æ­¢çª—å£é—ªé€€
        self.tags_manager_dialog = None

    def start(self):
        try:
            self.db_manager = DatabaseManager()
        except Exception as e:
            pass
            sys.exit(1)

        logo_path = os.path.join("assets", "logo.svg")
        if os.path.exists(logo_path):
            app_icon = QIcon(logo_path)
            self.app.setWindowIcon(app_icon)
        else:
            app_icon = QIcon()
        
        self.app.setApplicationName("")
        self.app.setApplicationDisplayName("")
        self.app.setOrganizationName("RapidNotes")
        self.app.setOrganizationDomain("rapidnotes.local")

        self._init_tray_icon(app_icon)

        self.main_window = MainWindow()
        self.main_window.closing.connect(self.on_main_window_closing)

        self.ball = FloatingBall(self.main_window)
        
        # --- æ‚¬æµ®çƒå³é”®èœå• ---
        # æ³¨æ„: è¿™é‡Œçš„ m.exec_() æ˜¯ç”¨äºQMenuçš„ï¼Œæ˜¯æ­£ç¡®çš„ç”¨æ³•ï¼Œå®ƒä¼šå µå¡ç›´åˆ°ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼Œè¿™æ˜¯æœŸæœ›çš„è¡Œä¸ºã€‚
        original_context_menu = self.ball.contextMenuEvent
        def new_context_menu(e):
            m = QMenu(self.ball)
            m.setStyleSheet("""
                QMenu { background-color: #1a1a1a; color: #00f3ff; border: 1px solid #333; padding: 5px; }
                QMenu::item { padding: 5px 20px; }
                QMenu::item:selected { background-color: #00f3ff; color: #000; border-radius: 2px;}
                QMenu::separator { background-color: #333; height: 1px; margin: 5px 0; }
            """)
            m.addAction('âš¡ æ‰“å¼€å¿«é€Ÿç¬”è®°', self.ball.request_show_quick_window.emit)
            m.addAction('ğŸ’» æ‰“å¼€ä¸»ç•Œé¢', self.ball.request_show_main_window.emit)
            # å‡è®¾ main_window.new_idea å†…éƒ¨ä¹Ÿä½¿ç”¨äº† .exec_(), æ‚¨éœ€è¦ç”¨åŒæ ·çš„æ–¹æ³•å»ä¿®æ”¹ main_window.py
            m.addAction('â• æ–°å»ºçµæ„Ÿ', self.main_window.new_idea)
            m.addSeparator()
            m.addAction('ğŸ·ï¸ ç®¡ç†å¸¸ç”¨æ ‡ç­¾', self._open_common_tags_manager)
            m.addSeparator()
            m.addAction('âŒ é€€å‡º', self.ball.request_quit_app.emit)
            m.exec_(e.globalPos())
        
        self.ball.contextMenuEvent = new_context_menu
        self.ball.request_show_quick_window.connect(self.show_quick_window)
        self.ball.double_clicked.connect(self.show_quick_window)
        self.ball.request_show_main_window.connect(self.show_main_window)
        self.ball.request_quit_app.connect(self.quit_application)
        
        ball_pos = load_setting('floating_ball_pos')
        if ball_pos and isinstance(ball_pos, dict) and 'x' in ball_pos and 'y' in ball_pos:
            self.ball.move(ball_pos['x'], ball_pos['y'])
        else:
            g = QApplication.desktop().screenGeometry()
            self.ball.move(g.width()-80, g.height()//2)
            
        self.ball.show()

        self.quick_window = QuickWindow(self.db_manager)
        self.quick_window.open_main_window_requested.connect(self.show_main_window)
        
        self.popup = ActionPopup() 
        self.popup.request_favorite.connect(self._handle_popup_favorite)
        self.popup.request_tag_toggle.connect(self._handle_popup_tag_toggle)
        self.popup.request_manager.connect(self._open_common_tags_manager)
        
        self.quick_window.cm.data_captured.connect(self._on_clipboard_data_captured)

    def _init_tray_icon(self, icon):
        """åˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜å›¾æ ‡"""
        self.tray_icon = QSystemTrayIcon(self.app)
        self.tray_icon.setIcon(icon)
        self.tray_icon.setToolTip("å¿«é€Ÿç¬”è®°")
        
        menu = QMenu()
        menu.setStyleSheet("""
            QMenu { background-color: #2D2D2D; color: #EEE; border: 1px solid #444; }
            QMenu::item { padding: 6px 24px; }
            QMenu::item:selected { background-color: #4a90e2; color: white; }
        """)
        
        action_show = menu.addAction("æ˜¾ç¤ºä¸»ç•Œé¢")
        action_show.triggered.connect(self.show_main_window)
        
        action_quick = menu.addAction("æ˜¾ç¤ºå¿«é€Ÿç¬”è®°")
        action_quick.triggered.connect(self.show_quick_window)
        
        menu.addSeparator()
        
        action_quit = menu.addAction("é€€å‡ºç¨‹åº")
        action_quit.triggered.connect(self.quit_application)
        
        self.tray_icon.setContextMenu(menu)
        self.tray_icon.activated.connect(self._on_tray_icon_activated)
        self.tray_icon.show()

    def _on_tray_icon_activated(self, reason):
        if reason == QSystemTrayIcon.Trigger:
            self.show_main_window()

    # --- ã€æ ¸å¿ƒä¿®æ”¹åŒºåŸŸã€‘ ---
    def _open_common_tags_manager(self):
        """ä»¥éæ¨¡æ€æ–¹å¼æ‰“å¼€å¸¸ç”¨æ ‡ç­¾ç®¡ç†ç•Œé¢"""
        # å¦‚æœçª—å£å·²å­˜åœ¨ï¼Œåˆ™åªæ¿€æ´»å®ƒï¼Œä¸åˆ›å»ºæ–°çš„
        if self.tags_manager_dialog and self.tags_manager_dialog.isVisible():
            self._force_activate(self.tags_manager_dialog)
            return

        # åˆ›å»ºå®ä¾‹å¹¶èµ‹å€¼ç»™ self.tags_manager_dialogï¼Œé˜²æ­¢è¢«åƒåœ¾å›æ”¶
        self.tags_manager_dialog = CommonTagsManager()

        # å…³é”®: ä½¿ç”¨ä¿¡å·æ§½å¤„ç†å…³é—­äº‹ä»¶ï¼Œè€Œä¸æ˜¯ä¾èµ– exec_ çš„è¿”å›å€¼
        self.tags_manager_dialog.finished.connect(self._on_tags_manager_closed)

        # å…³é”®: ä½¿ç”¨ show() æ¥æ˜¾ç¤ºçª—å£ï¼Œä¸ä¼šå µå¡
        self.tags_manager_dialog.show()
        self._force_activate(self.tags_manager_dialog)

    def _on_tags_manager_closed(self, result):
        """è¿™æ˜¯æ ‡ç­¾ç®¡ç†å¯¹è¯æ¡†å…³é—­åä¼šæ‰§è¡Œçš„å‡½æ•°"""
        # æ£€æŸ¥æ˜¯å¦æ˜¯â€œç¡®å®šâ€å…³é—­ (åœ¨dialogs.pyä¸­ï¼Œä¿å­˜/ç¡®å®šæŒ‰é’®é€šå¸¸ä¼šè°ƒç”¨ self.accept())
        if result == QDialog.Accepted:
            if self.popup:
                self.popup.common_tags_bar.reload_tags()
        
        # æ¸…ç†å¼•ç”¨ï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥é‡æ–°æ‰“å¼€
        self.tags_manager_dialog = None
    # --- ã€æ ¸å¿ƒä¿®æ”¹åŒºåŸŸç»“æŸã€‘ ---

    def _on_clipboard_data_captured(self, idea_id):
        self.ball.trigger_clipboard_feedback()
        if self.popup:
            self.popup.show_at_mouse(idea_id)

    def _handle_popup_favorite(self, idea_id):
        self.db_manager.set_favorite(idea_id, True)
        if self.main_window.isVisible():
            self.main_window._load_data()
            self.main_window.sidebar.refresh()

    def _handle_popup_tag_toggle(self, idea_id, tag_name, checked):
        if checked:
            self.db_manager.add_tags_to_multiple_ideas([idea_id], [tag_name])
        else:
            self.db_manager.remove_tag_from_multiple_ideas([idea_id], tag_name)
            
        if self.main_window.isVisible():
            self.main_window._load_data()
            self.main_window._refresh_tag_panel()

    def _force_activate(self, window):
        if not window: return
        window.show()
        if window.isMinimized():
            window.setWindowState(window.windowState() & ~Qt.WindowMinimized | Qt.WindowActive)
            window.showNormal()
        window.raise_()
        window.activateWindow()

    def show_quick_window(self):
        self._force_activate(self.quick_window)

    def toggle_quick_window(self):
        if self.quick_window and self.quick_window.isVisible():
            self.quick_window.hide()
        else:
            self.show_quick_window()

    def show_main_window(self):
        self._force_activate(self.main_window)

    def on_main_window_closing(self):
        if self.main_window:
            self.main_window.hide()
            
    def quit_application(self):
        if self.quick_window:
            try:
                self.quick_window.save_state()
            except: pass
        if self.main_window:
            try:
                self.main_window.save_state()
            except: pass
        self.app.quit()

def main():
    app = QApplication(sys.argv)
    
    # --- å•ä¾‹åº”ç”¨é€»è¾‘ ---
    socket = QLocalSocket()
    socket.connectToServer(SERVER_NAME)
    if socket.waitForConnected(500):
        socket.write(b'EXIT')
        socket.flush()
        socket.waitForBytesWritten(1000)
        socket.disconnectFromServer()
        time.sleep(0.5)
        QLocalServer.removeServer(SERVER_NAME)
    else:
        QLocalServer.removeServer(SERVER_NAME)

    server = QLocalServer()
    if not server.listen(SERVER_NAME):
        pass
    
    manager = AppManager(app)

    def handle_new_connection():
        conn = server.nextPendingConnection()
        if conn and conn.waitForReadyRead(500):
            msg = conn.readAll().data().decode()
            if msg == 'SHOW':
                manager.show_quick_window()
            elif msg == 'EXIT':
                manager.quit_application()
    server.newConnection.connect(handle_new_connection)
    
    manager.start()
    
    # --- å¯åŠ¨åº”ç”¨ä¸»å¾ªç¯ ---
    # æ³¨æ„: è¿™é‡Œçš„ app.exec_() æ˜¯Qtåº”ç”¨çš„ä¸»äº‹ä»¶å¾ªç¯ï¼Œå¿…é¡»å­˜åœ¨ä¸”åªèƒ½æœ‰ä¸€ä¸ªï¼Œå®ƒä¼šâ€œå µå¡â€ç›´åˆ°æ•´ä¸ªåº”ç”¨é€€å‡ºã€‚
    sys.exit(app.exec_())

if __name__ == '__main__':
    main()
```

## æ–‡ä»¶: logger.py

```python

import logging
import sys
from logging.handlers import RotatingFileHandler

def setup_logging():
    logger = logging.getLogger('RapidNotes')
    logger.setLevel(logging.DEBUG)

    # Prevent adding handlers multiple times
    if logger.hasHandlers():
        logger.handlers.clear()

    # Formatter
    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s'
    )

    # Console Handler
    stdout_handler = logging.StreamHandler(sys.stdout)
    stdout_handler.setLevel(logging.DEBUG)
    stdout_handler.setFormatter(formatter)
    logger.addHandler(stdout_handler)

    # File Handler
    file_handler = RotatingFileHandler(
        'app_run.log', maxBytes=1024 * 1024 * 5, backupCount=5, encoding='utf-8'
    )
    file_handler.setLevel(logging.DEBUG)
    file_handler.setFormatter(formatter)
    logger.addHandler(file_handler)

    logger.info("æ—¥å¿—æœåŠ¡åˆå§‹åŒ–æˆåŠŸã€‚")

def get_logger(name):
    return logging.getLogger(name)

```

## æ–‡ä»¶: main_window.py

```python
# -*- coding: utf-8 -*-
# ui/main_window.py
import sys
import math
from PyQt5.QtWidgets import (QWidget, QHBoxLayout, QVBoxLayout, QSplitter, QLineEdit,
                               QPushButton, QLabel, QScrollArea, QShortcut, QMessageBox,
                               QApplication, QToolTip, QMenu, QFrame, QTextEdit, QDialog,
                               QGraphicsDropShadowEffect, QLayout, QSizePolicy, QInputDialog)
from PyQt5.QtCore import Qt, QTimer, QPoint, pyqtSignal, QRect, QSize, QByteArray
from PyQt5.QtGui import QKeySequence, QCursor, QColor, QIntValidator
from core.config import STYLES, COLORS
from core.settings import load_setting, save_setting
from data.db_manager import DatabaseManager
from services.backup_service import BackupService
from ui.sidebar import Sidebar
from ui.cards import IdeaCard
from ui.dialogs import EditDialog
from ui.ball import FloatingBall
from ui.advanced_tag_selector import AdvancedTagSelector
from ui.components.search_line_edit import SearchLineEdit
from services.preview_service import PreviewService

# --- è¾…åŠ©ç±»ï¼šæµå¼å¸ƒå±€ ---
class FlowLayout(QLayout):
    def __init__(self, parent=None, margin=0, spacing=-1):
        super(FlowLayout, self).__init__(parent)
        if parent is not None:
            self.setContentsMargins(margin, margin, margin, margin)
        self.setSpacing(spacing)
        self.itemList = []

    def __del__(self):
        item = self.takeAt(0)
        while item:
            item = self.takeAt(0)

    def addItem(self, item):
        self.itemList.append(item)

    def count(self):
        return len(self.itemList)

    def itemAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList[index]
        return None

    def takeAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList.pop(index)
        return None

    def expandingDirections(self):
        return Qt.Orientations(Qt.Orientation(0))

    def hasHeightForWidth(self):
        return True

    def heightForWidth(self, width):
        height = self.doLayout(QRect(0, 0, width, 0), True)
        return height

    def setGeometry(self, rect):
        super(FlowLayout, self).setGeometry(rect)
        self.doLayout(rect, False)

    def sizeHint(self):
        return self.minimumSize()

    def minimumSize(self):
        size = QSize()
        for item in self.itemList:
            size = size.expandedTo(item.minimumSize())
        margin = self.contentsMargins()
        size += QSize(margin.left() + margin.right(), margin.top() + margin.bottom())
        return size

    def doLayout(self, rect, testOnly):
        x = rect.x()
        y = rect.y()
        lineHeight = 0
        spacing = self.spacing()

        for item in self.itemList:
            wid = item.widget()
            spaceX = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Horizontal)
            spaceY = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Vertical)
            
            nextX = x + item.sizeHint().width() + spaceX
            if nextX - spaceX > rect.right() and lineHeight > 0:
                x = rect.x()
                y = y + lineHeight + spaceY
                nextX = x + item.sizeHint().width() + spaceX
                lineHeight = 0

            if not testOnly:
                item.setGeometry(QRect(QPoint(x, y), item.sizeHint()))

            x = nextX
            lineHeight = max(lineHeight, item.sizeHint().height())

        return y + lineHeight - rect.y()

class ContentContainer(QWidget):
    cleared = pyqtSignal()

    def mousePressEvent(self, e):
        if self.childAt(e.pos()) is None:
            self.cleared.emit()
        super().mousePressEvent(e)

# å¯åŒå‡»çš„è¾“å…¥æ¡†
class ClickableLineEdit(QLineEdit):
    doubleClicked = pyqtSignal()
    def mouseDoubleClickEvent(self, event):
        self.doubleClicked.emit()
        super().mouseDoubleClickEvent(event)

class MainWindow(QWidget):
    closing = pyqtSignal()
    RESIZE_MARGIN = 8

    def __init__(self):
        super().__init__()
        QApplication.setQuitOnLastWindowClosed(False)
        self.db = DatabaseManager()
        self.preview_service = PreviewService(self.db, self)
        
        self.curr_filter = ('all', None)
        self.selected_ids = set()
        self._drag_pos = None
        self.current_tag_filter = None
        self.last_clicked_id = None 
        self.card_ordered_ids = []  
        self._resize_area = None
        self._resize_start_pos = None
        self._resize_start_geometry = None
        
        # åˆ†é¡µçŠ¶æ€
        self.current_page = 1
        self.page_size = 20
        self.total_pages = 1
        
        self.open_dialogs = [] # å­˜å‚¨æ‰“å¼€çš„çª—å£
        
        self.setWindowFlags(
            Qt.FramelessWindowHint | 
            Qt.Window | 
            Qt.WindowSystemMenuHint | 
            Qt.WindowMinimizeButtonHint | 
            Qt.WindowMaximizeButtonHint
        )
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setMouseTracking(True)
        
        self._setup_ui()
        self._load_data()
    def _setup_ui(self):
        self.setWindowTitle('æ•°æ®ç®¡ç†')
        # self.resize(1300, 700) # Replaced by restore
        self._restore_window_state()
        
        root_layout = QVBoxLayout(self)
        root_layout.setContentsMargins(12, 12, 12, 12)
        
        self.container = QWidget()
        self.container.setObjectName("MainContainer")
        self.container.setStyleSheet(STYLES['main_window'])
        root_layout.addWidget(self.container)
        
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(25)
        shadow.setXOffset(0)
        shadow.setYOffset(4)
        shadow.setColor(QColor(0, 0, 0, 100))
        self.container.setGraphicsEffect(shadow)
        
        outer_layout = QVBoxLayout(self.container)
        outer_layout.setContentsMargins(0, 0, 0, 0)
        outer_layout.setSpacing(0)
        
        titlebar = self._create_titlebar()
        outer_layout.addWidget(titlebar)
        
        main_content = QWidget()
        main_layout = QHBoxLayout(main_content)
        main_layout.setContentsMargins(0, 0, 0, 0)
        splitter = QSplitter(Qt.Horizontal)
        
        self.sidebar = Sidebar(self.db)
        self.sidebar.filter_changed.connect(self._set_filter)
        self.sidebar.data_changed.connect(self._load_data)
        self.sidebar.new_data_requested.connect(self._on_new_data_in_category_requested)
        splitter.addWidget(self.sidebar)
        
        middle_panel = self._create_middle_panel()
        splitter.addWidget(middle_panel)
        
        self.tag_panel = self._create_tag_panel()
        splitter.addWidget(self.tag_panel)
        
        splitter.setStretchFactor(0, 1)
        splitter.setStretchFactor(1, 4)
        splitter.setStretchFactor(2, 1)
        
        main_layout.addWidget(splitter)
        outer_layout.addWidget(main_content)
        
        QShortcut(QKeySequence("Ctrl+T"), self, self._handle_extract_key)
        QShortcut(QKeySequence("Ctrl+N"), self, self.new_idea)
        QShortcut(QKeySequence("Ctrl+W"), self, self.close)
        QShortcut(QKeySequence("Ctrl+A"), self, self._select_all)
        QShortcut(QKeySequence("Ctrl+F"), self, self.search.setFocus)
        QShortcut(QKeySequence("Ctrl+E"), self, self._do_fav)
        QShortcut(QKeySequence("Ctrl+B"), self, self._do_edit)
        QShortcut(QKeySequence("Ctrl+P"), self, self._do_pin)
        QShortcut(QKeySequence("Delete"), self, self._handle_del_key)
        QShortcut(QKeySequence("Escape"), self, self._clear_tag_filter)
        
        self.space_shortcut = QShortcut(QKeySequence(Qt.Key_Space), self)
        self.space_shortcut.setContext(Qt.WindowShortcut)
        self.space_shortcut.activated.connect(lambda: self.preview_service.toggle_preview(self.selected_ids))

    def _select_all(self):
        if not self.cards: return
        if len(self.selected_ids) == len(self.cards):
            self.selected_ids.clear()
        else:
            self.selected_ids = set(self.cards.keys())
        self._update_all_card_selections()
        self._update_ui_state()

    def _clear_all_selections(self):
        if not self.selected_ids: return
        self.selected_ids.clear()
        self.last_clicked_id = None
        self._update_all_card_selections()
        self._update_ui_state()

    def _create_titlebar(self):
        titlebar = QWidget()
        titlebar.setFixedHeight(40)
        titlebar.setStyleSheet(f"QWidget {{ background-color: {COLORS['bg_mid']}; border-bottom: 1px solid {COLORS['bg_light']}; border-top-left-radius: 8px; border-top-right-radius: 8px; }}")
        
        layout = QHBoxLayout(titlebar)
        layout.setContentsMargins(15, 0, 10, 0)
        layout.setSpacing(6)
        
        title = QLabel('ğŸ’¡ å¿«é€Ÿç¬”è®°')
        title.setStyleSheet("font-size: 13px; font-weight: bold; color: #4a90e2;")
        layout.addWidget(title)
        
        self.search = SearchLineEdit()
        self.search.setClearButtonEnabled(True)
        self.search.setPlaceholderText('ğŸ” æœç´¢çµæ„Ÿ (åŒå‡»æŸ¥çœ‹å†å²)')
        self.search.setFixedWidth(280)
        self.search.setFixedHeight(28)
        self.search.setStyleSheet(STYLES['input'] + """
            QLineEdit { border-radius: 14px; padding-right: 25px; }
            QLineEdit::clear-button { image: url(assets/clear.png); subcontrol-position: right; margin-right: 5px; }
        """)
        self.search.textChanged.connect(lambda: self._set_page(1))
        self.search.returnPressed.connect(self._add_search_to_history)
        layout.addWidget(self.search)
        
        layout.addSpacing(10)
        
        # --- åˆ†é¡µæ§ä»¶åŒºåŸŸ ---
        page_btn_style = """
            QPushButton { background-color: transparent; border: 1px solid #444; color: #aaa; border-radius: 4px; font-size: 11px; padding: 2px 8px; min-width: 20px; }
            QPushButton:hover { background-color: #333; color: white; border-color: #666; }
            QPushButton:disabled { color: #444; border-color: #333; }
        """
        
        self.btn_first = QPushButton("<<")
        self.btn_first.setStyleSheet(page_btn_style)
        self.btn_first.setToolTip("é¦–é¡µ")
        self.btn_first.clicked.connect(lambda: self._set_page(1))
        
        self.btn_prev = QPushButton("<")
        self.btn_prev.setStyleSheet(page_btn_style)
        self.btn_prev.setToolTip("ä¸Šä¸€é¡µ")
        self.btn_prev.clicked.connect(lambda: self._set_page(self.current_page - 1))
        
        self.page_input = QLineEdit()
        self.page_input.setFixedWidth(40)
        self.page_input.setAlignment(Qt.AlignCenter)
        self.page_input.setValidator(QIntValidator(1, 9999))
        self.page_input.setStyleSheet("background-color: #2D2D2D; border: 1px solid #444; color: #DDD; border-radius: 4px; padding: 2px;")
        self.page_input.returnPressed.connect(self._jump_to_page)
        
        self.total_page_label = QLabel("/ 1")
        self.total_page_label.setStyleSheet("color: #888; font-size: 12px; margin-left: 2px; margin-right: 5px;")
        
        self.btn_next = QPushButton(">")
        self.btn_next.setStyleSheet(page_btn_style)
        self.btn_next.setToolTip("ä¸‹ä¸€é¡µ")
        self.btn_next.clicked.connect(lambda: self._set_page(self.current_page + 1))
        
        self.btn_last = QPushButton(">>")
        self.btn_last.setStyleSheet(page_btn_style)
        self.btn_last.setToolTip("æœ«é¡µ")
        self.btn_last.clicked.connect(lambda: self._set_page(self.total_pages))
        
        layout.addWidget(self.btn_first)
        layout.addWidget(self.btn_prev)
        layout.addWidget(self.page_input)
        layout.addWidget(self.total_page_label)
        layout.addWidget(self.btn_next)
        layout.addWidget(self.btn_last)
        
        layout.addStretch()
        
        ctrl_btn_style = f"QPushButton {{ background-color: transparent; border: none; color: #aaa; border-radius: 6px; font-size: 16px; min-width: 30px; max-width: 30px; min-height: 30px; max-height: 30px; }} QPushButton:hover {{ background-color: rgba(255,255,255,0.1); color: white; }}"
        
        extract_btn = QPushButton('ğŸ“¤')
        extract_btn.setToolTip('æ‰¹é‡æå–å…¨éƒ¨')
        extract_btn.setStyleSheet(f"QPushButton {{ background-color: {COLORS['primary']}; border: none; color: white; border-radius: 6px; font-size: 18px; min-width: 30px; max-width: 30px; min-height: 30px; max-height: 30px; }} QPushButton:hover {{ background-color: #357abd; }}")
        # ç¡®ä¿è¿™é‡Œè°ƒç”¨äº† self._extract_all
        extract_btn.clicked.connect(self._extract_all)
        layout.addWidget(extract_btn)
        
        new_btn = QPushButton('â•')
        new_btn.setToolTip('æ–°å»ºçµæ„Ÿ (Ctrl+N)')
        new_btn.setStyleSheet(f"QPushButton {{ background-color: {COLORS['primary']}; border: none; color: white; border-radius: 6px; font-size: 18px; min-width: 30px; max-width: 30px; min-height: 30px; max-height: 30px; }} QPushButton:hover {{ background-color: #357abd; }}")
        new_btn.clicked.connect(self.new_idea)
        layout.addWidget(new_btn)
        layout.addSpacing(4)
        
        min_btn = QPushButton('â”€')
        min_btn.setStyleSheet(ctrl_btn_style)
        min_btn.clicked.connect(self.showMinimized)
        layout.addWidget(min_btn)
        
        self.max_btn = QPushButton('â–¡')
        self.max_btn.setStyleSheet(ctrl_btn_style)
        self.max_btn.clicked.connect(self._toggle_maximize)
        layout.addWidget(self.max_btn)
        
        close_btn = QPushButton('âœ•')
        close_btn.setStyleSheet(ctrl_btn_style + "QPushButton:hover { background-color: #e74c3c; color: white; }")
        close_btn.clicked.connect(self.close)
        layout.addWidget(close_btn)
        
        return titlebar

    # --- åˆ†é¡µé€»è¾‘ ---
    def _set_page(self, page_num):
        if page_num < 1: page_num = 1
        self.current_page = page_num
        self._load_data()

    def _jump_to_page(self):
        text = self.page_input.text().strip()
        if text.isdigit():
            page = int(text)
            self._set_page(page)
        else:
            self.page_input.setText(str(self.current_page))

    def _update_pagination_ui(self):
        self.page_input.setText(str(self.current_page))
        self.total_page_label.setText(f"/ {self.total_pages}")
        
        is_first = (self.current_page <= 1)
        is_last = (self.current_page >= self.total_pages)
        
        self.btn_first.setDisabled(is_first)
        self.btn_prev.setDisabled(is_first)
        self.btn_next.setDisabled(is_last)
        self.btn_last.setDisabled(is_last)

    def _create_middle_panel(self):
        panel = QWidget()
        layout = QVBoxLayout(panel)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        act_bar = QHBoxLayout()
        act_bar.setSpacing(4)
        act_bar.setContentsMargins(20, 10, 20, 10)
        
        self.header_label = QLabel('å…¨éƒ¨æ•°æ®')
        self.header_label.setStyleSheet("font-size:18px;font-weight:bold;")
        act_bar.addWidget(self.header_label)
        
        self.tag_filter_label = QLabel()
        self.tag_filter_label.setStyleSheet(f"background-color: {COLORS['primary']}; color: white; border-radius: 10px; padding: 4px 10px; font-size: 11px; font-weight: bold;")
        self.tag_filter_label.hide()
        act_bar.addWidget(self.tag_filter_label)
        act_bar.addStretch()
        
        self.btns = {}
        for k, i, f in [('pin','ğŸ“Œ',self._do_pin), ('fav','â­',self._do_fav), ('edit','âœï¸',self._do_edit),
                        ('del','ğŸ—‘ï¸',self._do_del), ('rest','â™»ï¸',self._do_restore), ('dest','ğŸ—‘ï¸',self._do_destroy)]:
            b = QPushButton(i)
            b.setStyleSheet(STYLES['btn_icon'])
            b.clicked.connect(f)
            b.setEnabled(False)
            act_bar.addWidget(b)
            self.btns[k] = b
        layout.addLayout(act_bar)
        
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setStyleSheet("border:none")
        self.list_container = ContentContainer()
        self.list_container.cleared.connect(self._clear_all_selections)
        self.list_layout = QVBoxLayout(self.list_container)
        self.list_layout.setAlignment(Qt.AlignTop)
        self.list_layout.setSpacing(10)
        self.list_layout.setContentsMargins(20, 5, 20, 15)
        scroll.setWidget(self.list_container)
        layout.addWidget(scroll)
        
        return panel

    def _create_tag_panel(self):
        panel = QWidget()
        panel.setObjectName("RightPanel")
        panel.setStyleSheet(f"#RightPanel {{ background-color: {COLORS['bg_mid']}; }}")
        panel.setFixedWidth(220)
        
        layout = QVBoxLayout(panel)
        layout.setContentsMargins(15, 15, 15, 15)
        layout.setSpacing(10)
        
        # 1. æ ‡é¢˜åŒº
        header = QHBoxLayout()
        self.tag_panel_title = QLabel('ğŸ·ï¸ æœ€è¿‘æ ‡ç­¾')
        self.tag_panel_title.setStyleSheet("font-size: 14px; font-weight: bold; color: #4a90e2;")
        header.addWidget(self.tag_panel_title)
        
        self.clear_tag_btn = QPushButton('âœ•')
        self.clear_tag_btn.setFixedSize(20, 20)
        self.clear_tag_btn.setStyleSheet(f"QPushButton {{ background-color: transparent; border: 1px solid #666; border-radius: 10px; color: #999; font-size: 12px; }} QPushButton:hover {{ background-color: {COLORS['danger']}; border-color: {COLORS['danger']}; color: white; }}")
        self.clear_tag_btn.setToolTip('æ¸…é™¤æ ‡ç­¾ç­›é€‰ (ESC)')
        self.clear_tag_btn.clicked.connect(self._clear_tag_filter)
        self.clear_tag_btn.hide()
        header.addWidget(self.clear_tag_btn)
        layout.addLayout(header)
        
        # 2. é¡¶éƒ¨è¾“å…¥æ¡†
        self.tag_input = ClickableLineEdit()
        self.tag_input.setPlaceholderText("ğŸ” æœç´¢...")
        self.tag_input.setStyleSheet(f"""
            QLineEdit {{
                background-color: #2D2D2D; 
                border: 1px solid #444;
                border-radius: 16px; /* å…¨åœ†è§’èƒ¶å›Š */
                padding: 6px 12px; 
                font-size: 12px; 
                color: #EEE;
            }}
            QLineEdit:focus {{ 
                border-color: {COLORS['primary']}; 
                background-color: #38383C;
            }}
        """)
        self.tag_input.returnPressed.connect(self._handle_tag_input_return)
        self.tag_input.doubleClicked.connect(self._open_tag_selector_for_selection)
        layout.addWidget(self.tag_input)
        
        # 3. åˆ†å‰²çº¿
        line = QFrame()
        line.setFrameShape(QFrame.HLine)
        line.setFrameShadow(QFrame.Plain)
        line.setStyleSheet(f"background-color: #505050; border: none; max-height: 1px; margin-top: 5px; margin-bottom: 5px;")
        layout.addWidget(line)
        
        # 4. æ ‡ç­¾åˆ—è¡¨åŒºåŸŸ
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setStyleSheet("""
            QScrollArea { border: none; background: transparent; }
            QWidget { background: transparent; }
            QScrollBar:vertical {
                border: none; background: #222; width: 6px; margin: 0;
            }
            QScrollBar::handle:vertical { background: #555; border-radius: 3px; }
        """)
        
        self.tag_list_widget = QWidget()
        # ä½¿ç”¨æµå¼å¸ƒå±€
        self.tag_list_layout = FlowLayout(self.tag_list_widget, margin=0, spacing=8)
        
        scroll.setWidget(self.tag_list_widget)
        layout.addWidget(scroll)
        
        self._refresh_tag_panel()
        return panel

    def _handle_tag_input_return(self):
        text = self.tag_input.text().strip()
        if not text: return
        
        if self.selected_ids:
            self._add_tag_to_selection([text])
            self.tag_input.clear()
        else:
            self._refresh_tag_panel()

    def _open_tag_selector_for_selection(self):
        if self.selected_ids:
            selector = AdvancedTagSelector(self.db, idea_id=None, initial_tags=[])
            selector.tags_confirmed.connect(self._add_tag_to_selection)
            selector.show_at_cursor()

    def _add_tag_to_selection(self, tags):
        if not self.selected_ids or not tags: return
        self.db.add_tags_to_multiple_ideas(list(self.selected_ids), tags)
        self._show_tooltip(f"âœ… å·²æ·»åŠ  {len(tags)} ä¸ªæ ‡ç­¾åˆ° {len(self.selected_ids)} é¡¹")
        self._refresh_all()

    def _remove_tag_from_selection(self, tag_name):
        if not self.selected_ids: return
        self.db.remove_tag_from_multiple_ideas(list(self.selected_ids), tag_name)
        self._refresh_all()

    # ã€æ ¸å¿ƒé€»è¾‘ã€‘æ˜¾ç¤ºå³é”®èœå•
    def _show_tag_context_menu(self, pos, tag_name):
        menu = QMenu(self)
        menu.setStyleSheet(f"""
            QMenu {{ background-color: #2D2D2D; color: #EEE; border: 1px solid #444; }}
            QMenu::item {{ padding: 6px 20px; }}
            QMenu::item:selected {{ background-color: {COLORS['primary']}; }}
        """)
        
        menu.addAction("âœï¸ é‡å‘½å", lambda: self._rename_tag_action(tag_name))
        menu.addSeparator()
        menu.addAction("ğŸ—‘ï¸ åˆ é™¤è¯¥æ ‡ç­¾ (å…¨å±€)", lambda: self._delete_tag_action(tag_name))
        
        menu.exec_(QCursor.pos())

    def _rename_tag_action(self, old_name):
        new_name, ok = self._show_custom_input_dialog("é‡å‘½åæ ‡ç­¾", "è¯·è¾“å…¥æ–°åç§°:", old_name)
        if ok and new_name and new_name.strip():
            self.db.rename_tag(old_name, new_name.strip())
            self._refresh_all()

    def _delete_tag_action(self, tag_name):
        if self._show_custom_confirm_dialog("åˆ é™¤æ ‡ç­¾", f"ç¡®å®šè¦å½»åº•åˆ é™¤æ ‡ç­¾ #{tag_name} å—ï¼Ÿ\næ‰€æœ‰å¼•ç”¨è¯¥æ ‡ç­¾çš„æ•°æ®éƒ½å°†è§£é™¤å…³è”ã€‚"):
            self.db.delete_tag(tag_name)
            self._refresh_all()

    def _show_custom_input_dialog(self, title, label_text, default_text=""):
        dlg = QDialog(self)
        dlg.setWindowFlags(Qt.FramelessWindowHint | Qt.Dialog)
        dlg.setAttribute(Qt.WA_TranslucentBackground)
        dlg.setFixedSize(320, 160)
        
        container = QWidget(dlg)
        container.setGeometry(0, 0, 320, 160)
        container.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_mid']};
                border: 1px solid #444;
                border-radius: 8px;
            }}
        """)
        
        layout = QVBoxLayout(container)
        layout.setContentsMargins(20, 20, 20, 20)
        layout.setSpacing(15)
        
        lbl = QLabel(label_text)
        lbl.setStyleSheet("color: #DDD; font-size: 14px; font-weight: bold; border: none;")
        layout.addWidget(lbl)
        
        inp = QLineEdit(default_text)
        inp.setStyleSheet(f"""
            QLineEdit {{
                background-color: #1E1E1E;
                border: 1px solid #555;
                border-radius: 4px;
                padding: 6px;
                color: #EEE;
                font-size: 13px;
            }}
            QLineEdit:focus {{ border: 1px solid {COLORS['primary']}; }}
        """)
        inp.selectAll()
        layout.addWidget(inp)
        
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        btn_cancel = QPushButton("å–æ¶ˆ")
        btn_cancel.setCursor(Qt.PointingHandCursor)
        btn_cancel.setStyleSheet("""
            QPushButton { background: transparent; color: #AAA; border: none; font-size: 13px; }
            QPushButton:hover { color: #EEE; }
        """)
        btn_cancel.clicked.connect(dlg.reject)
        
        btn_ok = QPushButton("ç¡®å®š")
        btn_ok.setCursor(Qt.PointingHandCursor)
        btn_ok.setStyleSheet(f"""
            QPushButton {{ 
                background-color: {COLORS['primary']}; 
                color: white; 
                border-radius: 4px; 
                padding: 6px 16px;
                font-weight: bold;
            }}
            QPushButton:hover {{ background-color: #357ABD; }}
        """)
        btn_ok.clicked.connect(dlg.accept)
        
        btn_layout.addWidget(btn_cancel)
        btn_layout.addWidget(btn_ok)
        layout.addLayout(btn_layout)
        
        if dlg.exec_() == QDialog.Accepted:
            return inp.text(), True
        return "", False

    def _show_custom_confirm_dialog(self, title, msg):
        dlg = QDialog(self)
        dlg.setWindowFlags(Qt.FramelessWindowHint | Qt.Dialog)
        dlg.setAttribute(Qt.WA_TranslucentBackground)
        dlg.setFixedSize(340, 180)
        
        container = QWidget(dlg)
        container.setGeometry(0, 0, 340, 180)
        container.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_mid']};
                border: 1px solid #444;
                border-radius: 8px;
            }}
        """)
        
        layout = QVBoxLayout(container)
        layout.setContentsMargins(25, 25, 25, 20)
        layout.setSpacing(15)
        
        title_lbl = QLabel(f"âš ï¸  {title}")
        title_lbl.setStyleSheet(f"color: {COLORS['danger']}; font-size: 15px; font-weight: bold; border: none;")
        layout.addWidget(title_lbl)
        
        content_lbl = QLabel(msg)
        content_lbl.setWordWrap(True)
        content_lbl.setStyleSheet("color: #CCC; font-size: 13px; border: none; line-height: 1.4;")
        layout.addWidget(content_lbl)
        
        layout.addStretch()
        
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        btn_cancel = QPushButton("å–æ¶ˆ")
        btn_cancel.setCursor(Qt.PointingHandCursor)
        btn_cancel.setStyleSheet("""
            QPushButton { background: transparent; color: #AAA; border: none; font-size: 13px; }
            QPushButton:hover { color: #EEE; }
        """)
        btn_cancel.clicked.connect(dlg.reject)
        
        btn_del = QPushButton("åˆ é™¤")
        btn_del.setCursor(Qt.PointingHandCursor)
        btn_del.setStyleSheet(f"""
            QPushButton {{ 
                background-color: {COLORS['danger']}; 
                color: white; 
                border-radius: 4px; 
                padding: 6px 16px;
                font-weight: bold;
            }}
            QPushButton:hover {{ background-color: #C0392B; }}
        """)
        btn_del.clicked.connect(dlg.accept)
        
        btn_layout.addWidget(btn_cancel)
        btn_layout.addWidget(btn_del)
        layout.addLayout(btn_layout)
        
        return dlg.exec_() == QDialog.Accepted

    def _refresh_tag_panel(self):
        while self.tag_list_layout.count():
            item = self.tag_list_layout.takeAt(0)
            if item.widget(): item.widget().deleteLater()
            
        if self.selected_ids:
            self.tag_panel_title.setText(f"ğŸ–Šï¸ æ ‡ç­¾ç®¡ç† ({len(self.selected_ids)})")
            self.tag_input.setPlaceholderText("è¾“å…¥æ·»åŠ ... (åŒå‡»æ›´å¤š)")
            self.clear_tag_btn.hide()
            
            tags = self.db.get_union_tags(list(self.selected_ids))
            
            if not tags:
                lbl = QLabel("æ— æ ‡ç­¾")
                lbl.setStyleSheet("color:#666; font-style:italic; margin-top:10px;")
                lbl.setAlignment(Qt.AlignCenter)
                self.tag_list_layout.addItem(self.tag_list_layout.takeAt(0)) 
                self.tag_list_widget.layout().addWidget(lbl)
            else:
                for tag_name in tags:
                    btn = QPushButton(f"{tag_name}  âœ•")
                    btn.setCursor(Qt.PointingHandCursor)
                    btn.setStyleSheet(f"""
                        QPushButton {{
                            background-color: #383838;
                            color: #DDD;
                            border: 1px solid #4D4D4D;
                            border-radius: 14px;
                            padding: 5px 12px;
                            text-align: center;
                            font-size: 12px;
                            font-family: "Segoe UI", "Microsoft YaHei";
                        }}
                        QPushButton:hover {{
                            background-color: {COLORS['danger']};
                            border-color: {COLORS['danger']};
                            color: white;
                        }}
                    """)
                    btn.clicked.connect(lambda _, t=tag_name: self._remove_tag_from_selection(t))
                    self.tag_list_layout.addWidget(btn)
                    
        else:
            self.tag_panel_title.setText("ğŸ·ï¸ æœ€è¿‘æ ‡ç­¾")
            self.tag_input.setPlaceholderText("ğŸ” æœç´¢...")
            if self.current_tag_filter:
                self.clear_tag_btn.show()
            else:
                self.clear_tag_btn.hide()
                
            c = self.db.conn.cursor()
            search_term = self.tag_input.text().strip()
            sql = '''
                SELECT t.name, COUNT(it.idea_id) as cnt, MAX(i.updated_at) as last_used
                FROM tags t 
                JOIN idea_tags it ON t.id = it.tag_id 
                JOIN ideas i ON it.idea_id = i.id 
                WHERE i.is_deleted = 0 
            '''
            params = []
            if search_term:
                sql += " AND t.name LIKE ?"
                params.append(f"%{search_term}%")
            
            sql += ' GROUP BY t.id ORDER BY last_used DESC, cnt DESC, t.name ASC'
            
            c.execute(sql, params)
            tags = c.fetchall()
            
            if not tags:
                return
                
            for row in tags:
                tag_name = row[0]
                count = row[1]
                is_active = (self.current_tag_filter == tag_name)
                icon = "âœ“" if is_active else "ğŸ•’"
                
                btn = QPushButton(f'{icon} {tag_name} ({count})')
                btn.setCursor(Qt.PointingHandCursor)
                
                btn.setContextMenuPolicy(Qt.CustomContextMenu)
                btn.customContextMenuRequested.connect(lambda pos, n=tag_name: self._show_tag_context_menu(pos, n))
                
                bg_color = COLORS['primary'] if is_active else '#333333'
                border_color = COLORS['primary'] if is_active else '#444444'
                text_color = 'white' if is_active else '#CCCCCC'
                
                btn.setStyleSheet(f"""
                    QPushButton {{ 
                        background-color: {bg_color}; 
                        border: 1px solid {border_color}; 
                        border-radius: 14px; 
                        padding: 5px 12px; 
                        text-align: center; 
                        color: {text_color}; 
                        font-size: 12px;
                        font-family: "Segoe UI", "Microsoft YaHei";
                    }} 
                    QPushButton:hover {{ 
                        background-color: {COLORS['primary']};
                        border-color: {COLORS['primary']}; 
                        color: white; 
                    }}
                """)
                btn.clicked.connect(lambda _, t=tag_name: self._filter_by_tag(t))
                self.tag_list_layout.addWidget(btn)

    def _filter_by_tag(self, tag_name):
        if self.current_tag_filter == tag_name:
            self._clear_tag_filter()
        else:
            self.current_tag_filter = tag_name
            self._set_page(1)
            self.tag_filter_label.setText(f'ğŸ·ï¸ {tag_name}')
            self.tag_filter_label.show()
            self.clear_tag_btn.show()
            self._load_data()
            self._refresh_tag_panel()

    def _clear_tag_filter(self):
        self.current_tag_filter = None
        self.tag_filter_label.hide()
        self.clear_tag_btn.hide()
        self._load_data()
        self._refresh_tag_panel()

    # ==================== è°ƒæ•´å¤§å°é€»è¾‘ ====================
    def _get_resize_area(self, pos):
        x, y = pos.x(), pos.y()
        w, h = self.width(), self.height()
        m = self.RESIZE_MARGIN
        
        areas = []
        if x < m: areas.append('left')
        elif x > w - m: areas.append('right')
        if y < m: areas.append('top')
        elif y > h - m: areas.append('bottom')
        return areas
    
    def _set_cursor_for_resize(self, areas):
        if not areas:
            self.setCursor(Qt.ArrowCursor)
            return
        if 'left' in areas and 'top' in areas: self.setCursor(Qt.SizeFDiagCursor)
        elif 'right' in areas and 'bottom' in areas: self.setCursor(Qt.SizeFDiagCursor)
        elif 'left' in areas and 'bottom' in areas: self.setCursor(Qt.SizeBDiagCursor)
        elif 'right' in areas and 'top' in areas: self.setCursor(Qt.SizeBDiagCursor)
        elif 'left' in areas or 'right' in areas: self.setCursor(Qt.SizeHorCursor)
        elif 'top' in areas or 'bottom' in areas: self.setCursor(Qt.SizeVerCursor)

    def mousePressEvent(self, e):
        if e.button() == Qt.LeftButton:
            areas = self._get_resize_area(e.pos())
            if areas:
                self._resize_area = areas
                self._resize_start_pos = e.globalPos()
                self._resize_start_geometry = self.geometry()
                self._drag_pos = None
            elif e.y() < 40:
                self._drag_pos = e.globalPos() - self.frameGeometry().topLeft()
                self._resize_area = None
            else:
                self._drag_pos = None
                self._resize_area = None
            e.accept()

    def mouseMoveEvent(self, e):
        if e.buttons() == Qt.NoButton:
            areas = self._get_resize_area(e.pos())
            self._set_cursor_for_resize(areas)
            e.accept()
            return
        
        if e.buttons() == Qt.LeftButton:
            if self._resize_area:
                delta = e.globalPos() - self._resize_start_pos
                rect = self._resize_start_geometry
                new_rect = rect.adjusted(0, 0, 0, 0)
                if 'left' in self._resize_area:
                    new_left = rect.left() + delta.x()
                    if rect.right() - new_left >= 600:
                        new_rect.setLeft(new_left)
                if 'right' in self._resize_area:
                    new_width = rect.width() + delta.x()
                    if new_width >= 600:
                        new_rect.setWidth(new_width)
                if 'top' in self._resize_area:
                    new_top = rect.top() + delta.y()
                    if rect.bottom() - new_top >= 400:
                        new_rect.setTop(new_top)
                if 'bottom' in self._resize_area:
                    new_height = rect.height() + delta.y()
                    if new_height >= 400:
                        new_rect.setHeight(new_height)
                
                self.setGeometry(new_rect)
                e.accept()
            elif self._drag_pos:
                self.move(e.globalPos() - self._drag_pos)
                e.accept()

    def mouseReleaseEvent(self, e):
        self._drag_pos = None
        self._resize_area = None
        self.setCursor(Qt.ArrowCursor)

    def mouseDoubleClickEvent(self, e):
        if e.y() < 40: self._toggle_maximize()

    def _toggle_maximize(self):
        if self.isMaximized():
            self.showNormal()
            self.max_btn.setText('â–¡')
        else:
            self.showMaximized()
            self.max_btn.setText('â')

    def _add_search_to_history(self):
        search_text = self.search.text().strip()
        if search_text:
            self.search.add_history_entry(search_text)

    def quick_add_idea(self, text):
        raw = text.strip()
        if not raw: return
        lines = raw.split('\n')
        title = lines[0][:25].strip() if lines else "å¿«é€Ÿè®°å½•"
        if len(lines) > 1 or len(lines[0]) > 25: title += "..."
        idea_id = self.db.add_idea(title, raw, COLORS['default_note'], [], None)
        self._show_tag_selector(idea_id)
        self._refresh_all()

    def _show_tag_selector(self, idea_id):
        tag_selector = AdvancedTagSelector(self.db, idea_id, None, self)
        tag_selector.tags_confirmed.connect(lambda tags: self._on_tags_confirmed(idea_id, tags))
        tag_selector.show_at_cursor()

    def _on_tags_confirmed(self, idea_id, tags):
        self._show_tooltip(f'âœ… å·²è®°å½•å¹¶ç»‘å®š {len(tags)} ä¸ªæ ‡ç­¾', 2000)
        self._refresh_all()

    def _set_filter(self, f_type, val):
        self.curr_filter = (f_type, val)
        self.selected_ids.clear()
        self.last_clicked_id = None
        self.current_tag_filter = None
        self.tag_filter_label.hide()
        self.clear_tag_btn.hide()
        titles = {'all':'å…¨éƒ¨æ•°æ®','today':'ä»Šæ—¥æ•°æ®','trash':'å›æ”¶ç«™','favorite':'æˆ‘çš„æ”¶è—'}
        if f_type == 'category':
            cat = next((c for c in self.db.get_categories() if c[0] == val), None)
            self.header_label.setText(f"ğŸ“‚ {cat[1]}" if cat else 'æ–‡ä»¶å¤¹')
        else:
            self.header_label.setText(titles.get(f_type, 'çµæ„Ÿåˆ—è¡¨'))
        self._load_data()
        self._update_ui_state()
        self._refresh_tag_panel()

    def _load_data(self):
        while self.list_layout.count():
            w = self.list_layout.takeAt(0).widget()
            if w: w.deleteLater()
        self.cards = {}
        self.card_ordered_ids = []
        
        # ã€æ ¸å¿ƒè¡¥å……ã€‘æ­¤å¤„å¿…é¡»å…ˆè®¡ç®—æ€»æ•°ï¼Œå¦åˆ™åˆ†é¡µæ§ä»¶å…¨æ˜¯ 1/1
        total_items = self.db.get_ideas_count(self.search.text(), *self.curr_filter, tag_filter=self.current_tag_filter)
        self.total_pages = math.ceil(total_items / self.page_size) if total_items > 0 else 1
        
        # ä¿®æ­£é¡µç èŒƒå›´
        if self.current_page > self.total_pages: self.current_page = self.total_pages
        if self.current_page < 1: self.current_page = 1

        data_list = self.db.get_ideas(self.search.text(), *self.curr_filter, page=self.current_page, page_size=self.page_size, tag_filter=self.current_tag_filter)
        
        if not data_list:
            self.list_layout.addWidget(QLabel("ğŸ”­ ç©ºç©ºå¦‚ä¹Ÿ", alignment=Qt.AlignCenter, styleSheet="color:#666;font-size:16px;margin-top:50px"))
        for d in data_list:
            c = IdeaCard(d, self.db)
            c.get_selected_ids_func = lambda: list(self.selected_ids)
            c.selection_requested.connect(self._handle_selection_request)
            c.double_clicked.connect(self._extract_single)
            c.setContextMenuPolicy(Qt.CustomContextMenu)
            c.customContextMenuRequested.connect(lambda pos, iid=d[0]: self._show_card_menu(iid, pos))
            self.list_layout.addWidget(c)
            self.cards[d[0]] = c
            self.card_ordered_ids.append(d[0])
            
        self._update_pagination_ui() # åˆ·æ–°é¡µç æ˜¾ç¤º
        self._update_ui_state()

    def _show_card_menu(self, idea_id, pos):
        if idea_id not in self.selected_ids:
            self.selected_ids = {idea_id}
            self.last_clicked_id = idea_id
            self._update_all_card_selections()
            self._update_ui_state()
        data = self.db.get_idea(idea_id)
        if not data: return
        menu = QMenu(self)
        menu.setStyleSheet(f"QMenu {{ background-color: {COLORS['bg_mid']}; color: white; border: 1px solid {COLORS['bg_light']}; border-radius: 6px; padding: 4px; }} QMenu::item {{ padding: 8px 20px; border-radius: 4px; }} QMenu::item:selected {{ background-color: {COLORS['primary']}; }} QMenu::separator {{ height: 1px; background: {COLORS['bg_light']}; margin: 4px 0px; }}")
        in_trash = (self.curr_filter[0] == 'trash')
        if not in_trash:
            menu.addAction('âœï¸ ç¼–è¾‘', self._do_edit)
            menu.addAction('ğŸ“‹ æå–(Ctrl+T)', lambda: self._extract_single(idea_id))
            menu.addSeparator()
            menu.addAction('ğŸ“Œ å–æ¶ˆç½®é¡¶' if data[4] else 'ğŸ“Œ ç½®é¡¶', self._do_pin)
            menu.addAction('â˜† å–æ¶ˆæ”¶è—' if data[5] else 'â­ æ”¶è—', self._do_fav)
            menu.addSeparator()
            cat_menu = menu.addMenu('ğŸ“‚ ç§»åŠ¨åˆ°åˆ†ç±»')
            cat_menu.addAction('âš ï¸ æœªåˆ†ç±»', lambda: self._move_to_category(None))
            for cat in self.db.get_categories():
                cat_menu.addAction(f'ğŸ“‚ {cat[1]}', lambda cid=cat[0]: self._move_to_category(cid))
            menu.addSeparator()
            menu.addAction('ğŸ—‘ï¸ ç§»è‡³å›æ”¶ç«™', self._do_del)
        else:
            menu.addAction('â™»ï¸ æ¢å¤', self._do_restore)
            menu.addAction('ğŸ—‘ï¸ æ°¸ä¹…åˆ é™¤', self._do_destroy)
        card = self.cards.get(idea_id)
        if card: menu.exec_(card.mapToGlobal(pos))

    def _move_to_category(self, cat_id):
        if self.selected_ids:
            for iid in self.selected_ids:
                self.db.move_category(iid, cat_id)
            self._refresh_all()
            self._show_tooltip(f'âœ… å·²ç§»åŠ¨ {len(self.selected_ids)} é¡¹')

    def _handle_selection_request(self, iid, is_ctrl, is_shift):
        if is_shift and self.last_clicked_id is not None:
            try:
                start_index = self.card_ordered_ids.index(self.last_clicked_id)
                end_index = self.card_ordered_ids.index(iid)
                min_idx = min(start_index, end_index)
                max_idx = max(start_index, end_index)
                if not is_ctrl: self.selected_ids.clear()
                for idx in range(min_idx, max_idx + 1):
                    self.selected_ids.add(self.card_ordered_ids[idx])
            except ValueError:
                self.selected_ids.clear()
                self.selected_ids.add(iid)
                self.last_clicked_id = iid
        elif is_ctrl:
            if iid in self.selected_ids: self.selected_ids.remove(iid)
            else: self.selected_ids.add(iid)
            self.last_clicked_id = iid
        else:
            self.selected_ids.clear()
            self.selected_ids.add(iid)
            self.last_clicked_id = iid
        self._update_all_card_selections()
        self._update_ui_state()

    def _update_all_card_selections(self):
        for iid, card in self.cards.items():
            card.update_selection(iid in self.selected_ids)

    def _update_ui_state(self):
        in_trash = (self.curr_filter[0] == 'trash')
        selection_count = len(self.selected_ids)
        has_selection = selection_count > 0
        is_single_selection = selection_count == 1
        for k in ['pin', 'fav', 'del']: self.btns[k].setVisible(not in_trash)
        for k in ['rest', 'dest']: self.btns[k].setVisible(in_trash)
        self.btns['edit'].setVisible(not in_trash)
        self.btns['edit'].setEnabled(is_single_selection)
        for k in ['pin', 'fav', 'del', 'rest', 'dest']: self.btns[k].setEnabled(has_selection)
        if is_single_selection and not in_trash:
            idea_id = list(self.selected_ids)[0]
            d = self.db.get_idea(idea_id)
            if d:
                self.btns['pin'].setText('ğŸ“' if not d[4] else 'ğŸ“Œ')
                self.btns['fav'].setText('â˜†' if not d[5] else 'â­')
        else:
            self.btns['pin'].setText('ğŸ“Œ')
            self.btns['fav'].setText('â­')
        self._refresh_tag_panel()

    def _on_new_data_in_category_requested(self, cat_id):
        self._open_edit_dialog(category_id_for_new=cat_id)

    def _open_edit_dialog(self, idea_id=None, category_id_for_new=None):
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤IDçš„çª—å£
        for dialog in self.open_dialogs:
            if hasattr(dialog, 'idea_id') and dialog.idea_id == idea_id and idea_id is not None:
                dialog.activateWindow()
                return

        dialog = EditDialog(self.db, idea_id=idea_id, category_id_for_new=category_id_for_new, parent=None)
        dialog.setAttribute(Qt.WA_DeleteOnClose) # ç¡®ä¿å…³é—­æ—¶åˆ é™¤
        
        # ä½¿ç”¨ data_saved åˆ·æ–°ï¼Œç¡®ä¿å®æ—¶æ€§
        dialog.data_saved.connect(self._refresh_all)
        dialog.finished.connect(lambda: self.open_dialogs.remove(dialog) if dialog in self.open_dialogs else None)

        self.open_dialogs.append(dialog)
        dialog.show()
        dialog.activateWindow()

    def _show_tooltip(self, msg, dur=2000):
        QToolTip.showText(QCursor.pos(), msg, self)
        QTimer.singleShot(dur, QToolTip.hideText)

    def new_idea(self):
        self._open_edit_dialog()

    def _do_edit(self):
        if len(self.selected_ids) == 1:
            idea_id = list(self.selected_ids)[0]
            self._open_edit_dialog(idea_id=idea_id)

    def _do_pin(self):
        if self.selected_ids:
            for iid in self.selected_ids: self.db.toggle_field(iid, 'is_pinned')
            self._load_data()

    def _do_fav(self):
        if self.selected_ids:
            for iid in self.selected_ids: self.db.toggle_field(iid, 'is_favorite')
            self._refresh_all()

    def _do_del(self):
        if self.selected_ids:
            for iid in self.selected_ids: self.db.set_deleted(iid, True)
            self.selected_ids.clear()
            self._refresh_all()

    def _do_restore(self):
        if self.selected_ids:
            for iid in self.selected_ids: self.db.set_deleted(iid, False)
            self.selected_ids.clear()
            self._refresh_all()

    def _do_destroy(self):
        if self.selected_ids and QMessageBox.Yes == QMessageBox.warning(self, 'âš ï¸ è­¦å‘Š', f'ç¡®å®šæ°¸ä¹…åˆ é™¤é€‰ä¸­çš„ {len(self.selected_ids)} é¡¹?\næ­¤æ“ä½œä¸å¯æ¢å¤!', QMessageBox.Yes | QMessageBox.No):
            for iid in self.selected_ids: self.db.delete_permanent(iid)
            self.selected_ids.clear()
            self._refresh_all()

    def _refresh_all(self):
        self._load_data()
        self.sidebar.refresh()
        self._update_ui_state()
        self._refresh_tag_panel()

    def _extract_single(self, idea_id):
        data = self.db.get_idea(idea_id)
        if not data:
            self._show_tooltip('âš ï¸ æ•°æ®ä¸å­˜åœ¨', 1500)
            return
        content_to_copy = data[2] if data[2] else ""
        QApplication.clipboard().setText(content_to_copy)
        preview = content_to_copy.replace('\n', ' ')[:40] + ('...' if len(content_to_copy) > 40 else '')
        self._show_tooltip(f'âœ… å†…å®¹å·²æå–åˆ°å‰ªè´´æ¿\n\nğŸ“‹ {preview}', 2500)

    # ã€è¡¥å……æ–¹æ³•ã€‘_extract_all
    def _extract_all(self):
        data = self.db.get_ideas('', 'all', None)
        if not data:
            self._show_tooltip('ğŸ”­ æš‚æ— æ•°æ®', 1500)
            return
        lines = ['='*60, 'ğŸ’¡ çµæ„Ÿé—ªè®° - å†…å®¹å¯¼å‡º', '='*60, '']
        for d in data:
            lines.append(f"ã€{d[1]}ã€‘")
            if d[4]: lines.append('ğŸ“Œ å·²ç½®é¡¶')
            if d[5]: lines.append('â­ å·²æ”¶è—')
            tags = self.db.get_tags(d[0])
            if tags: lines.append(f"æ ‡ç­¾: {', '.join(tags)}")
            lines.append(f"æ—¶é—´: {d[6]}")
            if d[2]: lines.append(f"\n{d[2]}")
            lines.append('\n'+'-'*60+'\n')
        text = '\n'.join(lines)
        QApplication.clipboard().setText(text)
        self._show_tooltip(f'âœ… å·²æå– {len(data)} æ¡åˆ°å‰ªè´´æ¿!', 2000)

    def _handle_del_key(self):
        self._do_destroy() if self.curr_filter[0] == 'trash' else self._do_del()

    def _handle_extract_key(self):
        if len(self.selected_ids) == 1:
            self._extract_single(list(self.selected_ids)[0])
        elif len(self.selected_ids) > 1:
            self._show_tooltip('âš ï¸ è¯·é€‰æ‹©ä¸€æ¡ç¬”è®°è¿›è¡Œæå–', 1500)
        else:
            self._show_tooltip('âš ï¸ è¯·å…ˆé€‰æ‹©ä¸€æ¡ç¬”è®°', 1500)

    def show_main_window(self):
        self.show()
        self.activateWindow()

    def quit_app(self):
        BackupService.run_backup()
        QApplication.quit()

    def _save_window_state(self):
        save_setting("main_window_geometry_hex", self.saveGeometry().toHex().data().decode())
        save_setting("main_window_maximized", self.isMaximized())

    def save_state(self):
        self._save_window_state()

    def _restore_window_state(self):
        geo_hex = load_setting("main_window_geometry_hex")
        if geo_hex:
            try:
                self.restoreGeometry(QByteArray.fromHex(geo_hex.encode()))
            except Exception:
                self.resize(1300, 700)
        else:
            self.resize(1300, 700)
            
        if load_setting("main_window_maximized", False):
            self.showMaximized()
            self.max_btn.setText('â')

    def closeEvent(self, event):
        self._save_window_state()
        self.closing.emit()
        self.hide()
        event.ignore()
```

## æ–‡ä»¶: preview_service.py

```python
ï»¿# -*- coding: utf-8 -*-
# services/preview_service.py
import os
from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QLabel, QTextEdit, 
                             QWidget, QDesktopWidget, QShortcut, QPushButton, 
                             QGraphicsDropShadowEffect, QSizePolicy, QStyle)
from PyQt5.QtCore import Qt, QPoint, QSize, QEvent, QRect
from PyQt5.QtGui import QPixmap, QKeySequence, QFont, QColor, QPainter, QIcon
from core.config import COLORS, STYLES

class ScalableImageLabel(QLabel):
    """
    æ™ºèƒ½å›¾ç‰‡æ ‡ç­¾ï¼š
    æ”¯æŒéšçª—å£å¤§å°å˜åŒ–è‡ªåŠ¨ç¼©æ”¾å›¾ç‰‡ï¼Œä¿æŒæ¯”ä¾‹å¹¶å±…ä¸­ã€‚
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        self._original_pixmap = None
        self.setSizePolicy(QSizePolicy.Ignored, QSizePolicy.Ignored)
        self.setAlignment(Qt.AlignCenter)
        self.setMinimumSize(200, 200)

    def set_pixmap(self, pixmap):
        self._original_pixmap = pixmap
        self.update()

    def paintEvent(self, event):
        if not self._original_pixmap or self._original_pixmap.isNull():
            text = "æ— æ³•åŠ è½½å›¾ç‰‡"
            painter = QPainter(self)
            painter.setPen(QColor("#666"))
            painter.drawText(self.rect(), Qt.AlignCenter, text)
            return

        painter = QPainter(self)
        painter.setRenderHint(QPainter.Antialiasing)
        painter.setRenderHint(QPainter.SmoothPixmapTransform)

        # è®¡ç®—ç¼©æ”¾åçš„å°ºå¯¸ï¼Œä¿æŒçºµæ¨ªæ¯”
        scaled_size = self._original_pixmap.size().scaled(self.size(), Qt.KeepAspectRatio)
        
        # è®¡ç®—å±…ä¸­ä½ç½®
        x = (self.width() - scaled_size.width()) // 2
        y = (self.height() - scaled_size.height()) // 2
        
        # ç»˜åˆ¶
        target_rect = QRect(x, y, scaled_size.width(), scaled_size.height())
        painter.drawPixmap(target_rect, self._original_pixmap)

class PreviewDialog(QDialog):
    """
    å¢å¼ºç‰ˆé¢„è§ˆçª—å£ï¼šæ”¯æŒæ‹–åŠ¨ã€æœ€å¤§åŒ–ã€æœ€å°åŒ–ã€è‡ªé€‚åº”ç¼©æ”¾ã€å¤šå›¾åˆ‡æ¢
    """
    def __init__(self, mode, data_list, parent=None):
        """
        :param mode: 'text' æˆ– 'gallery' (å›¾ç‰‡é›†åˆ)
        :param data_list: æ•°æ®åˆ—è¡¨ã€‚å¦‚æœæ˜¯æ–‡æœ¬åˆ™æ˜¯ [text_str]ï¼Œå¦‚æœæ˜¯ç”»å»Šåˆ™æ˜¯ [path1, path2, blob...]
        """
        super().__init__(parent)
        # æ™®é€šæ— è¾¹æ¡†çª—å£
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.Window)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setAttribute(Qt.WA_DeleteOnClose) 
        
        # çŠ¶æ€å˜é‡
        self.mode = mode
        self.data_list = data_list
        self.current_index = 0
        self._drag_pos = None
        
        self._init_ui()
        self._setup_shortcuts()
        self._load_current_content()

    def _init_ui(self):
        # 1. æ ¹å¸ƒå±€
        root_layout = QVBoxLayout(self)
        root_layout.setContentsMargins(10, 10, 10, 10)

        # 2. ä¸»å®¹å™¨
        self.container = QWidget()
        self.container.setObjectName("PreviewContainer")
        self.container.setStyleSheet(f"""
            QWidget#PreviewContainer {{
                background-color: {COLORS['bg_dark']};
                border: 1px solid {COLORS['bg_light']};
                border-radius: 8px;
            }}
        """)
        
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(20)
        shadow.setXOffset(0)
        shadow.setYOffset(5)
        shadow.setColor(QColor(0, 0, 0, 150))
        self.container.setGraphicsEffect(shadow)
        root_layout.addWidget(self.container)

        # 3. å†…å®¹å¸ƒå±€
        self.main_layout = QVBoxLayout(self.container)
        self.main_layout.setContentsMargins(0, 0, 0, 0)
        self.main_layout.setSpacing(0)

        # 4. æ ‡é¢˜æ 
        self.title_bar = self._create_title_bar()
        self.main_layout.addWidget(self.title_bar)

        # 5. å†…å®¹æ˜¾ç¤ºåŒºåŸŸ
        self.content_area = QWidget()
        self.content_layout = QVBoxLayout(self.content_area)
        self.content_layout.setContentsMargins(15, 5, 15, 5)
        self.main_layout.addWidget(self.content_area, 1)

        # åˆå§‹åŒ–æ˜¾ç¤ºæ§ä»¶
        self.text_edit = None
        self.image_label = None

        if self.mode == 'text':
            self._init_text_widget()
        else:
            self._init_image_widget()

        # 6. åº•éƒ¨æ§åˆ¶æ  (ä»…å¤šå›¾æ¨¡å¼æ˜¾ç¤º)
        self.control_bar = QWidget()
        ctrl_layout = QHBoxLayout(self.control_bar)
        ctrl_layout.setContentsMargins(20, 5, 20, 10)
        
        self.btn_prev = QPushButton("â—€ ä¸Šä¸€å¼ ")
        self.btn_next = QPushButton("ä¸‹ä¸€å¼  â–¶")
        
        btn_style = f"""
            QPushButton {{
                background-color: {COLORS['bg_mid']};
                border: 1px solid {COLORS['bg_light']};
                color: #ddd;
                padding: 6px 15px;
                border-radius: 4px;
            }}
            QPushButton:hover {{ background-color: {COLORS['primary']}; border-color: {COLORS['primary']}; color: white; }}
        """
        self.btn_prev.setStyleSheet(btn_style)
        self.btn_next.setStyleSheet(btn_style)
        
        self.btn_prev.clicked.connect(self._prev_image)
        self.btn_next.clicked.connect(self._next_image)
        
        ctrl_layout.addWidget(self.btn_prev)
        ctrl_layout.addStretch()
        
        # æç¤ºæ–‡å­—
        hint = QLabel("æŒ‰ [Space] å…³é—­ | [â†/â†’] åˆ‡æ¢")
        hint.setStyleSheet(f"color: {COLORS['text_sub']}; font-size: 11px;")
        ctrl_layout.addWidget(hint)
        
        ctrl_layout.addStretch()
        ctrl_layout.addWidget(self.btn_next)
        
        self.main_layout.addWidget(self.control_bar)
        
        # å¦‚æœåªæœ‰ä¸€å¼ å›¾æˆ–æ–‡æœ¬æ¨¡å¼ï¼Œéšè—æ§åˆ¶æ 
        if len(self.data_list) <= 1:
            self.control_bar.hide()

    def _init_text_widget(self):
        self.text_edit = QTextEdit()
        self.text_edit.setReadOnly(True)
        self.text_edit.setFont(QFont("Microsoft YaHei", 12))
        self.text_edit.setStyleSheet(f"""
            QTextEdit {{
                background-color: transparent;
                border: none;
                color: {COLORS['text']};
                selection-background-color: {COLORS['primary']};
                padding: 10px;
            }}
        """ + STYLES.get('main_window', '').split('/* æ»šåŠ¨æ¡ç¾åŒ– V2 */')[1] if '/* æ»šåŠ¨æ¡ç¾åŒ– V2 */' in STYLES.get('main_window', '') else "")
        self.content_layout.addWidget(self.text_edit)
        self.resize(1130, 740)

    def _init_image_widget(self):
        self.image_label = ScalableImageLabel()
        self.content_layout.addWidget(self.image_label)
        self.resize(1130, 740)

    def _create_title_bar(self):
        title_bar = QWidget()
        title_bar.setFixedHeight(36)
        title_bar.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_mid']};
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                border-bottom: 1px solid {COLORS['bg_light']};
            }}
        """)
        
        layout = QHBoxLayout(title_bar)
        layout.setContentsMargins(10, 0, 10, 0)
        
        self.title_label = QLabel("é¢„è§ˆ")
        self.title_label.setStyleSheet("font-weight: bold; color: #ddd; border: none; background: transparent;")
        layout.addWidget(self.title_label)
        layout.addStretch()

        btn_style = "QPushButton { background: transparent; border: none; color: #aaa; border-radius: 4px; font-family: Arial; font-size: 14px; } QPushButton:hover { background-color: rgba(255, 255, 255, 0.1); color: white; }"
        
        btn_min = QPushButton("â”€")
        btn_min.setFixedSize(28, 28)
        btn_min.setStyleSheet(btn_style)
        btn_min.clicked.connect(self.showMinimized)
        
        self.btn_max = QPushButton("â–¡")
        self.btn_max.setFixedSize(28, 28)
        self.btn_max.setStyleSheet(btn_style)
        self.btn_max.clicked.connect(self._toggle_maximize)

        btn_close = QPushButton("Ã—")
        btn_close.setFixedSize(28, 28)
        btn_close.setStyleSheet("QPushButton { background: transparent; border: none; color: #aaa; border-radius: 4px; font-size: 16px; } QPushButton:hover { background-color: #e74c3c; color: white; }")
        btn_close.clicked.connect(self.close)

        layout.addWidget(btn_min)
        layout.addWidget(self.btn_max)
        layout.addWidget(btn_close)
        return title_bar

    def _load_current_content(self):
        """æ ¸å¿ƒæ–¹æ³•ï¼šæ ¹æ® index åŠ è½½æ•°æ®"""
        if not self.data_list: return
        
        current_data = self.data_list[self.current_index]
        total = len(self.data_list)
        
        # æ›´æ–°æ ‡é¢˜
        if self.mode == 'text':
            self.title_label.setText("ğŸ“ æ–‡æœ¬é¢„è§ˆ")
            self.text_edit.setText(str(current_data))
        else:
            self.title_label.setText(f"ğŸ–¼ï¸ å›¾ç‰‡é¢„è§ˆ [{self.current_index + 1}/{total}]")
            self._show_image(current_data)

        # å±…ä¸­çª—å£ (ä»…åœ¨ç¬¬ä¸€æ¬¡æ˜¾ç¤ºæ—¶)
        if not self.isVisible():
            self._center_on_screen()

    def _show_image(self, data):
        """æ˜¾ç¤ºå•å¼ å›¾ç‰‡ï¼Œæ”¯æŒè·¯å¾„æˆ–äºŒè¿›åˆ¶æ•°æ®"""
        pixmap = QPixmap()
        
        if isinstance(data, bytes):
            pixmap.loadFromData(data)
        elif isinstance(data, str) and os.path.exists(data):
            pixmap.load(data)
        
        self.image_label.set_pixmap(pixmap)

    def _center_on_screen(self):
        screen = QDesktopWidget().screenNumber(QDesktopWidget().cursor().pos())
        center = QDesktopWidget().screenGeometry(screen).center()
        self.move(center.x() - self.width() // 2, center.y() - self.height() // 2)

    def _toggle_maximize(self):
        if self.isMaximized():
            self.showNormal()
            self.btn_max.setText("â–¡")
            self.layout().setContentsMargins(10, 10, 10, 10)
        else:
            self.showMaximized()
            self.btn_max.setText("â")
            self.layout().setContentsMargins(0, 0, 0, 0)

    def _prev_image(self):
        if self.current_index > 0:
            self.current_index -= 1
            self._load_current_content()

    def _next_image(self):
        if self.current_index < len(self.data_list) - 1:
            self.current_index += 1
            self._load_current_content()

    def _setup_shortcuts(self):
        QShortcut(QKeySequence(Qt.Key_Escape), self, self.close)
        QShortcut(QKeySequence(Qt.Key_Space), self, self.close)
        
        # å·¦å³é”®åˆ‡æ¢å›¾ç‰‡
        QShortcut(QKeySequence(Qt.Key_Left), self, self._prev_image)
        QShortcut(QKeySequence(Qt.Key_Right), self, self._next_image)

    # --- æ‹–åŠ¨é€»è¾‘ ---
    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton and event.y() < 50:
            self._drag_pos = event.globalPos() - self.frameGeometry().topLeft()
            event.accept()
        else:
            super().mousePressEvent(event)

    def mouseMoveEvent(self, event):
        if event.buttons() == Qt.LeftButton and self._drag_pos:
            if not self.isMaximized():
                self.move(event.globalPos() - self._drag_pos)
                event.accept()
        else:
            super().mouseMoveEvent(event)

    def mouseReleaseEvent(self, event):
        self._drag_pos = None
        super().mouseReleaseEvent(event)
        
    def mouseDoubleClickEvent(self, event):
        if event.y() < 50:
            self._toggle_maximize()


class PreviewService:
    def __init__(self, db_manager, parent_window):
        self.db = db_manager
        self.parent = parent_window
        self.current_dialog = None

    def toggle_preview(self, selected_ids):
        if self.current_dialog and self.current_dialog.isVisible():
            self.current_dialog.close()
            self.current_dialog = None
            return

        if not selected_ids: return
        if len(selected_ids) != 1:
            self._show_tooltip('âš ï¸ åªèƒ½é¢„è§ˆå•ä¸ªé¡¹ç›®')
            return

        idea_id = list(selected_ids)[0]
        self._open_preview(idea_id)

    def _open_preview(self, idea_id):
        idea = self.db.get_idea(idea_id, include_blob=True)
        if not idea: return

        # è§£ææ•°æ®
        # å­—æ®µ: 2=content, 10=item_type, 11=data_blob
        content = idea[2]
        try:
            item_type = idea[10] if len(idea) > 10 else 'text'
            data_blob = idea[11] if len(idea) > 11 else None
        except IndexError:
            item_type = 'text'
            data_blob = None

        mode = 'text'
        data_list = []

        # 1. æ•°æ®åº“ Blob å›¾ç‰‡
        if item_type == 'image' and data_blob:
            mode = 'gallery'
            data_list = [data_blob]
        
        # 2. æ–‡æœ¬å†…å®¹åˆ†æ (æ ¸å¿ƒä¿®å¤é€»è¾‘)
        elif content:
            # æ£€æŸ¥æ˜¯å¦åŒ…å«åˆ†å· (å¤šæ–‡ä»¶è·¯å¾„ç‰¹å¾)
            potential_paths = content.split(';')
            valid_images = []
            img_exts = {'.png', '.jpg', '.jpeg', '.bmp', '.gif', '.webp', '.ico', '.svg', '.tif'}
            
            for p in potential_paths:
                p = p.strip()
                if p and os.path.exists(p):
                    ext = os.path.splitext(p)[1].lower()
                    if ext in img_exts:
                        valid_images.append(p)
            
            if valid_images:
                mode = 'gallery'
                data_list = valid_images
            else:
                mode = 'text'
                data_list = [content]
        else:
            self._show_tooltip('âš ï¸ å†…å®¹ä¸ºç©º')
            return

        # åˆ›å»ºçª—å£
        self.current_dialog = PreviewDialog(mode, data_list, self.parent)
        self.current_dialog.finished.connect(self._on_dialog_closed)
        self.current_dialog.show()

    def _on_dialog_closed(self):
        self.current_dialog = None

    def _show_tooltip(self, msg):
        if hasattr(self.parent, '_show_tooltip'):
            self.parent._show_tooltip(msg, 1500)
```

## æ–‡ä»¶: quick_window.py

```python
# -*- coding: utf-8 -*-
import sys
import os
import ctypes
from ctypes import wintypes
import time
import datetime
import subprocess
from PyQt5.QtWidgets import (QApplication, QWidget, QVBoxLayout, QListWidget, QLineEdit, 
                             QListWidgetItem, QHBoxLayout, QTreeWidget, QTreeWidgetItem, 
                             QPushButton, QStyle, QAction, QSplitter, QGraphicsDropShadowEffect, 
                             QLabel, QTreeWidgetItemIterator, QShortcut, QAbstractItemView, QMenu,
                             QColorDialog, QInputDialog, QMessageBox)
from PyQt5.QtCore import Qt, QTimer, QPoint, QRect, QSettings, QUrl, QMimeData, pyqtSignal, QObject, QSize, QByteArray
from PyQt5.QtGui import QImage, QColor, QCursor, QPixmap, QPainter, QIcon, QKeySequence, QDrag
from services.preview_service import PreviewService
from ui.dialogs import EditDialog
from ui.advanced_tag_selector import AdvancedTagSelector
from core.config import COLORS
from core.settings import load_setting, save_setting

# =================================================================================
#   Win32 API å®šä¹‰
# =================================================================================
if sys.platform == "win32":
    user32 = ctypes.windll.user32
    kernel32 = ctypes.windll.kernel32
    KEYEVENTF_KEYUP = 0x0002
    VK_CONTROL = 0x11
    VK_V = 0x56
    HWND_TOPMOST = -1
    HWND_NOTOPMOST = -2
    SWP_NOMOVE = 0x0002
    SWP_NOSIZE = 0x0001
    SWP_NOACTIVATE = 0x0010
    SWP_FLAGS = SWP_NOMOVE | SWP_NOSIZE | SWP_NOACTIVATE
    class GUITHREADINFO(ctypes.Structure):
        _fields_ = [
            ("cbSize", wintypes.DWORD),
            ("flags", wintypes.DWORD),
            ("hwndActive", wintypes.HWND),
            ("hwndFocus", wintypes.HWND),      
            ("hwndCapture", wintypes.HWND),
            ("hwndMenuOwner", wintypes.HWND),
            ("hwndMoveSize", wintypes.HWND),
            ("hwndCaret", wintypes.HWND),
            ("rcCaret", wintypes.RECT)
        ]
    user32.GetGUIThreadInfo.argtypes = [wintypes.DWORD, ctypes.POINTER(GUITHREADINFO)]
    user32.GetGUIThreadInfo.restype = wintypes.BOOL
    user32.SetFocus.argtypes = [wintypes.HWND]
    user32.SetFocus.restype = wintypes.HWND
    user32.SetWindowPos.argtypes = [wintypes.HWND, wintypes.HWND, ctypes.c_int, ctypes.c_int, ctypes.c_int, ctypes.c_int, ctypes.c_uint]
else:
    user32 = None
    kernel32 = None

def log(message):
    pass

try:
    from data.db_manager import DatabaseManager as DBManager
    from services.clipboard import ClipboardManager
except ImportError:
    class DBManager:
        def get_items(self, **kwargs): return []
        def get_partitions_tree(self): return []
        def get_partition_item_counts(self): return {}
    class ClipboardManager(QObject):
        data_captured = pyqtSignal()
        def __init__(self, db_manager):
            super().__init__()
            self.db = db_manager
        def process_clipboard(self, mime_data, cat_id=None): pass

# =================================================================================
#   è‡ªå®šä¹‰å¢å¼ºæ§ä»¶
# =================================================================================

class DraggableListWidget(QListWidget):
    """æ”¯æŒæ‹–å‡ºæ•°æ®çš„åˆ—è¡¨"""
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setDragEnabled(True)

    def startDrag(self, supportedActions):
        item = self.currentItem()
        if not item: return
        
        data = item.data(Qt.UserRole)
        if not data: return
        idea_id = data[0]

        mime = QMimeData()
        mime.setData('application/x-idea-id', str(idea_id).encode())
        
        drag = QDrag(self)
        drag.setMimeData(mime)
        drag.exec_(Qt.MoveAction)

class DropTreeWidget(QTreeWidget):
    """æ”¯æŒæ¥æ”¶æ•°æ®çš„åˆ†ç±»æ ‘ï¼ˆæ”¯æŒæ‹–å…¥å†…å®¹ + æ‹–æ‹½æ’åºï¼‰"""
    item_dropped = pyqtSignal(int, int) # id, cat_id
    order_changed = pyqtSignal() # æ’åºæ”¹å˜ä¿¡å·

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAcceptDrops(True)
        self.setDragEnabled(True)
        self.setDragDropMode(QAbstractItemView.InternalMove)
        self.setDropIndicatorShown(True)

    def dragEnterEvent(self, event):
        # 1. ä¹Ÿæ˜¯å†…éƒ¨æ‹–æ‹½é‡æ’åº? (Standard TreeWidget mime type)
        if event.source() == self:
            super().dragEnterEvent(event)
            event.accept()
        # 2. æ˜¯æ‹–å…¥çš„ç¬”è®°å†…å®¹?
        elif event.mimeData().hasFormat('application/x-idea-id'):
            event.accept()
        else:
            event.ignore()

    def dragMoveEvent(self, event):
        # 1. å†…éƒ¨é‡æ’åº
        if event.source() == self:
            super().dragMoveEvent(event)
        # 2. æ‹–å…¥ç¬”è®°
        elif event.mimeData().hasFormat('application/x-idea-id'):
            item = self.itemAt(event.pos())
            if item:
                data = item.data(0, Qt.UserRole)
                if data and data.get('type') in ['partition', 'favorite']:
                    self.setCurrentItem(item)
                    event.accept()
                    return
            event.ignore()
        else:
            event.ignore()

    def dropEvent(self, event):
        # 1. å¤„ç†æ‹–å…¥çš„ç¬”è®°
        if event.mimeData().hasFormat('application/x-idea-id'):
            try:
                idea_id = int(event.mimeData().data('application/x-idea-id'))
                item = self.itemAt(event.pos())
                if item:
                    data = item.data(0, Qt.UserRole)
                    if data and data.get('type') in ['partition', 'favorite']:
                        cat_id = data.get('id')
                        self.item_dropped.emit(idea_id, cat_id)
                        event.acceptProposedAction()
            except Exception as e:
                pass
        # 2. å¤„ç†å†…éƒ¨é‡æ’åº (è°ƒç”¨çˆ¶ç±»é€»è¾‘)
        elif event.source() == self:
            super().dropEvent(event)
            self.order_changed.emit()
            event.accept()

# =================================================================================
#   æ ·å¼è¡¨
# =================================================================================
DARK_STYLESHEET = """
QWidget#Container {
    background-color: #1e1e1e;
    border: 1px solid #333333; 
    border-radius: 8px;    
}
QWidget {
    color: #cccccc;
    font-family: "Microsoft YaHei", "Segoe UI Emoji";
    font-size: 14px;
}
QLabel#TitleLabel {
    color: #858585;
    font-weight: bold;
    font-size: 15px;
    padding-left: 5px;
}
QListWidget, QTreeWidget {
    border: none;
    background-color: #1e1e1e;
    alternate-background-color: #252526;
    outline: none;
}
QListWidget::item { padding: 8px; border: none; }
QListWidget::item:selected, QTreeWidget::item:selected {
    background-color: #4a90e2; color: #FFFFFF;
}
QListWidget::item:hover { background-color: #444444; }

QSplitter::handle { background-color: #333333; width: 2px; }
QSplitter::handle:hover { background-color: #4a90e2; }

QLineEdit {
    background-color: #252526;
    border: 1px solid #333333;
    border-radius: 4px;
    padding: 6px;
    font-size: 16px;
}

QPushButton#ToolButton, QPushButton#MinButton, QPushButton#CloseButton, QPushButton#PinButton, QPushButton#MaxButton { 
    background-color: transparent; 
    border-radius: 4px; 
    padding: 0px;  
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}
QPushButton#ToolButton:hover, QPushButton#MinButton:hover, QPushButton#MaxButton:hover { background-color: #444; }
QPushButton#ToolButton:checked, QPushButton#MaxButton:checked { background-color: #555; border: 1px solid #666; }
QPushButton#CloseButton:hover { background-color: #E81123; color: white; }
QPushButton#PinButton:hover { background-color: #444; }
QPushButton#PinButton:checked { background-color: #0078D4; color: white; border: 1px solid #005A9E; }
"""


# å¯åŒå‡»çš„è¾“å…¥æ¡†ï¼Œç”¨äºè§¦å‘æ ‡ç­¾é€‰æ‹©å™¨
class ClickableLineEdit(QLineEdit):
    doubleClicked = pyqtSignal()
    def mouseDoubleClickEvent(self, event):
        self.doubleClicked.emit()
        super().mouseDoubleClickEvent(event)

class QuickWindow(QWidget):
    RESIZE_MARGIN = 18 
    open_main_window_requested = pyqtSignal()

    def __init__(self, db_manager):
        super().__init__()
        self.db = db_manager
        self.settings = QSettings("MyTools", "RapidNotes")
        
        self.m_drag = False
        self.m_DragPosition = QPoint()
        self.resize_area = None
        
        self._is_pinned = False
        self.last_active_hwnd = None
        self.last_focus_hwnd = None
        self.last_thread_id = None
        self.my_hwnd = None
        
        self.cm = ClipboardManager(self.db)
        self.clipboard = QApplication.clipboard()
        self.clipboard.dataChanged.connect(self.on_clipboard_changed)
        self.cm.data_captured.connect(self._update_list)
        self._processing_clipboard = False
        
        self.open_dialogs = []
        
        self.preview_service = PreviewService(self.db, self)
        
        self._init_ui()
        self._setup_shortcuts()
        self._restore_window_state()
        
        self.setMouseTracking(True)
        self.container.setMouseTracking(True)
        
        self.monitor_timer = QTimer(self)
        self.monitor_timer.timeout.connect(self._monitor_foreground_window)
        if user32:
            self.monitor_timer.start(200)

        self.search_timer = QTimer(self)
        self.search_timer.setSingleShot(True)
        self.search_timer.timeout.connect(self._update_list)
        
        self.search_box.textChanged.connect(self._on_search_text_changed)
        self.list_widget.itemActivated.connect(self._on_item_activated)
        
        self.list_widget.setContextMenuPolicy(Qt.CustomContextMenu)
        self.list_widget.customContextMenuRequested.connect(self._show_list_context_menu)
        
        self.partition_tree.currentItemChanged.connect(self._on_partition_selection_changed)
        self.partition_tree.item_dropped.connect(self._handle_category_drop)
        
        # å¯ç”¨å³é”®èœå•
        self.partition_tree.setContextMenuPolicy(Qt.CustomContextMenu)
        self.partition_tree.customContextMenuRequested.connect(self._show_partition_context_menu)
        self.partition_tree.order_changed.connect(self._save_partition_order)
        
        self.clear_action.triggered.connect(self.search_box.clear)
        self.search_box.textChanged.connect(lambda text: self.clear_action.setVisible(bool(text)))
        self.clear_action.setVisible(False)
        
        self.btn_stay_top.clicked.connect(self._toggle_stay_on_top)
        self.btn_toggle_side.clicked.connect(self._toggle_partition_panel)
        self.btn_open_full.clicked.connect(self.open_main_window_requested)
        self.btn_minimize.clicked.connect(self.showMinimized) 
        self.btn_close.clicked.connect(self.close)
        
        self._update_partition_tree()
        self._update_list()
        
        self.partition_tree.currentItemChanged.connect(self._update_partition_status_display)

    def _init_ui(self):
        self.setWindowTitle("å¿«é€Ÿç¬”è®°")
        self.resize(830, 630)
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setWindowFlags(Qt.FramelessWindowHint | Qt.Window)
        
        self.root_layout = QVBoxLayout(self)
        self.root_layout.setContentsMargins(15, 15, 15, 15) 
        
        self.container = QWidget()
        self.container.setObjectName("Container")
        self.root_layout.addWidget(self.container)
        
        shadow = QGraphicsDropShadowEffect(self)
        shadow.setBlurRadius(25)
        shadow.setXOffset(0)
        shadow.setYOffset(4)
        shadow.setColor(QColor(0, 0, 0, 100))
        self.container.setGraphicsEffect(shadow)
        
        self.setStyleSheet(DARK_STYLESHEET)
        
        self.main_layout = QVBoxLayout(self.container)
        self.main_layout.setContentsMargins(10, 10, 10, 10)
        self.main_layout.setSpacing(10)
        
        # --- Title Bar ---
        title_bar_layout = QHBoxLayout()
        title_bar_layout.setContentsMargins(0, 0, 0, 0)
        title_bar_layout.setSpacing(5)
        
        self.title_label = QLabel("âš¡ï¸ å¿«é€Ÿç¬”è®°")
        self.title_label.setObjectName("TitleLabel")
        title_bar_layout.addWidget(self.title_label)
        
        title_bar_layout.addStretch()
        
        self.btn_stay_top = QPushButton("ğŸ“Œ", self)
        self.btn_stay_top.setObjectName("PinButton")
        self.btn_stay_top.setToolTip("ä¿æŒç½®é¡¶")
        self.btn_stay_top.setCheckable(True)
        self.btn_stay_top.setFixedSize(32, 32)

        self.btn_toggle_side = QPushButton("ğŸ‘ï¸", self)
        self.btn_toggle_side.setObjectName("ToolButton")
        self.btn_toggle_side.setToolTip("æ˜¾ç¤º/éšè—ä¾§è¾¹æ ")
        self.btn_toggle_side.setFixedSize(32, 32)
        
        self.btn_open_full = QPushButton(self)
        self.btn_open_full.setObjectName("MaxButton")
        self.btn_open_full.setToolTip("æ‰“å¼€ä¸»ç¨‹åºç•Œé¢")
        self.btn_open_full.setIcon(self.style().standardIcon(QStyle.SP_TitleBarMaxButton))
        self.btn_open_full.setFixedSize(32, 32)

        self.btn_minimize = QPushButton("â€”", self)
        self.btn_minimize.setObjectName("MinButton")
        self.btn_minimize.setToolTip("æœ€å°åŒ–")
        self.btn_minimize.setFixedSize(32, 32)
        
        self.btn_close = QPushButton(self)
        self.btn_close.setObjectName("CloseButton")
        self.btn_close.setToolTip("å…³é—­")
        self.btn_close.setIcon(self.style().standardIcon(QStyle.SP_TitleBarCloseButton))
        self.btn_close.setFixedSize(32, 32)
        
        title_bar_layout.addWidget(self.btn_stay_top)
        title_bar_layout.addWidget(self.btn_toggle_side)
        title_bar_layout.addWidget(self.btn_open_full) 
        title_bar_layout.addWidget(self.btn_minimize)
        title_bar_layout.addWidget(self.btn_close)
        
        self.main_layout.addLayout(title_bar_layout)
        
        # --- Search Bar ---
        self.search_box = QLineEdit(self)
        self.search_box.setPlaceholderText("æœç´¢å‰ªè´´æ¿å†å²...")
        self.clear_action = QAction(self)
        self.clear_action.setIcon(self.style().standardIcon(QStyle.SP_DialogCloseButton))
        self.search_box.addAction(self.clear_action, QLineEdit.TrailingPosition)
        
        self.main_layout.addWidget(self.search_box)
        
        # --- Splitter Content ---
        content_widget = QWidget()
        content_layout = QHBoxLayout(content_widget)
        content_layout.setContentsMargins(0, 0, 0, 0)
        
        self.splitter = QSplitter(Qt.Horizontal)
        self.splitter.setHandleWidth(4)
        
        self.list_widget = DraggableListWidget()
        self.list_widget.setFocusPolicy(Qt.StrongFocus)
        self.list_widget.setAlternatingRowColors(True)
        self.list_widget.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.list_widget.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.list_widget.setIconSize(QSize(120, 90))

        self.partition_tree = DropTreeWidget()
        self.partition_tree.setHeaderHidden(True)
        self.partition_tree.setFocusPolicy(Qt.NoFocus)
        self.partition_tree.setVerticalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        self.partition_tree.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        
        self.splitter.addWidget(self.list_widget)
        self.splitter.addWidget(self.partition_tree)
        self.splitter.setStretchFactor(0, 1)
        self.splitter.setStretchFactor(1, 0)
        self.splitter.setSizes([550, 150])
        
        content_layout.addWidget(self.splitter)
        self.main_layout.addWidget(content_widget, 1)

        # --- Status Bar ---
        self.partition_status_label = QLabel("å½“å‰åˆ†åŒº: å…¨éƒ¨æ•°æ®")
        self.partition_status_label.setObjectName("PartitionStatusLabel")
        self.partition_status_label.setStyleSheet("font-size: 11px; color: #888; padding-left: 5px;")
        self.main_layout.addWidget(self.partition_status_label)
        self.partition_status_label.hide()

    # --- å¿«æ·é”®è®¾ç½® ---
    def _setup_shortcuts(self):
        QShortcut(QKeySequence("Ctrl+F"), self, self.search_box.setFocus)
        QShortcut(QKeySequence("Delete"), self, self._do_delete_selected)
        QShortcut(QKeySequence("Ctrl+E"), self, self._do_toggle_favorite)
        QShortcut(QKeySequence("Ctrl+P"), self, self._do_toggle_pin)
        QShortcut(QKeySequence("Ctrl+W"), self, self.close)
        
        # ç›‘å¬ç©ºæ ¼é”®ï¼šé¢„è§ˆ
        self.space_shortcut = QShortcut(QKeySequence(Qt.Key_Space), self)
        self.space_shortcut.setContext(Qt.WindowShortcut)
        self.space_shortcut.activated.connect(self._do_preview)

    def _do_preview(self):
        iid = self._get_selected_id()
        if iid:
            self.preview_service.toggle_preview({iid})

    # --- å³é”®èœå•é€»è¾‘ ---
    def _show_list_context_menu(self, pos):
        item = self.list_widget.itemAt(pos)
        if not item: return

        data = item.data(Qt.UserRole)
        if not data: return
        
        is_pinned = data[4]
        is_fav = data[5]

        menu = QMenu(self)
        menu.setStyleSheet("""
            QMenu { background-color: #2D2D2D; color: #EEE; border: 1px solid #444; border-radius: 4px; padding: 4px; }
            QMenu::item { padding: 6px 20px; border-radius: 3px; }
            QMenu::item:selected { background-color: #4a90e2; color: white; }
            QMenu::separator { background-color: #444; height: 1px; margin: 4px 0px; }
        """)

        action_preview = menu.addAction("ğŸ‘ï¸ é¢„è§ˆ (Space)")
        action_preview.triggered.connect(self._do_preview)
        
        menu.addSeparator()

        action_copy = menu.addAction("ğŸ“‹ å¤åˆ¶å†…å®¹")
        action_copy.triggered.connect(lambda: self._copy_item_content(data))
        
        menu.addSeparator()

        action_pin = menu.addAction("ğŸ“Œ å–æ¶ˆç½®é¡¶" if is_pinned else "ğŸ“Œ ç½®é¡¶")
        action_pin.triggered.connect(self._do_toggle_pin)

        action_fav = menu.addAction("â­ å–æ¶ˆæ”¶è—" if is_fav else "â­ æ”¶è—")
        action_fav.triggered.connect(self._do_toggle_favorite)
        
        # ã€æ–°å¢ã€‘ç¼–è¾‘é€‰é¡¹
        action_edit = menu.addAction("âœï¸ ç¼–è¾‘")
        action_edit.triggered.connect(self._do_edit_selected)

        menu.addSeparator()

        action_del = menu.addAction("ğŸ—‘ï¸ åˆ é™¤")
        action_del.triggered.connect(self._do_delete_selected)

        menu.exec_(self.list_widget.mapToGlobal(pos))

    def _copy_item_content(self, data):
        item_type_idx = 10
        item_type = data[item_type_idx] if len(data) > item_type_idx else 'text'
        content = data[2]
        if item_type == 'text' and content:
            QApplication.clipboard().setText(content)

    # --- é€»è¾‘å¤„ç† ---

    def _get_selected_id(self):
        item = self.list_widget.currentItem()
        if not item: return None
        data = item.data(Qt.UserRole)
        if data: return data[0] 
        return None
    
    # ã€æ–°å¢ã€‘ç¼–è¾‘åŠŸèƒ½
    def _do_edit_selected(self):
        iid = self._get_selected_id()
        if iid:
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤IDçš„çª—å£
            for dialog in self.open_dialogs:
                if hasattr(dialog, 'idea_id') and dialog.idea_id == iid:
                    dialog.activateWindow()
                    return

            dialog = EditDialog(self.db, idea_id=iid, parent=None)
            dialog.setAttribute(Qt.WA_DeleteOnClose)
            
            # åˆ·æ–°åˆ—è¡¨
            dialog.data_saved.connect(self._update_list)
            dialog.data_saved.connect(self._update_partition_tree)
            
            dialog.finished.connect(lambda: self.open_dialogs.remove(dialog) if dialog in self.open_dialogs else None)
            
            self.open_dialogs.append(dialog)
            dialog.show()
            dialog.activateWindow()

    def _do_delete_selected(self):
        iid = self._get_selected_id()
        if iid:
            self.db.set_deleted(iid, True)
            self._update_list()
            self._update_partition_tree()

    def _do_toggle_favorite(self):
        iid = self._get_selected_id()
        if iid:
            self.db.toggle_field(iid, 'is_favorite')
            self._update_list() 

    def _do_toggle_pin(self):
        iid = self._get_selected_id()
        if iid:
            self.db.toggle_field(iid, 'is_pinned')
            self._update_list()

    def _handle_category_drop(self, idea_id, cat_id):
        if cat_id == -20: # æ”¶è—
             self.db.set_favorite(idea_id, True)
        else:
             self.db.move_category(idea_id, cat_id)
        self._update_list()
        self._update_partition_tree()

    def _save_partition_order(self):
        update_list = []
        
        def iterate_items(parent_item, parent_id):
            for i in range(parent_item.childCount()):
                item = parent_item.child(i)
                data = item.data(0, Qt.UserRole)
                
                # ä»…å¤„ç†åˆ†åŒºç±»å‹çš„èŠ‚ç‚¹
                if data and data.get('type') == 'partition':
                    cat_id = data.get('id')
                    update_list.append((cat_id, parent_id, i))
                    
                    if item.childCount() > 0:
                        iterate_items(item, cat_id)
                        
        iterate_items(self.partition_tree.invisibleRootItem(), None)
        
        if update_list:
            self.db.save_category_order(update_list)

    # --- Restore & Save State ---
    def _restore_window_state(self):
        geo_hex = load_setting("quick_window_geometry_hex")
        if geo_hex:
            try:
                self.restoreGeometry(QByteArray.fromHex(geo_hex.encode()))
            except: pass
        else:
            screen_geo = QApplication.desktop().screenGeometry()
            win_geo = self.geometry()
            x = (screen_geo.width() - win_geo.width()) // 2
            y = (screen_geo.height() - win_geo.height()) // 2
            self.move(x, y)
            
        splitter_hex = load_setting("quick_window_splitter_hex")
        if splitter_hex:
            try:
                self.splitter.restoreState(QByteArray.fromHex(splitter_hex.encode()))
            except: pass

        is_hidden = load_setting("partition_panel_hidden", False)
        self.partition_tree.setHidden(is_hidden)
        self._update_partition_status_display()
        
        # ã€å…³é”®ä¿®å¤ã€‘åŠ è½½ç½®é¡¶çŠ¶æ€
        is_pinned = load_setting("quick_window_pinned", False)
        self.btn_stay_top.setChecked(is_pinned)
        self._toggle_stay_on_top() # ç«‹å³åº”ç”¨

    def save_state(self):
        """æ˜¾å¼ä¿å­˜çŠ¶æ€"""
        geo_hex = self.saveGeometry().toHex().data().decode()
        save_setting("quick_window_geometry_hex", geo_hex)
        
        split_hex = self.splitter.saveState().toHex().data().decode()
        save_setting("quick_window_splitter_hex", split_hex)
        
        is_hidden = self.partition_tree.isHidden()
        save_setting("partition_panel_hidden", is_hidden)
        
        # ã€å…³é”®ä¿®å¤ã€‘ä¿å­˜ç½®é¡¶çŠ¶æ€
        save_setting("quick_window_pinned", self.btn_stay_top.isChecked())

    def closeEvent(self, event):
        self.save_state()
        self.hide()
        event.ignore()

    # --- Mouse Logic ---
    def _get_resize_area(self, pos):
        x, y = pos.x(), pos.y()
        w, h = self.width(), self.height()
        m = self.RESIZE_MARGIN
        areas = []
        if x < m: areas.append('left')
        elif x > w - m: areas.append('right')
        if y < m: areas.append('top')
        elif y > h - m: areas.append('bottom')
        return areas

    def _set_cursor_shape(self, areas):
        if not areas: self.setCursor(Qt.ArrowCursor); return
        if 'left' in areas and 'top' in areas: self.setCursor(Qt.SizeFDiagCursor)
        elif 'right' in areas and 'bottom' in areas: self.setCursor(Qt.SizeFDiagCursor)
        elif 'left' in areas and 'bottom' in areas: self.setCursor(Qt.SizeBDiagCursor)
        elif 'right' in areas and 'top' in areas: self.setCursor(Qt.SizeBDiagCursor)
        elif 'left' in areas or 'right' in areas: self.setCursor(Qt.SizeHorCursor)
        elif 'top' in areas or 'bottom' in areas: self.setCursor(Qt.SizeVerCursor)

    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            areas = self._get_resize_area(event.pos())
            if areas:
                self.resize_area = areas
                self.m_drag = False
            else:
                self.resize_area = None
                self.m_drag = True
                self.m_DragPosition = event.globalPos() - self.pos()
            event.accept()

    def mouseMoveEvent(self, event):
        if event.buttons() == Qt.NoButton:
            areas = self._get_resize_area(event.pos())
            self._set_cursor_shape(areas)
            event.accept()
            return
        if event.buttons() == Qt.LeftButton:
            if self.resize_area:
                global_pos = event.globalPos()
                rect = self.geometry()
                if 'left' in self.resize_area:
                    new_w = rect.right() - global_pos.x()
                    if new_w > 100: rect.setLeft(global_pos.x())
                elif 'right' in self.resize_area:
                    new_w = global_pos.x() - rect.left()
                    if new_w > 100: rect.setWidth(new_w)
                if 'top' in self.resize_area:
                    new_h = rect.bottom() - global_pos.y()
                    if new_h > 100: rect.setTop(global_pos.y())
                elif 'bottom' in self.resize_area:
                    new_h = global_pos.y() - rect.top()
                    if new_h > 100: rect.setHeight(new_h)
                self.setGeometry(rect)
                event.accept()
            elif self.m_drag:
                self.move(event.globalPos() - self.m_DragPosition)
                event.accept()

    def mouseReleaseEvent(self, event):
        self.m_drag = False
        self.resize_area = None
        self.setCursor(Qt.ArrowCursor)

    # --- Core Logic ---
    def showEvent(self, event):
        if not self.my_hwnd and user32: self.my_hwnd = int(self.winId())
        super().showEvent(event)

    def _monitor_foreground_window(self):
        if not user32: return 
        current_hwnd = user32.GetForegroundWindow()
        if current_hwnd == 0 or current_hwnd == self.my_hwnd: return
        if current_hwnd != self.last_active_hwnd:
            self.last_active_hwnd = current_hwnd
            self.last_thread_id = user32.GetWindowThreadProcessId(current_hwnd, None)
            self.last_focus_hwnd = None
            curr_thread = kernel32.GetCurrentThreadId()
            attached = False
            if curr_thread != self.last_thread_id:
                attached = user32.AttachThreadInput(curr_thread, self.last_thread_id, True)
            try:
                gui_info = GUITHREADINFO()
                gui_info.cbSize = ctypes.sizeof(GUITHREADINFO)
                if user32.GetGUIThreadInfo(self.last_thread_id, ctypes.byref(gui_info)):
                    self.last_focus_hwnd = gui_info.hwndFocus or gui_info.hwndActive
            except: pass
            finally:
                if attached: user32.AttachThreadInput(curr_thread, self.last_thread_id, False)

    def _on_search_text_changed(self): self.search_timer.start(300)

    def _update_list(self):
        search_text = self.search_box.text()
        current_partition = self.partition_tree.currentItem()
        if current_partition:
            partition_data = current_partition.data(0, Qt.UserRole)
            if partition_data:
                if partition_data.get('type') == 'today':
                    f_type, f_val = 'today', None
                elif partition_data.get('type') == 'partition':
                    f_type, f_val = 'category', partition_data.get('id')
                else: # all
                    f_type, f_val = 'all', None
            else:
                f_type, f_val = 'all', None
        else:
            f_type, f_val = 'all', None

        items = self.db.get_ideas(search=search_text, f_type=f_type, f_val=f_val)
        self.list_widget.clear()
        
        # 1. é¢„åŠ è½½åˆ†ç±»æ˜ å°„ (ID -> Name)
        categories = {c[0]: c[1] for c in self.db.get_categories()}
        
        for item_tuple in items:
            list_item = QListWidgetItem()
            list_item.setData(Qt.UserRole, item_tuple)
            
            item_type = item_tuple[10] if len(item_tuple) > 10 else 'text'
            if item_type == 'image':
                blob_data = item_tuple[11] if len(item_tuple) > 11 else None
                if blob_data:
                    pixmap = QPixmap()
                    pixmap.loadFromData(blob_data)
                    if not pixmap.isNull():
                        icon = QIcon(pixmap)
                        list_item.setIcon(icon)

            display_text = self._get_content_display(item_tuple)
            list_item.setText(display_text)
            
            # Tooltip åªæ˜¾ç¤ºåˆ†åŒºå’Œæ ‡ç­¾
            idea_id = item_tuple[0]
            category_id = item_tuple[8]
            
            cat_name = categories.get(category_id, "æœªåˆ†ç±»")
            tags = self.db.get_tags(idea_id)
            tags_str = " ".join([f"#{t}" for t in tags]) if tags else "æ— "
            
            tooltip = f"ğŸ“‚ åˆ†åŒº: {cat_name}\nğŸ·ï¸ æ ‡ç­¾: {tags_str}"
            list_item.setToolTip(tooltip)
            
            self.list_widget.addItem(list_item)
        if self.list_widget.count() > 0: self.list_widget.setCurrentRow(0)

    def _get_content_display(self, item_tuple):
        title = item_tuple[1]
        content = item_tuple[2]
        
        prefix = ""
        if item_tuple[4]: prefix += "ğŸ“Œ "
        if item_tuple[5]: prefix += "â­ "
        
        item_type = item_tuple[10] if len(item_tuple) > 10 and item_tuple[10] else 'text'

        text_part = ""
        if item_type == 'image':
            text_part = title 
        elif item_type == 'file':
            text_part = title 
        else: 
            text_part = title if title else (content if content else "")
            text_part = text_part.replace('\n', ' ').replace('\r', '').strip()[:150]
            
        return prefix + text_part

    def _create_color_icon(self, color_str):
        pixmap = QPixmap(16, 16)
        pixmap.fill(Qt.transparent)
        painter = QPainter(pixmap)
        painter.setRenderHint(QPainter.Antialiasing)
        painter.setBrush(QColor(color_str or "#808080"))
        painter.setPen(Qt.NoPen)
        painter.drawRoundedRect(2, 2, 12, 12, 4, 4)
        painter.end()
        return QIcon(pixmap)

    def _update_partition_tree(self):
        current_selection_data = None
        if self.partition_tree.currentItem():
            current_selection_data = self.partition_tree.currentItem().data(0, Qt.UserRole)
            
        self.partition_tree.clear()
        
        counts = self.db.get_partition_item_counts()
        partition_counts = counts.get('partitions', {})

        static_items = [
            ("å…¨éƒ¨æ•°æ®", {'type': 'all', 'id': -1}, QStyle.SP_DirHomeIcon, counts.get('total', 0)),
            ("ä»Šæ—¥æ•°æ®", {'type': 'today', 'id': -5}, QStyle.SP_FileDialogDetailedView, counts.get('today_modified', 0)),
            ("å‰ªè´´æ¿æ•°æ®", {'type': 'clipboard', 'id': -10}, QStyle.SP_ComputerIcon, counts.get('clipboard', 0)),
            ("æ”¶è—", {'type': 'favorite', 'id': -20}, QStyle.SP_DialogYesButton, counts.get('favorite', 0)),
        ]
        
        for name, data, icon, count in static_items:
            item = QTreeWidgetItem(self.partition_tree, [f"{name} ({count})"])
            item.setData(0, Qt.UserRole, data)
            item.setIcon(0, self.style().standardIcon(icon))
        
        top_level_partitions = self.db.get_partitions_tree()
        self._add_partition_recursive(top_level_partitions, self.partition_tree, partition_counts)

        self.partition_tree.expandAll()
        
        if current_selection_data:
            it = QTreeWidgetItemIterator(self.partition_tree)
            while it.value():
                item = it.value()
                item_data = item.data(0, Qt.UserRole)
                if item_data and item_data.get('id') == current_selection_data.get('id') and item_data.get('type') == current_selection_data.get('type'):
                    self.partition_tree.setCurrentItem(item)
                    break
                it += 1
        else:
            if self.partition_tree.topLevelItemCount() > 0:
                self.partition_tree.setCurrentItem(self.partition_tree.topLevelItem(0))

    def _add_partition_recursive(self, partitions, parent_item, partition_counts):
        for partition in partitions:
            count = partition_counts.get(partition.id, 0)
            item = QTreeWidgetItem(parent_item, [f"{partition.name} ({count})"])
            item.setData(0, Qt.UserRole, {'type': 'partition', 'id': partition.id, 'color': partition.color})
            item.setIcon(0, self._create_color_icon(partition.color))
            
            if partition.children:
                self._add_partition_recursive(partition.children, item, partition_counts)

    def _update_partition_status_display(self):
        is_hidden = self.partition_tree.isHidden()
        if is_hidden:
            current_item = self.partition_tree.currentItem()
            if current_item:
                text = current_item.text(0).split(' (')[0]
                self.partition_status_label.setText(f"å½“å‰åˆ†åŒº: {text}")
            else:
                self.partition_status_label.setText("å½“å‰åˆ†åŒº: N/A")
            self.partition_status_label.show()
        else:
            self.partition_status_label.hide()

    def _on_partition_selection_changed(self, c, p):
        self._update_list()
        self._update_partition_status_display()
        
    def _toggle_partition_panel(self):
        is_currently_visible = self.partition_tree.isVisible()
        self.partition_tree.setVisible(not is_currently_visible)
        self.settings.setValue("partition_panel_hidden", not is_currently_visible)
        self._update_partition_status_display()
    
    def _toggle_stay_on_top(self):
        if not user32: return
        self._is_pinned = self.btn_stay_top.isChecked()
        hwnd = int(self.winId())
        if self._is_pinned:
            user32.SetWindowPos(hwnd, HWND_TOPMOST, 0, 0, 0, 0, SWP_FLAGS)
        else:
            user32.SetWindowPos(hwnd, HWND_NOTOPMOST, 0, 0, 0, 0, SWP_FLAGS)

    def _on_item_activated(self, item):
        item_tuple = item.data(Qt.UserRole)
        if not item_tuple: return

        try:
            clipboard = QApplication.clipboard()
            
            item_type_index = 10
            item_type = item_tuple[item_type_index] if len(item_tuple) > item_type_index and item_tuple[item_type_index] else 'text'
            
            if item_type == 'image':
                blob_index = 11
                image_blob = item_tuple[blob_index]
                if image_blob:
                    image = QImage()
                    image.loadFromData(image_blob)
                    clipboard.setImage(image)
            elif item_type == 'file':
                content_index = 2
                file_path_str = item_tuple[content_index]
                if file_path_str:
                    mime_data = QMimeData()
                    urls = [QUrl.fromLocalFile(p) for p in file_path_str.split(';') if p]
                    mime_data.setUrls(urls)
                    clipboard.setMimeData(mime_data)
            else:
                content_index = 2
                content_to_copy = item_tuple[content_index] if item_tuple[content_index] else ""
                clipboard.setText(content_to_copy)

            self._paste_ditto_style()
        except Exception as e: 
            log(f"âŒ ç²˜è´´æ“ä½œå¤±è´¥: {e}")

    def _paste_ditto_style(self):
        if not user32: return
        target_win = self.last_active_hwnd
        target_focus = self.last_focus_hwnd
        target_thread = self.last_thread_id
        if not target_win or not user32.IsWindow(target_win): return
        curr_thread = kernel32.GetCurrentThreadId()
        attached = False
        if target_thread and curr_thread != target_thread:
            attached = user32.AttachThreadInput(curr_thread, target_thread, True)
        try:
            if user32.IsIconic(target_win): user32.ShowWindow(target_win, 9)
            user32.SetForegroundWindow(target_win)
            if target_focus and user32.IsWindow(target_focus): user32.SetFocus(target_focus)
            time.sleep(0.1)
            user32.keybd_event(VK_CONTROL, 0, 0, 0)
            user32.keybd_event(VK_V, 0, 0, 0)
            user32.keybd_event(VK_V, 0, KEYEVENTF_KEYUP, 0)
            user32.keybd_event(VK_CONTROL, 0, KEYEVENTF_KEYUP, 0)
        except Exception as e: log(f"âŒ ç²˜è´´å¼‚å¸¸: {e}")
        finally:
            if attached: user32.AttachThreadInput(curr_thread, target_thread, False)

    def on_clipboard_changed(self):
        if self._processing_clipboard:
            return
        self._processing_clipboard = True
        try:
            mime = self.clipboard.mimeData()
            self.cm.process_clipboard(mime, None)
        finally:
            self._processing_clipboard = False

    def keyPressEvent(self, event):
        key = event.key()
        if key == Qt.Key_Escape: self.close()
        elif key in (Qt.Key_Up, Qt.Key_Down):
            if not self.list_widget.hasFocus():
                self.list_widget.setFocus()
                QApplication.sendEvent(self.list_widget, event)
        else: super().keyPressEvent(event)

    # --- åˆ†åŒºå³é”®èœå• ---
    def _show_partition_context_menu(self, pos):
        item = self.partition_tree.itemAt(pos)
        menu = QMenu(self)
        menu.setStyleSheet(f"background-color: {COLORS.get('bg_dark', '#2d2d2d')}; color: white; border: 1px solid #444;")
        
        if not item:
            menu.addAction('â• æ–°å»ºåˆ†ç»„', self._new_group)
            menu.exec_(self.partition_tree.mapToGlobal(pos))
            return

        data = item.data(0, Qt.UserRole)
        
        if data and data.get('type') == 'partition':
            cat_id = data.get('id')
            raw_text = item.text(0)
            current_name = raw_text.split(' (')[0]

            menu.addAction('â• æ–°å»ºæ•°æ®', lambda: self._request_new_data(cat_id))
            menu.addSeparator()
            menu.addAction('ğŸ¨ è®¾ç½®é¢œè‰²', lambda: self._change_color(cat_id))
            menu.addAction('ğŸ·ï¸ è®¾ç½®é¢„è®¾æ ‡ç­¾', lambda: self._set_preset_tags(cat_id))
            menu.addSeparator()
            menu.addAction('â• æ–°å»ºåˆ†ç»„', self._new_group)
            menu.addAction('â• æ–°å»ºåˆ†åŒº', lambda: self._new_zone(cat_id))
            menu.addAction('âœï¸ é‡å‘½å', lambda: self._rename_category(cat_id, current_name))
            menu.addAction('ğŸ—‘ï¸ åˆ é™¤', lambda: self._del_category(cat_id))
            
            menu.exec_(self.partition_tree.mapToGlobal(pos))
        else:
             # å¯¹äºç³»ç»Ÿé¡¹æˆ–ç©ºç™½å¤„ï¼Œä»…æä¾›åŸºæœ¬æ“ä½œæˆ–ä¸æ˜¾ç¤ºæ–°å»ºåˆ†ç»„
             if not item:
                menu.addAction('â• æ–°å»ºåˆ†ç»„', self._new_group)
                menu.exec_(self.partition_tree.mapToGlobal(pos))
             else:
                # ç³»ç»Ÿé¡¹ç¦æ­¢æ˜¾ç¤ºèœå•ï¼Œæˆ–ä»…æ˜¾ç¤ºå…è®¸çš„æ“ä½œ
                pass

    def _request_new_data(self, cat_id):
        dialog = EditDialog(self.db, category_id_for_new=cat_id, parent=None)
        dialog.setAttribute(Qt.WA_DeleteOnClose)
        
        dialog.data_saved.connect(self._update_list)
        dialog.data_saved.connect(self._update_partition_tree)
        
        dialog.finished.connect(lambda: self.open_dialogs.remove(dialog) if dialog in self.open_dialogs else None)
        
        self.open_dialogs.append(dialog)
        dialog.show()
        dialog.activateWindow()

    def _new_group(self):
        text, ok = QInputDialog.getText(self, 'æ–°å»ºç»„', 'ç»„åç§°:')
        if ok and text:
            self.db.add_category(text, parent_id=None)
            self._update_partition_tree()
            
    def _new_zone(self, parent_id):
        text, ok = QInputDialog.getText(self, 'æ–°å»ºåŒº', 'åŒºåç§°:')
        if ok and text:
            self.db.add_category(text, parent_id=parent_id)
            self._update_partition_tree()

    def _rename_category(self, cat_id, old_name):
        text, ok = QInputDialog.getText(self, 'é‡å‘½å', 'æ–°åç§°:', text=old_name)
        if ok and text and text.strip():
            self.db.rename_category(cat_id, text.strip())
            self._update_partition_tree()
            self._update_list() # å¯èƒ½å½±å“åˆ—è¡¨æ˜¾ç¤ºçš„åˆ†ç±»å

    def _del_category(self, cid):
        c = self.db.conn.cursor()
        c.execute("SELECT COUNT(*) FROM categories WHERE parent_id = ?", (cid,))
        child_count = c.fetchone()[0]

        msg = 'ç¡®è®¤åˆ é™¤æ­¤åˆ†ç±»? (å…¶ä¸­çš„å†…å®¹å°†ç§»è‡³æœªåˆ†ç±»)'
        if child_count > 0:
            msg = f'æ­¤ç»„åŒ…å« {child_count} ä¸ªåŒºï¼Œç¡®è®¤ä¸€å¹¶åˆ é™¤?\n(æ‰€æœ‰å†…å®¹éƒ½å°†ç§»è‡³æœªåˆ†ç±»)'

        if QMessageBox.Yes == QMessageBox.question(self, 'ç¡®è®¤åˆ é™¤', msg):
            c.execute("SELECT id FROM categories WHERE parent_id = ?", (cid,))
            child_ids = [row[0] for row in c.fetchall()]
            for child_id in child_ids:
                self.db.delete_category(child_id)
            self.db.delete_category(cid)
            self._update_partition_tree()
            self._update_list()

    def _change_color(self, cat_id):
        color = QColorDialog.getColor(Qt.gray, self, "é€‰æ‹©åˆ†ç±»é¢œè‰²")
        if color.isValid():
            self.db.set_category_color(cat_id, color.name())
            self._update_partition_tree()

    def _set_preset_tags(self, cat_id):
        current_tags = self.db.get_category_preset_tags(cat_id)
        
        dlg = QDialog(self)
        dlg.setWindowTitle("ğŸ·ï¸ è®¾ç½®é¢„è®¾æ ‡ç­¾")
        dlg.setStyleSheet(f"background-color: {COLORS.get('bg_dark', '#2d2d2d')}; color: #EEE;")
        dlg.setFixedSize(350, 150)
        
        layout = QVBoxLayout(dlg)
        layout.setContentsMargins(20, 20, 20, 20)
        
        info = QLabel("æ‹–å…¥è¯¥åˆ†ç±»æ—¶è‡ªåŠ¨ç»‘å®šä»¥ä¸‹æ ‡ç­¾ï¼š\n(åŒå‡»è¾“å…¥æ¡†é€‰æ‹©å†å²æ ‡ç­¾)")
        info.setStyleSheet("color: #888; font-size: 12px; margin-bottom: 5px;")
        layout.addWidget(info)
        
        inp = ClickableLineEdit()
        inp.setText(current_tags)
        inp.setPlaceholderText("ä¾‹å¦‚: å·¥ä½œ, é‡è¦ (é€—å·åˆ†éš”)")
        inp.setStyleSheet(f"background-color: {COLORS.get('bg_mid', '#333')}; border: 1px solid #444; padding: 6px; border-radius: 4px; color: white;")
        layout.addWidget(inp)
        
        def open_tag_selector():
            initial_list = [t.strip() for t in inp.text().split(',') if t.strip()]
            selector = AdvancedTagSelector(self.db, idea_id=None, initial_tags=initial_list)
            def on_confirmed(tags):
                inp.setText(', '.join(tags))
            selector.tags_confirmed.connect(on_confirmed)
            selector.show_at_cursor()
            
        inp.doubleClicked.connect(open_tag_selector)
        
        btns = QHBoxLayout()
        btns.addStretch()
        btn_ok = QPushButton("å®Œæˆ")
        btn_ok.setStyleSheet(f"background-color: {COLORS.get('primary', '#0078D4')}; border:none; padding: 5px 15px; border-radius: 4px; font-weight:bold; color: white;")
        btn_ok.clicked.connect(dlg.accept)
        btns.addWidget(btn_ok)
        layout.addLayout(btns)
        
        if dlg.exec_() == QDialog.Accepted:
            new_tags = inp.text().strip()
            self.db.set_category_preset_tags(cat_id, new_tags)
            
            tags_list = [t.strip() for t in new_tags.split(',') if t.strip()]
            if tags_list:
                self.db.apply_preset_tags_to_category_items(cat_id, tags_list)
                
            self.data_changed.emit()
```

## æ–‡ä»¶: rich_text_edit.py

```python
from PyQt5.QtWidgets import QTextEdit, QRubberBand, QMenu, QAction
from PyQt5.QtGui import QImage, QColor, QTextCharFormat, QTextCursor, QPainter, QMouseEvent, QTextImageFormat, QTextListFormat, QTextBlockFormat
from PyQt5.QtCore import Qt, QByteArray, QBuffer, QIODevice, QSize, QPoint, QRect

class ImageResizer(QRubberBand):
    def __init__(self, parent=None, cursor=None, image_format=None):
        super().__init__(QRubberBand.Rectangle, parent)
        self.editor = parent
        self.cursor = cursor  # æŒ‡å‘å›¾ç‰‡çš„ TextCursor
        self.image_format = image_format
        self.current_image_name = image_format.name()
        
        # åˆå§‹å°ºå¯¸
        self.original_width = image_format.width()
        self.original_height = image_format.height()
        self.aspect_ratio = self.original_height / self.original_width if self.original_width > 0 else 1.0
        
        # æ‹–æ‹½çŠ¶æ€
        self.dragging = False
        self.drag_start_pos = QPoint()
        self.start_rect = QRect()
        
        self.show()
        self.update_geometry()

    def update_geometry(self):
        # æ ¹æ® cursor è®¡ç®—å›¾ç‰‡åœ¨ viewport ä¸­çš„ä½ç½®
        rect = self.editor.cursorRect(self.cursor)
        # cursorRect è¿”å›çš„æ˜¯å…‰æ ‡ä½ç½®ï¼ˆä¸€æ¡çº¿ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦å›¾ç‰‡çš„å®é™…çŸ©å½¢
        # å®é™…ä¸Šå¯¹äº ImageResourceï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤æ‚çš„è®¡ç®—ï¼Œæˆ–è€…åˆ©ç”¨ cursorRect çš„ä½ç½®
        # è¿™é‡Œç®€åŒ–ï¼šå‡è®¾æˆ‘ä»¬å·²çŸ¥å®½é«˜
        w = int(self.image_format.width())
        h = int(self.image_format.height())
        # cursorRect é€šå¸¸åœ¨å›¾ç‰‡çš„å³ä¾§ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´
        # ä½†å¯¹äº Block ä¸­çš„ Imageï¼ŒcursorRect å¯èƒ½å°±æ˜¯å›¾ç‰‡åŒºåŸŸï¼Ÿ
        # ä¸ï¼ŒQTextEdit ä¸­å›¾ç‰‡é€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ã€‚
        
        # æ›´å‡†ç¡®çš„æ–¹æ³•æ˜¯ï¼š
        # ä½¿ç”¨ editor.cursorRect(cursor) å¾—åˆ°ä½ç½®ï¼Œç„¶åç»“åˆ width/height
        self.setGeometry(rect.x(), rect.y(), w, h)

    def mousePressEvent(self, event):
        if event.button() == Qt.LeftButton:
            # ç®€å•å®ç°ï¼šç‚¹å‡»å³ä¸‹è§’åŒºåŸŸä½œä¸ºè°ƒæ•´å¤§å°
            if (self.width() - event.pos().x() < 20) and (self.height() - event.pos().y() < 20):
                self.dragging = True
                self.drag_start_pos = event.globalPos()
                self.start_rect = self.geometry()
                event.accept()
            else:
                # ç‚¹å‡»å…¶ä»–åœ°æ–¹ï¼Œå¯èƒ½æ˜¯æƒ³å–æ¶ˆé€‰ä¸­æˆ–ç§»åŠ¨
                self.editor.deselect_image()
                # è½¬å‘äº‹ä»¶ç»™ editor? å…¶å®ä¸éœ€è¦ï¼Œå¹¶åœ¨ç‚¹å‡»å¤–éƒ¨æ—¶ç”± editor å¤„ç†
        
    def mouseMoveEvent(self, event):
        if self.dragging:
            delta = event.globalPos() - self.drag_start_pos
            new_w = max(50, self.start_rect.width() + delta.x())
            new_h = int(new_w * self.aspect_ratio) # ä¿æŒæ¯”ä¾‹
            
            self.resize(new_w, new_h)
            event.accept()
            
    def mouseReleaseEvent(self, event):
        if self.dragging:
            self.dragging = False
            # åº”ç”¨æ–°çš„å°ºå¯¸åˆ°æ–‡æ¡£
            self._apply_new_size()
            
    def _apply_new_size(self):
        # æ›´æ–° ImageFormat
        new_fmt = QTextImageFormat(self.image_format)
        new_fmt.setWidth(self.width())
        new_fmt.setHeight(self.height())
        new_fmt.setName(self.current_image_name) # ä¿æŒåå­—å¾ˆé‡è¦
        
        # æˆ‘ä»¬å¿…é¡»æ“ä½œ document
        # ä½¿ç”¨ cursor é€‰ä¸­è¯¥å›¾ç‰‡å­—ç¬¦ï¼Œç„¶å setCharFormat (å…¶å®æ˜¯ mergeCharFormat ä¸é€‚ç”¨ ImageFormat çš„å±æ€§æ›´æ–°?)
        # å®é™…ä¸Šæ›´æ–°å›¾ç‰‡å¤§å°æ¯”è¾ƒ trickyï¼Œæœ€ç¨³å¦¥æ˜¯æ›¿æ¢
        c = QTextCursor(self.cursor)
        c.setPosition(self.cursor.position()) # ç¡®ä¿ä½ç½®æ­£ç¡®
        c.setPosition(self.cursor.position() + 1, QTextCursor.KeepAnchor) # é€‰ä¸­å›¾ç‰‡å­—ç¬¦
        c.setCharFormat(new_fmt) # è¿™é‡Œå¯èƒ½ä¸ç®¡ç”¨ï¼Œå¯¹äº ImageFormat éœ€è¦ç”¨ mergeBlockCharFormat? ä¸ï¼Œç›´æ¥æ›¿æ¢æ›´å¥½?
        
        # æ›´å¥½çš„æ–¹æ³•: æ›¿æ¢å›¾ç‰‡
        # ä½†ä¸ºäº†é¿å…é‡æ–°åŠ è½½é—ªçƒï¼ŒPyQt çš„ QTextImageFormat å±æ€§ä¿®æ”¹åï¼Œå¦‚æœä¸é‡æ–° insert å¯èƒ½ä¸åˆ·æ–°ã€‚
        # è¯•è¯•æœ€ç›´æ¥çš„: insertImage æ›¿æ¢
        # c.insertImage(new_fmt) 
        # ä½†è¿™æ ·ä¼šå¯¼è‡´ cursor ä¸¢å¤±ã€‚
        
        # æ­£ç¡®åšæ³•ï¼š
        image_name = new_fmt.name()
        self.editor.document().addResource(3, image_name, self.editor.document().resource(3, image_name)) # åˆ·æ–°èµ„æº? ä¸
        
        c.insertImage(new_fmt)
        
        # æ›´æ–°å†…éƒ¨çŠ¶æ€
        self.image_format = new_fmt
        self.cursor = QTextCursor(c) # æ›´æ–° cursor ä½ç½®ï¼ˆå› ä¸ºå®ƒåŠ¨äº†ï¼‰
        self.cursor.setPosition(c.position() - 1) # å›é€€åˆ°å›¾ç‰‡å‰
        
        # é‡æ–°å®šä½ Resizer
        self.update_geometry()

    def paintEvent(self, event):
        # ç»˜åˆ¶è¾¹æ¡†å’Œæ‰‹æŸ„
        painter = QPainter(self)
        painter.setPen(Qt.blue)
        painter.setBrush(Qt.NoBrush)
        painter.drawRect(0, 0, self.width()-1, self.height()-1)
        
        # å³ä¸‹è§’æ‰‹æŸ„
        painter.setBrush(Qt.blue)
        painter.drawRect(self.width()-10, self.height()-10, 10, 10)

class RichTextEdit(QTextEdit):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.image_data = None
        self.current_resizer = None

    def mousePressEvent(self, event):
        # æ£€æµ‹ç‚¹å‡»å›¾ç‰‡
        cursor = self.cursorForPosition(event.pos())
        fmt = cursor.charFormat()
        
        if fmt.isImageFormat():
            image_fmt = fmt.toImageFormat()
            # é€‰ä¸­å›¾ç‰‡
            self.select_image(cursor, image_fmt)
            return # åæ‰äº‹ä»¶ï¼Œé˜²æ­¢å…‰æ ‡ç§»åŠ¨å¯¼è‡´å–æ¶ˆé€‰ä¸­? 
            # æˆ–è€…æˆ‘ä»¬åªåœ¨ç‚¹å‡»ç¡®åˆ‡æ˜¯å›¾ç‰‡æ—¶æ‹¦æˆªã€‚
            
        # ç‚¹å‡»éå›¾ç‰‡åŒºåŸŸï¼Œå–æ¶ˆé€‰ä¸­
        self.deselect_image()
        super().mousePressEvent(event)

    def select_image(self, cursor, image_fmt):
        self.deselect_image()
        
        # åˆ›å»ºè°ƒæ•´å™¨
        # æ³¨æ„: cursor ä½ç½®æ˜¯åœ¨å›¾ç‰‡å­—ç¬¦ä¹‹å‰è¿˜æ˜¯ä¹‹å? need careful handling
        # cursorForPosition è¿”å›çš„ cursor é€šå¸¸åœ¨å­—ç¬¦ä¹‹é—´ã€‚
        # æˆ‘ä»¬éœ€è¦ç¡®ä¿ cursor æŒ‡å‘å›¾ç‰‡å­—ç¬¦çš„å¼€å§‹ã€‚
        
        # ç®€å•å¤„ç†: æˆ‘ä»¬å‡è®¾ clicked on image implies that the char to the right (or left) is the image.
        # But cursorForPosition is precise.
        
        # è°ƒæ•´ cursor é€‰ä¸­è¯¥å›¾ç‰‡
        # å¦‚æœæ˜¯ç‚¹åœ¨å›¾ç‰‡ä¸Šï¼Œcursoré€šå¸¸åœ¨å›¾ç‰‡åé¢ï¼Ÿ
        # è®©æˆ‘ä»¬è·å–ç¡®åˆ‡çš„ ImageFormat
        
        self.current_resizer = ImageResizer(self, cursor, image_fmt)
        self.current_resizer.show()

    def deselect_image(self):
        if self.current_resizer:
            self.current_resizer.close()
            self.current_resizer = None

    def keyPressEvent(self, event):
         # ESC å–æ¶ˆé€‰ä¸­
        if event.key() == Qt.Key_Escape and self.current_resizer:
            self.deselect_image()
            return
        super().keyPressEvent(event)
        
    def contextMenuEvent(self, event):
        # å¢å¼ºå³é”®èœå•
        menu = self.createStandardContextMenu()
        
        # æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å›¾ç‰‡
        cursor = self.cursorForPosition(event.pos())
        fmt = cursor.charFormat()
        
        if fmt.isImageFormat():
            menu.addSeparator()
            # æ˜¾å¼æ‹·è´å¯¹è±¡ï¼Œé˜²æ­¢ C++ å¯¹è±¡é‡Šæ”¾å¯¼è‡´çš„é‡æŒ‡é’ˆå´©æºƒ
            target_cursor = QTextCursor(cursor)
            target_fmt = QTextImageFormat(fmt.toImageFormat())
            
            restore_action = menu.addAction("è¿˜åŸåŸå§‹å¤§å°")
            # lambda æ¥æ”¶ checked å‚æ•°ï¼Œå¹¶ä½¿ç”¨é»˜è®¤å‚æ•°é”å®šå¯¹è±¡å‰¯æœ¬
            restore_action.triggered.connect(lambda checked=False, c=target_cursor, f=target_fmt: self._restore_image_size(c, f))
            
        menu.exec_(event.globalPos())
        
    def _restore_image_size(self, cursor, image_fmt):
        try:
            image_name = image_fmt.name()
            # 3 = QTextDocument.ImageResource
            image_variant = self.document().resource(3, image_name)
            
            if not image_variant:
                return
                
            # PyQt5 ä¸­ resource å¯èƒ½è¿”å› QVariantï¼Œéœ€è¦è§£åŒ…
            image = image_variant
            if hasattr(image, 'toImage'): # å¦‚æœæ˜¯ QVariant
                image = image.toImage()
                
            # å†æ¬¡æ£€æŸ¥
            if not isinstance(image, QImage) or image.isNull():
                return
            
            new_fmt = QTextImageFormat(image_fmt)
            new_fmt.setWidth(image.width())
            new_fmt.setHeight(image.height())
            new_fmt.setName(image_name) # ç¡®ä¿åå­—ä¸€è‡´
            
            c = QTextCursor(cursor)
            # ç¡®ä¿å…‰æ ‡ä½ç½®æœ‰æ•ˆ
            if c.position() < self.document().characterCount():
                c.setPosition(cursor.position())
                c.setPosition(cursor.position() + 1, QTextCursor.KeepAnchor)
                c.insertImage(new_fmt)
                
            self.deselect_image()
        except Exception as e:
            pass

    def highlight_selection(self, color_str):
        cursor = self.textCursor()
        if not cursor.hasSelection():
            return
            
        fmt = QTextCharFormat()
        if not color_str:
            fmt.setBackground(Qt.transparent)
        else:
            fmt.setBackground(QColor(color_str))
            
        cursor.mergeCharFormat(fmt)
        self.setTextCursor(cursor)

    def canInsertFromMimeData(self, source):
        return source.hasImage() or super().canInsertFromMimeData(source)

    def insertFromMimeData(self, source):
        if source.hasImage():
            image = source.imageData()
            if isinstance(image, QImage):
                byte_array = QByteArray()
                buffer = QBuffer(byte_array)
                buffer.open(QIODevice.WriteOnly)
                image.save(buffer, "PNG")
                self.image_data = byte_array.data()

                cursor = self.textCursor()
                
                max_width = self.viewport().width() - 40
                if image.width() > max_width:
                    scale = max_width / image.width()
                    scaled_image = image.scaled(
                        int(max_width), 
                        int(image.height() * scale),
                        Qt.KeepAspectRatio,
                        Qt.SmoothTransformation
                    )
                    cursor.insertImage(scaled_image)
                else:
                    cursor.insertImage(image)
                return

        super().insertFromMimeData(source)

    def get_image_data(self):
        return self.image_data

    def set_image_data(self, data):
        self.image_data = data
        if data:
            image = QImage()
            image.loadFromData(data)
            if not image.isNull():
                self.clear()
                cursor = self.textCursor()
                max_width = self.viewport().width() - 40
                if image.width() > max_width:
                    scale = max_width / image.width()
                    scaled_image = image.scaled(
                        int(max_width),
                        int(image.height() * scale),
                        Qt.KeepAspectRatio,
                        Qt.SmoothTransformation
                    )
                    cursor.insertImage(scaled_image)
                else:
                    cursor.insertImage(image)

    def toggle_list(self, list_style):
        cursor = self.textCursor()
        cursor.beginEditBlock()
        
        current_list = cursor.currentList()
        if current_list:
             fmt = current_list.format()
             if fmt.style() == list_style:
                 # å–æ¶ˆåˆ—è¡¨: å°†å½“å‰å—æ ¼å¼é‡ç½®
                 # å®é™…ä¸Šæ¯”è¾ƒå¤æ‚ï¼Œç®€å•åšæ³•æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„ BlockFormat
                 block_fmt = QTextBlockFormat()
                 block_fmt.setObjectIndex(-1) # ç§»é™¤åˆ—è¡¨å…³è”
                 cursor.setBlockFormat(block_fmt)
             else:
                 fmt.setStyle(list_style)
                 current_list.setFormat(fmt)
        else:
             list_fmt = QTextListFormat()
             list_fmt.setStyle(list_style)
             cursor.createList(list_fmt)
             
        cursor.endEditBlock()

```

## æ–‡ä»¶: schema_migrations.py

```python
# data/schema_migrations.py
import logging

logger = logging.getLogger(__name__)

class SchemaMigration:
    @staticmethod
    def _get_db_version(conn):
        c = conn.cursor()
        try:
            c.execute("PRAGMA user_version")
            version = c.fetchone()[0]
            return version
        except Exception:
            # If user_version does not exist, it's a very old db, treat as version 0
            return 0

    @staticmethod
    def _set_db_version(conn, version):
        c = conn.cursor()
        c.execute(f"PRAGMA user_version = {version}")
        conn.commit()

    @staticmethod
    def apply(conn):
        logger.info("å¼€å§‹æ£€æŸ¥æ•°æ®åº“ç»“æ„è¿ç§»...")
        current_version = SchemaMigration._get_db_version(conn)
        logger.info(f"å½“å‰æ•°æ®åº“ç‰ˆæœ¬: {current_version}")

        if current_version < 1:
            SchemaMigration._migrate_to_v1(conn)
            SchemaMigration._set_db_version(conn, 1)
            logger.info("æ•°æ®åº“è¿ç§»åˆ° v1")
        
        # Add future migrations here
        # if current_version < 2:
        #     SchemaMigration._migrate_to_v2(conn)
        #     SchemaMigration._set_db_version(conn, 2)
        #     logger.info("æ•°æ®åº“è¿ç§»åˆ° v2")
            
        logger.info("æ•°æ®åº“ç»“æ„æ£€æŸ¥å®Œæˆã€‚")

    @staticmethod
    def _migrate_to_v1(conn):
        c = conn.cursor()
        
        logger.info("v1 è¿ç§»: åˆ›å»ºåˆå§‹è¡¨ç»“æ„...")
        c.execute('''CREATE TABLE IF NOT EXISTS ideas (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL, content TEXT, color TEXT DEFAULT '#4a90e2',
            is_pinned INTEGER DEFAULT 0, is_favorite INTEGER DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            category_id INTEGER, is_deleted INTEGER DEFAULT 0,
            item_type TEXT DEFAULT 'text', data_blob BLOB,
            content_hash TEXT
        )''')
        c.execute('CREATE TABLE IF NOT EXISTS tags (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT UNIQUE NOT NULL)')
        c.execute('''CREATE TABLE IF NOT EXISTS categories (
            id INTEGER PRIMARY KEY AUTOINCREMENT, 
            name TEXT NOT NULL, 
            parent_id INTEGER, 
            color TEXT DEFAULT "#808080",
            sort_order INTEGER DEFAULT 0
        )''')
        c.execute('CREATE TABLE IF NOT EXISTS idea_tags (idea_id INTEGER, tag_id INTEGER, PRIMARY KEY (idea_id, tag_id))')
        c.execute('CREATE INDEX IF NOT EXISTS idx_content_hash ON ideas(content_hash)')
        
        # This part is for migrating from even older, pre-versioning schemas
        logger.info("v1 è¿ç§»: æ£€æŸ¥å¹¶æ·»åŠ æ—§ç‰ˆæœ¬å¯èƒ½ç¼ºå¤±çš„åˆ—...")
        c.execute("PRAGMA table_info(ideas)")
        cols = [i[1] for i in c.fetchall()]
        if 'category_id' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN category_id INTEGER')
            except: pass
        if 'is_deleted' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN is_deleted INTEGER DEFAULT 0')
            except: pass
        if 'item_type' not in cols:
            try: c.execute("ALTER TABLE ideas ADD COLUMN item_type TEXT DEFAULT 'text'")
            except: pass
        if 'data_blob' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN data_blob BLOB')
            except: pass
        if 'content_hash' not in cols:
            try: c.execute('ALTER TABLE ideas ADD COLUMN content_hash TEXT')
            except: pass
        
        c.execute("PRAGMA table_info(categories)")
        cat_cols = [i[1] for i in c.fetchall()]
        if 'sort_order' not in cat_cols:
            try: c.execute('ALTER TABLE categories ADD COLUMN sort_order INTEGER DEFAULT 0')
            except: pass
            
        conn.commit()
```

## æ–‡ä»¶: search_line_edit.py

```python
# -*- coding: utf-8 -*-
# ui/components/search_line_edit.py

from PyQt5.QtWidgets import (QLineEdit, QPushButton, QHBoxLayout, QWidget, 
                             QVBoxLayout, QApplication, QLabel, QLayout, 
                             QScrollArea, QFrame, QGraphicsDropShadowEffect, QSizePolicy)
from PyQt5.QtCore import Qt, QSettings, QPoint, QRect, QSize, pyqtSignal, QPropertyAnimation, QEasingCurve
from PyQt5.QtGui import QColor, QFont, QCursor

# --- 1. æµå¼å¸ƒå±€ ---
class FlowLayout(QLayout):
    def __init__(self, parent=None, margin=0, spacing=-1):
        super(FlowLayout, self).__init__(parent)
        if parent is not None:
            self.setContentsMargins(margin, margin, margin, margin)
        self.setSpacing(spacing)
        self.itemList = []

    def __del__(self):
        item = self.takeAt(0)
        while item:
            item = self.takeAt(0)

    def addItem(self, item):
        self.itemList.append(item)

    def count(self):
        return len(self.itemList)

    def itemAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList[index]
        return None

    def takeAt(self, index):
        if 0 <= index < len(self.itemList):
            return self.itemList.pop(index)
        return None

    def expandingDirections(self):
        return Qt.Orientations(Qt.Orientation(0))

    def hasHeightForWidth(self):
        return True

    def heightForWidth(self, width):
        height = self.doLayout(QRect(0, 0, width, 0), True)
        return height

    def setGeometry(self, rect):
        super(FlowLayout, self).setGeometry(rect)
        self.doLayout(rect, False)

    def sizeHint(self):
        return self.minimumSize()

    def minimumSize(self):
        size = QSize()
        for item in self.itemList:
            size = size.expandedTo(item.minimumSize())
        margin = self.contentsMargins()
        size += QSize(margin.left() + margin.right(), margin.top() + margin.bottom())
        return size

    def doLayout(self, rect, testOnly):
        x = rect.x()
        y = rect.y()
        lineHeight = 0
        spacing = self.spacing()

        for item in self.itemList:
            wid = item.widget()
            spaceX = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Horizontal)
            spaceY = spacing + wid.style().layoutSpacing(QSizePolicy.PushButton, QSizePolicy.PushButton, Qt.Vertical)
            
            nextX = x + item.sizeHint().width() + spaceX
            if nextX - spaceX > rect.right() and lineHeight > 0:
                x = rect.x()
                y = y + lineHeight + spaceY
                nextX = x + item.sizeHint().width() + spaceX
                lineHeight = 0

            if not testOnly:
                item.setGeometry(QRect(QPoint(x, y), item.sizeHint()))

            x = nextX
            lineHeight = max(lineHeight, item.sizeHint().height())

        return y + lineHeight - rect.y()

# --- 2. å†å²è®°å½•æ°”æ³¡ ---
class HistoryChip(QFrame):
    clicked = pyqtSignal(str)
    deleted = pyqtSignal(str)

    def __init__(self, text, parent=None):
        super().__init__(parent)
        self.text = text
        self.setCursor(Qt.PointingHandCursor)
        self.setObjectName("HistoryChip")
        
        layout = QHBoxLayout(self)
        layout.setContentsMargins(10, 4, 4, 4)
        layout.setSpacing(6)
        
        lbl = QLabel(text)
        lbl.setStyleSheet("border: none; background: transparent; color: #DDD; font-size: 12px;")
        layout.addWidget(lbl)
        
        self.btn_del = QPushButton("Ã—")
        self.btn_del.setFixedSize(16, 16)
        self.btn_del.setCursor(Qt.PointingHandCursor)
        self.btn_del.setStyleSheet("""
            QPushButton {
                background-color: transparent;
                color: #666;
                border-radius: 8px;
                font-weight: bold;
                padding-bottom: 2px;
            }
            QPushButton:hover {
                background-color: #E74C3C;
                color: white;
            }
        """)
        self.btn_del.clicked.connect(self._on_delete)
        layout.addWidget(self.btn_del)
        
        self.setStyleSheet("""
            #HistoryChip {
                background-color: #3A3A3E;
                border: 1px solid #555;
                border-radius: 12px;
            }
            #HistoryChip:hover {
                background-color: #454549;
                border-color: #4a90e2;
            }
        """)

    def mousePressEvent(self, e):
        if e.button() == Qt.LeftButton and not self.btn_del.underMouse():
            self.clicked.emit(self.text)
        super().mousePressEvent(e)

    def _on_delete(self):
        self.deleted.emit(self.text)

# --- 3. ç°ä»£æ„Ÿå¼¹çª— (å®Œç¾å¯¹é½ç‰ˆ) ---
class SearchHistoryPopup(QWidget):
    item_selected = pyqtSignal(str)
    
    def __init__(self, search_edit):
        super().__init__(search_edit.window()) 
        self.search_edit = search_edit
        self.settings = QSettings("KMain_V3", "SearchHistory")
        
        # é˜´å½±è¾¹è·è®¾ç½® (å·¦å³ä¸‹å„ç•™ç©ºé—´ï¼Œä¸Šæ–¹å°‘ç•™ä¸€ç‚¹)
        self.shadow_margin = 12 
        
        self.setWindowFlags(Qt.Popup | Qt.FramelessWindowHint | Qt.NoDropShadowWindowHint)
        self.setAttribute(Qt.WA_TranslucentBackground)
        
        # ä½¿ç”¨æ ¹å¸ƒå±€æ¥ç®¡ç†è¾¹è·ï¼Œç¡®ä¿å®¹å™¨å±…ä¸­ï¼Œé˜´å½±ä¸è¢«åˆ‡
        self.root_layout = QVBoxLayout(self)
        self.root_layout.setContentsMargins(self.shadow_margin, self.shadow_margin, self.shadow_margin, self.shadow_margin)
        
        # ä¸»å®¹å™¨
        self.container = QWidget()
        self.container.setObjectName("PopupContainer")
        self.container.setStyleSheet("""
            #PopupContainer {
                background-color: #252526;
                border: 1px solid #444;
                border-radius: 10px;
            }
        """)
        self.root_layout.addWidget(self.container)
        
        # é˜´å½±
        shadow = QGraphicsDropShadowEffect(self.container)
        shadow.setBlurRadius(20)
        shadow.setXOffset(0)
        shadow.setYOffset(5)
        shadow.setColor(QColor(0, 0, 0, 120))
        self.container.setGraphicsEffect(shadow)
        
        # å†…å®¹å¸ƒå±€
        layout = QVBoxLayout(self.container)
        layout.setContentsMargins(12, 12, 12, 12)
        layout.setSpacing(10)
        
        # é¡¶éƒ¨æ 
        top_layout = QHBoxLayout()
        lbl_title = QLabel("ğŸ•’ æœç´¢å†å²")
        lbl_title.setStyleSheet("color: #888; font-weight: bold; font-size: 11px; background: transparent; border: none;")
        top_layout.addWidget(lbl_title)
        
        top_layout.addStretch()
        
        btn_clear = QPushButton("æ¸…ç©º")
        btn_clear.setCursor(Qt.PointingHandCursor)
        btn_clear.setStyleSheet("""
            QPushButton { background: transparent; color: #666; border: none; font-size: 11px; }
            QPushButton:hover { color: #E74C3C; }
        """)
        btn_clear.clicked.connect(self._clear_all)
        top_layout.addWidget(btn_clear)
        
        layout.addLayout(top_layout)
        
        # æ»šåŠ¨åŒºåŸŸ
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        # å¼ºåˆ¶å…¨é€æ˜èƒŒæ™¯
        scroll.setStyleSheet("""
            QScrollArea { background-color: transparent; border: none; }
            QScrollArea > QWidget > QWidget { background-color: transparent; }
            QScrollBar:vertical { background: #252526; width: 6px; margin: 0; }
            QScrollBar::handle:vertical { background: #444; border-radius: 3px; min-height: 20px; }
            QScrollBar::handle:vertical:hover { background: #555; }
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical { height: 0; }
        """)
        scroll.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        scroll.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        
        self.chips_widget = QWidget()
        self.chips_widget.setStyleSheet("background-color: transparent;")
        self.flow_layout = FlowLayout(self.chips_widget, margin=0, spacing=8)
        scroll.setWidget(self.chips_widget)
        
        layout.addWidget(scroll)
        
        self.opacity_anim = QPropertyAnimation(self, b"windowOpacity")
        
        self.refresh_ui()

    def refresh_ui(self):
        while self.flow_layout.count():
            item = self.flow_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
                
        history = self.search_edit.get_history()
        
        # ã€æ ¸å¿ƒä¿®æ­£ã€‘å¼ºåˆ¶å®½åº¦ä¸è¾“å…¥æ¡†ä¸€è‡´
        target_content_width = self.search_edit.width()
        
        if not history:
            lbl_empty = QLabel("æš‚æ— å†å²è®°å½•")
            lbl_empty.setAlignment(Qt.AlignCenter)
            lbl_empty.setStyleSheet("color: #555; font-style: italic; margin: 20px; background: transparent; border: none;")
            self.flow_layout.addWidget(lbl_empty)
            content_height = 100
        else:
            for text in history:
                chip = HistoryChip(text)
                chip.clicked.connect(self._on_chip_clicked)
                chip.deleted.connect(self._on_chip_deleted)
                self.flow_layout.addWidget(chip)
            
            # è®¡ç®—é«˜åº¦ï¼šå†…å®¹å®½åº¦ = å®¹å™¨å®½åº¦ - å†…éƒ¨è¾¹è·(24) - æ»šåŠ¨æ¡é¢„ç•™(6)
            effective_width = target_content_width - 30
            flow_height = self.flow_layout.heightForWidth(effective_width)
            content_height = min(400, max(120, flow_height + 50)) # åŠ ä¸Šé¡¶éƒ¨æ é«˜åº¦

        # è®¡ç®—çª—å£æ€»å°ºå¯¸ï¼šå†…å®¹å°ºå¯¸ + é˜´å½±è¾¹è·
        total_width = target_content_width + (self.shadow_margin * 2)
        total_height = content_height + (self.shadow_margin * 2)
        
        self.resize(total_width, total_height)

    def _on_chip_clicked(self, text):
        self.item_selected.emit(text)
        self.close()

    def _on_chip_deleted(self, text):
        self.search_edit.remove_history_entry(text)
        self.refresh_ui()

    def _clear_all(self):
        self.search_edit.clear_history()
        self.refresh_ui()

    def show_animated(self):
        self.refresh_ui()
        
        # ã€æ ¸å¿ƒä¿®æ­£ã€‘åæ ‡å¯¹é½é€»è¾‘
        # 1. è·å–è¾“å…¥æ¡†å·¦ä¸‹è§’åæ ‡
        pos = self.search_edit.mapToGlobal(QPoint(0, self.search_edit.height()))
        
        # 2. åç§»åæ ‡ï¼šXè½´å‡å»é˜´å½±è¾¹è·ï¼ŒYè½´åŠ ä¸Šé—´è·å¹¶å‡å»é˜´å½±è¾¹è·
        # è¿™æ · Container çš„å·¦è¾¹æ¡†å°±ä¼šå’Œ Input çš„å·¦è¾¹æ¡†å®Œå…¨å¯¹é½
        x_pos = pos.x() - self.shadow_margin
        y_pos = pos.y() + 5 - self.shadow_margin # 5px å‚ç›´é—´è·
        
        self.move(x_pos, y_pos)
        
        self.setWindowOpacity(0)
        self.show()
        
        self.opacity_anim.setDuration(200)
        self.opacity_anim.setStartValue(0)
        self.opacity_anim.setEndValue(1)
        self.opacity_anim.setEasingCurve(QEasingCurve.OutCubic)
        self.opacity_anim.start()

# --- 4. æœç´¢æ¡†æœ¬ä½“ ---
class SearchLineEdit(QLineEdit):
    SETTINGS_KEY = "SearchHistoryList"
    MAX_HISTORY = 30

    def __init__(self, parent=None):
        super().__init__(parent)
        self.settings = QSettings("KMain_V3", "KMain_V3")
        self.popup = None

    def mouseDoubleClickEvent(self, event):
        if event.button() == Qt.LeftButton:
            self._show_popup()
        super().mouseDoubleClickEvent(event)

    def _show_popup(self):
        if self.popup and self.popup.isVisible():
            self.popup.close()
            return
            
        self.popup = SearchHistoryPopup(self)
        self.popup.item_selected.connect(self._on_history_selected)
        self.popup.show_animated()

    def _on_history_selected(self, text):
        self.setText(text)
        self.returnPressed.emit()

    def add_history_entry(self, text):
        if not text or not text.strip(): return
        text = text.strip()
        history = self.get_history()
        
        if text in history:
            history.remove(text)
        history.insert(0, text)
        
        if len(history) > self.MAX_HISTORY:
            history = history[:self.MAX_HISTORY]
            
        self.settings.setValue(self.SETTINGS_KEY, history)

    def remove_history_entry(self, text):
        history = self.get_history()
        if text in history:
            history.remove(text)
            self.settings.setValue(self.SETTINGS_KEY, history)

    def clear_history(self):
        self.settings.setValue(self.SETTINGS_KEY, [])

    def get_history(self):
        val = self.settings.value(self.SETTINGS_KEY, [])
        if not isinstance(val, list): return []
        return [str(v) for v in val]
```

## æ–‡ä»¶: selection_service.py

```python
ï»¿# services/selection_service.py
from PyQt5.QtCore import QObject, pyqtSignal, QPoint
from pynput import mouse
import threading

class SelectionMonitor(QObject):
    # å®šä¹‰ä¿¡å·ï¼šå½“æ£€æµ‹åˆ°å¯èƒ½çš„åˆ’é€‰åŠ¨ä½œæ—¶ï¼Œå‘é€é¼ æ ‡å½“å‰çš„åæ ‡
    text_selected = pyqtSignal(QPoint)

    def __init__(self):
        super().__init__()
        self.press_pos = None
        self._is_running = True

    def start(self):
        # åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­å¯åŠ¨ç›‘å¬ï¼Œé¿å…é˜»å¡ä¸»ç•Œé¢
        self.thread = threading.Thread(target=self._run_listener, daemon=True)
        self.thread.start()

    def _run_listener(self):
        with mouse.Listener(on_click=self._on_click) as listener:
            listener.join()

    def _on_click(self, x, y, button, pressed):
        if button == mouse.Button.left:
            if pressed:
                # è®°å½•æŒ‰ä¸‹æ—¶çš„ä½ç½®
                self.press_pos = (x, y)
            else:
                # é¼ æ ‡æ¾å¼€æ—¶ï¼Œè®¡ç®—ç§»åŠ¨è·ç¦»
                if self.press_pos:
                    dx = abs(x - self.press_pos[0])
                    dy = abs(y - self.press_pos[1])
                    # å¦‚æœç§»åŠ¨è·ç¦»è¶…è¿‡ 15 åƒç´ ï¼Œåˆ¤å®šä¸ºåˆ’é€‰åŠ¨ä½œ
                    if dx > 15 or dy > 15:
                        self.text_selected.emit(QPoint(int(x), int(y)))
                self.press_pos = None
```

## æ–‡ä»¶: settings.py

```python
# core/settings.py
import json
import os

SETTINGS_FILE = 'settings.json'

def save_setting(key, value):
    """ä¿å­˜å•ä¸ªè®¾ç½®é¡¹åˆ° JSON æ–‡ä»¶"""
    settings = {}
    if os.path.exists(SETTINGS_FILE):
        try:
            with open(SETTINGS_FILE, 'r', encoding='utf-8') as f:
                settings = json.load(f)
        except (json.JSONDecodeError, IOError):
            # å¦‚æœæ–‡ä»¶å­˜åœ¨ä½†ä¸ºç©ºæˆ–æŸåï¼Œåˆ™å¿½ç•¥
            pass
    
    settings[key] = value
    
    try:
        with open(SETTINGS_FILE, 'w', encoding='utf-8') as f:
            json.dump(settings, f, indent=4)
        # print(f"[Settings] å·²ä¿å­˜ '{key}': {value}")
        pass
    except IOError as e:
        # print(f"[Settings] é”™è¯¯ï¼šæ— æ³•å†™å…¥è®¾ç½®æ–‡ä»¶ {SETTINGS_FILE}: {e}")
        pass

def load_setting(key, default=None):
    """ä» JSON æ–‡ä»¶åŠ è½½å•ä¸ªè®¾ç½®é¡¹"""
    if not os.path.exists(SETTINGS_FILE):
        return default
        
    try:
        with open(SETTINGS_FILE, 'r', encoding='utf-8') as f:
            settings = json.load(f)
            value = settings.get(key, default)
            # print(f"[Settings] å·²åŠ è½½ '{key}': {value}")
            pass
            return value
    except (json.JSONDecodeError, IOError) as e:
        # print(f"[Settings] é”™è¯¯ï¼šæ— æ³•è¯»å–è®¾ç½®æ–‡ä»¶ {SETTINGS_FILE}: {e}")
        pass
        return default
```

## æ–‡ä»¶: sidebar.py

```python
# -*- coding: utf-8 -*-
# ui/sidebar.py
from PyQt5.QtWidgets import (QTreeWidget, QTreeWidgetItem, QMenu, QMessageBox, QInputDialog, 
                             QFrame, QColorDialog, QDialog, QVBoxLayout, QLabel, QLineEdit, 
                             QPushButton, QHBoxLayout, QApplication, QWidget)
from PyQt5.QtCore import Qt, pyqtSignal, QSize, QEvent
from PyQt5.QtGui import QFont, QColor, QPixmap, QPainter, QIcon, QCursor
from core.config import COLORS
from ui.advanced_tag_selector import AdvancedTagSelector

class ClickableLineEdit(QLineEdit):
    doubleClicked = pyqtSignal()
    def mouseDoubleClickEvent(self, event):
        self.doubleClicked.emit()
        super().mouseDoubleClickEvent(event)

class Sidebar(QTreeWidget):
    filter_changed = pyqtSignal(str, object)
    data_changed = pyqtSignal()
    new_data_requested = pyqtSignal(int)

    def __init__(self, db, parent=None):
        super().__init__(parent)
        self.db = db
        self.setHeaderHidden(True)
        self.setIndentation(15)
        
        self.setCursor(Qt.ArrowCursor)
        
        self.setDragEnabled(True)
        self.setAcceptDrops(True)
        self.setDropIndicatorShown(True)
        self.setDragDropMode(self.InternalMove)

        # ã€å…³é”®ä¿®å¤ã€‘åœ¨æ­¤å¤„æ·»åŠ  ScrollBar æ ·å¼ï¼Œé˜²æ­¢ä¾§è¾¹æ å†…å®¹è¿‡å¤šæ—¶å‡ºç°ä¼ ç»Ÿæ»šåŠ¨æ¡
        self.setStyleSheet(f"""
            QTreeWidget {{
                background-color: {COLORS['bg_mid']};
                color: #ddd;
                border: none;
                font-size: 13px;
                padding: 2px;
                outline: none;
            }}
            QTreeWidget::item {{
                height: 24px;
                padding: 1px 4px;
                border-radius: 4px;
                margin-bottom: 0px;
            }}
            QTreeWidget::item:hover {{
                background-color: #2a2d2e;
            }}
            QTreeWidget::item:selected {{
                background-color: #37373d;
                color: white;
            }}
            
            /* ç°ä»£æ»šåŠ¨æ¡æ ·å¼ */
            QScrollBar:vertical {{
                border: none;
                background: transparent;
                width: 6px;
                margin: 0px;
            }}
            QScrollBar::handle:vertical {{
                background: #444;
                border-radius: 3px;
                min-height: 20px;
            }}
            QScrollBar::handle:vertical:hover {{
                background: #555;
            }}
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {{
                height: 0px;
            }}
            QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {{
                background: none;
            }}
        """)

        self.itemClicked.connect(self._on_click)
        self.setContextMenuPolicy(Qt.CustomContextMenu)
        self.customContextMenuRequested.connect(self._show_menu)
        self.refresh()

    def enterEvent(self, event):
        self.setCursor(Qt.ArrowCursor)
        super().enterEvent(event)

    def refresh(self):
        self.clear()
        self.setColumnCount(1)
        counts = self.db.get_counts()

        system_menu_items = [
            ("å…¨éƒ¨æ•°æ®", 'all', 'ğŸ—‚ï¸'), ("ä»Šæ—¥æ•°æ®", 'today', 'ğŸ“…'),
            ("å‰ªè´´æ¿æ•°æ®", 'clipboard', 'ğŸ“‹'),
            ("æœªåˆ†ç±»", 'uncategorized', 'âš ï¸'), ("æœªæ ‡ç­¾", 'untagged', 'ğŸ·ï¸'),
            ("æ”¶è—", 'favorite', 'â­'), ("å›æ”¶ç«™", 'trash', 'ğŸ—‘ï¸')
        ]

        for name, key, icon in system_menu_items:
            item = QTreeWidgetItem(self, [f"{icon}  {name} ({counts.get(key, 0)})"])
            item.setData(0, Qt.UserRole, (key, None))
            item.setFlags(item.flags() & ~Qt.ItemIsDragEnabled)
            item.setExpanded(False)

        sep_item = QTreeWidgetItem(self)
        sep_item.setFlags(Qt.NoItemFlags)
        sep_item.setSizeHint(0, QSize(0, 16)) 
        
        container = QWidget()
        container.setStyleSheet("background: transparent;")
        
        layout = QVBoxLayout(container)
        layout.setContentsMargins(10, 0, 10, 0)
        layout.setAlignment(Qt.AlignCenter)
        
        line = QFrame()
        line.setFixedHeight(1) 
        line.setStyleSheet("background-color: #505050; border: none;") 
        
        layout.addWidget(line)
        self.setItemWidget(sep_item, 0, container)

        user_partitions_root = QTreeWidgetItem(self, ["ğŸ—ƒï¸ æˆ‘çš„åˆ†åŒº"])
        user_partitions_root.setFlags(user_partitions_root.flags() & ~Qt.ItemIsSelectable & ~Qt.ItemIsDragEnabled)
        font = user_partitions_root.font(0)
        font.setBold(True)
        user_partitions_root.setFont(0, font)
        user_partitions_root.setForeground(0, QColor("#FFFFFF"))
        
        partitions_tree = self.db.get_partitions_tree()
        self._add_partition_recursive(partitions_tree, user_partitions_root, counts.get('categories', {}))
        
        self.expandAll()

    def _create_color_icon(self, color_str):
        pixmap = QPixmap(14, 14)
        pixmap.fill(Qt.transparent)
        painter = QPainter(pixmap)
        painter.setRenderHint(QPainter.Antialiasing)
        
        c = QColor(color_str if color_str else "#808080")
        painter.setBrush(c)
        painter.setPen(Qt.NoPen)
        painter.drawEllipse(1, 1, 12, 12)
        painter.end()
        return QIcon(pixmap)

    def _add_partition_recursive(self, partitions, parent_item, counts):
        for p in partitions:
            count = counts.get(p.id, 0)
            child_counts = sum(counts.get(child.id, 0) for child in p.children)
            total_count = count + child_counts

            item = QTreeWidgetItem(parent_item, [f"{p.name} ({total_count})"])
            item.setIcon(0, self._create_color_icon(p.color))
            item.setData(0, Qt.UserRole, ('category', p.id))
            
            if p.children:
                self._add_partition_recursive(p.children, item, counts)

    def dragEnterEvent(self, e):
        if e.mimeData().hasFormat('application/x-tree-widget-internal-move') or \
           e.mimeData().hasFormat('application/x-idea-id') or \
           e.mimeData().hasFormat('application/x-idea-ids'):
            e.accept()
        else:
            e.ignore()

    def dragMoveEvent(self, e):
        item = self.itemAt(e.pos())
        if item:
            d = item.data(0, Qt.UserRole)
            if d and d[0] in ['category', 'trash', 'favorite', 'uncategorized']:
                self.setCurrentItem(item)
                e.accept()
                return
            if e.mimeData().hasFormat('application/x-tree-widget-internal-move'):
                e.accept()
                return
        e.ignore()

    def dropEvent(self, e):
        ids_to_process = []
        if e.mimeData().hasFormat('application/x-idea-ids'):
            try:
                data = e.mimeData().data('application/x-idea-ids').data().decode('utf-8')
                ids_to_process = [int(x) for x in data.split(',') if x]
            except Exception: pass
        elif e.mimeData().hasFormat('application/x-idea-id'):
            try: 
                ids_to_process = [int(e.mimeData().data('application/x-idea-id'))]
            except Exception: pass
        
        if ids_to_process:
            try:
                item = self.itemAt(e.pos())
                if not item: return
                d = item.data(0, Qt.UserRole)
                if not d: return
                key, val = d
                
                for iid in ids_to_process:
                    if key == 'category': self.db.move_category(iid, val)
                    elif key == 'uncategorized': self.db.move_category(iid, None)
                    elif key == 'trash': self.db.set_deleted(iid, True)
                    elif key == 'favorite': self.db.set_favorite(iid, True)
                
                self.data_changed.emit()
                self.refresh()
                e.acceptProposedAction()
            except Exception as err:
                pass
        else:
            super().dropEvent(e)
            self._save_current_order()

    def _save_current_order(self):
        update_list = []
        def iterate_items(parent_item, parent_id):
            for i in range(parent_item.childCount()):
                item = parent_item.child(i)
                data = item.data(0, Qt.UserRole)
                if data and data[0] == 'category':
                    cat_id = data[1]
                    update_list.append({'id': cat_id, 'sort_order': i, 'parent_id': parent_id})
                    if item.childCount() > 0:
                        iterate_items(item, cat_id)
        iterate_items(self.invisibleRootItem(), None)
        if update_list:
            self.db.save_category_order(update_list)

    def _on_click(self, item):
        data = item.data(0, Qt.UserRole)
        if data: self.filter_changed.emit(*data)

    def _show_menu(self, pos):
        item = self.itemAt(pos)
        menu = QMenu(self)
        menu.setStyleSheet("background:#2d2d2d;color:white")

        if not item or item.text(0) == "ğŸ—ƒï¸ æˆ‘çš„åˆ†åŒº":
            menu.addAction('â• ç»„', self._new_group)
            menu.exec_(self.mapToGlobal(pos))
            return

        data = item.data(0, Qt.UserRole)
        if data and data[0] == 'category':
            cat_id = data[1]
            raw_text = item.text(0)
            current_name = raw_text.split(' (')[0]

            menu.addAction('â• æ•°æ®', lambda: self._request_new_data(cat_id))
            menu.addSeparator()
            menu.addAction('ğŸ¨ è®¾ç½®é¢œè‰²', lambda: self._change_color(cat_id))
            menu.addAction('ğŸ·ï¸ è®¾ç½®é¢„è®¾æ ‡ç­¾', lambda: self._set_preset_tags(cat_id))
            menu.addSeparator()
            menu.addAction('â• ç»„', self._new_group)
            menu.addAction('â• åŒº', lambda: self._new_zone(cat_id))
            menu.addAction('âœï¸ é‡å‘½å', lambda: self._rename_category(cat_id, current_name))
            menu.addAction('ğŸ—‘ï¸ åˆ é™¤', lambda: self._del_category(cat_id))
            menu.exec_(self.mapToGlobal(pos))

    def _set_preset_tags(self, cat_id):
        current_tags = self.db.get_category_preset_tags(cat_id)
        
        dlg = QDialog(self)
        dlg.setWindowTitle("ğŸ·ï¸ è®¾ç½®é¢„è®¾æ ‡ç­¾")
        dlg.setStyleSheet(f"background-color: {COLORS['bg_dark']}; color: #EEE;")
        dlg.setFixedSize(350, 150)
        
        layout = QVBoxLayout(dlg)
        layout.setContentsMargins(20, 20, 20, 20)
        
        info = QLabel("æ‹–å…¥è¯¥åˆ†ç±»æ—¶è‡ªåŠ¨ç»‘å®šä»¥ä¸‹æ ‡ç­¾ï¼š\n(åŒå‡»è¾“å…¥æ¡†é€‰æ‹©å†å²æ ‡ç­¾)")
        info.setStyleSheet("color: #888; font-size: 12px; margin-bottom: 5px;")
        layout.addWidget(info)
        
        inp = ClickableLineEdit()
        inp.setText(current_tags)
        inp.setPlaceholderText("ä¾‹å¦‚: å·¥ä½œ, é‡è¦ (é€—å·åˆ†éš”)")
        inp.setStyleSheet(f"background-color: {COLORS['bg_mid']}; border: 1px solid #444; padding: 6px; border-radius: 4px; color: white;")
        layout.addWidget(inp)
        
        def open_tag_selector():
            initial_list = [t.strip() for t in inp.text().split(',') if t.strip()]
            selector = AdvancedTagSelector(self.db, idea_id=None, initial_tags=initial_list)
            def on_confirmed(tags):
                inp.setText(', '.join(tags))
            selector.tags_confirmed.connect(on_confirmed)
            selector.show_at_cursor()
            
        inp.doubleClicked.connect(open_tag_selector)
        
        btns = QHBoxLayout()
        btns.addStretch()
        btn_ok = QPushButton("å®Œæˆ")
        btn_ok.setStyleSheet(f"background-color: {COLORS['primary']}; border:none; padding: 5px 15px; border-radius: 4px; font-weight:bold;")
        btn_ok.clicked.connect(dlg.accept)
        btns.addWidget(btn_ok)
        layout.addLayout(btns)
        
        if dlg.exec_() == QDialog.Accepted:
            new_tags = inp.text().strip()
            self.db.set_category_preset_tags(cat_id, new_tags)
            
            tags_list = [t.strip() for t in new_tags.split(',') if t.strip()]
            if tags_list:
                self.db.apply_preset_tags_to_category_items(cat_id, tags_list)
                
            self.data_changed.emit()

    def _change_color(self, cat_id):
        color = QColorDialog.getColor(Qt.gray, self, "é€‰æ‹©åˆ†ç±»é¢œè‰²")
        if color.isValid():
            self.db.set_category_color(cat_id, color.name())
            self.refresh()

    def _request_new_data(self, cat_id):
        self.new_data_requested.emit(cat_id)

    def _new_group(self):
        text, ok = QInputDialog.getText(self, 'æ–°å»ºç»„', 'ç»„åç§°:')
        if ok and text:
            self.db.add_category(text, parent_id=None)
            self.refresh()
            
    def _new_zone(self, parent_id):
        text, ok = QInputDialog.getText(self, 'æ–°å»ºåŒº', 'åŒºåç§°:')
        if ok and text:
            self.db.add_category(text, parent_id=parent_id)
            self.refresh()

    def _rename_category(self, cat_id, old_name):
        text, ok = QInputDialog.getText(self, 'é‡å‘½å', 'æ–°åç§°:', text=old_name)
        if ok and text and text.strip():
            self.db.rename_category(cat_id, text.strip())
            self.refresh()

    def _del_category(self, cid):
        c = self.db.conn.cursor()
        c.execute("SELECT COUNT(*) FROM categories WHERE parent_id = ?", (cid,))
        child_count = c.fetchone()[0]

        msg = 'ç¡®è®¤åˆ é™¤æ­¤åˆ†ç±»? (å…¶ä¸­çš„å†…å®¹å°†ç§»è‡³æœªåˆ†ç±»)'
        if child_count > 0:
            msg = f'æ­¤ç»„åŒ…å« {child_count} ä¸ªåŒºï¼Œç¡®è®¤ä¸€å¹¶åˆ é™¤?\n(æ‰€æœ‰å†…å®¹éƒ½å°†ç§»è‡³æœªåˆ†ç±»)'

        if QMessageBox.Yes == QMessageBox.question(self, 'ç¡®è®¤åˆ é™¤', msg):
            c.execute("SELECT id FROM categories WHERE parent_id = ?", (cid,))
            child_ids = [row[0] for row in c.fetchall()]
            for child_id in child_ids:
                self.db.delete_category(child_id)
            self.db.delete_category(cid)
            self.refresh()
```

## æ–‡ä»¶: tag_repository.py

```python
# data/repositories/tag_repository.py

class TagRepository:
    def __init__(self, conn):
        self.conn = conn

    def update_tags_for_idea(self, iid, tags):
        c = self.conn.cursor()
        c.execute('DELETE FROM idea_tags WHERE idea_id=?', (iid,))
        if not tags:
            self.conn.commit()
            return
            
        for t in tags:
            t = t.strip()
            if t:
                c.execute('INSERT OR IGNORE INTO tags (name) VALUES (?)', (t,))
                c.execute('SELECT id FROM tags WHERE name=?', (t,))
                tid = c.fetchone()[0]
                c.execute('INSERT INTO idea_tags VALUES (?,?)', (iid, tid))
        self.conn.commit()

    def get_tags_for_idea(self, iid):
        c = self.conn.cursor()
        c.execute('SELECT t.name FROM tags t JOIN idea_tags it ON t.id=it.tag_id WHERE it.idea_id=?', (iid,))
        return [r[0] for r in c.fetchall()]

    def get_all_tags_with_counts(self):
        c = self.conn.cursor()
        c.execute('''
            SELECT t.name, COUNT(it.idea_id) as cnt 
            FROM tags t 
            JOIN idea_tags it ON t.id = it.tag_id 
            JOIN ideas i ON it.idea_id = i.id 
            WHERE i.is_deleted = 0 
            GROUP BY t.id 
            ORDER BY cnt DESC, t.name ASC
        ''')
        return c.fetchall()
```

## æ–‡ä»¶: tag_selector.py

```python
ï»¿# -*- coding: utf-8 -*-
# ui/tag_selector.py

from PyQt5.QtWidgets import QWidget, QVBoxLayout, QHBoxLayout, QCheckBox, QPushButton, QLineEdit, QScrollArea, QLabel
from PyQt5.QtCore import Qt, pyqtSignal, QPoint
from PyQt5.QtGui import QCursor
from core.config import COLORS

class TagSelectorFloat(QWidget):
    """æ ‡ç­¾é€‰æ‹©æ‚¬æµ®é¢æ¿"""
    tags_confirmed = pyqtSignal(list)
    
    def __init__(self, db, idea_id, parent=None):
        super().__init__(parent)
        self.db = db
        self.idea_id = idea_id
        self.selected_tags = set()
        
        self.setWindowFlags(
            Qt.FramelessWindowHint | 
            Qt.WindowStaysOnTopHint | 
            Qt.Tool
        )
        self.setAttribute(Qt.WA_TranslucentBackground)
        self.setAttribute(Qt.WA_ShowWithoutActivating, False)
        
        self._init_ui()
        self._load_tags()
        
    def _init_ui(self):
        # ä¸»å®¹å™¨
        container = QWidget()
        container.setStyleSheet(f"""
            QWidget {{
                background-color: {COLORS['bg_dark']};
                border: 2px solid {COLORS['primary']};
                border-radius: 12px;
            }}
        """)
        
        main_layout = QVBoxLayout(self)
        main_layout.setContentsMargins(0, 0, 0, 0)
        main_layout.addWidget(container)
        
        layout = QVBoxLayout(container)
        layout.setContentsMargins(15, 15, 15, 15)
        layout.setSpacing(10)
        
        # æ ‡é¢˜æ 
        header = QHBoxLayout()
        title = QLabel('ğŸ·ï¸ å¿«é€Ÿé€‰æ‹©æ ‡ç­¾')
        title.setStyleSheet(f"""
            font-size: 14px; 
            font-weight: bold; 
            color: {COLORS['primary']};
            background: transparent;
            border: none;
        """)
        header.addWidget(title)
        
        close_btn = QPushButton('âœ•')
        close_btn.setFixedSize(20, 20)
        close_btn.setStyleSheet(f"""
            QPushButton {{
                background: transparent;
                border: 1px solid #666;
                border-radius: 10px;
                color: #999;
                font-size: 12px;
                padding: 0px;
            }}
            QPushButton:hover {{
                background-color: {COLORS['danger']};
                border-color: {COLORS['danger']};
                color: white;
            }}
        """)
        close_btn.clicked.connect(self._on_close)
        header.addWidget(close_btn)
        
        layout.addLayout(header)
        
        hint = QLabel('ğŸ’¡ ç‚¹å‡»é€‰æ‹©æ ‡ç­¾ï¼Œå¤±å»ç„¦ç‚¹åè‡ªåŠ¨ä¿å­˜')
        hint.setStyleSheet("""
            color: #888; 
            font-size: 11px; 
            background: transparent;
            border: none;
        """)
        layout.addWidget(hint)
        
        input_layout = QHBoxLayout()
        self.new_tag_input = QLineEdit()
        self.new_tag_input.setPlaceholderText('è¾“å…¥æ–°æ ‡ç­¾...')
        self.new_tag_input.setStyleSheet(f"""
            QLineEdit {{
                background-color: {COLORS['bg_mid']};
                border: 1px solid {COLORS['bg_light']};
                border-radius: 8px;
                padding: 6px 10px;
                color: #eee;
                font-size: 12px;
            }}
            QLineEdit:focus {{
                border: 1px solid {COLORS['primary']};
            }}
        """)
        self.new_tag_input.returnPressed.connect(self._add_new_tag)
        input_layout.addWidget(self.new_tag_input)
        
        add_btn = QPushButton('â•')
        add_btn.setFixedSize(28, 28)
        add_btn.setStyleSheet(f"""
            QPushButton {{
                background-color: {COLORS['primary']};
                border: none;
                border-radius: 6px;
                color: white;
                font-size: 14px;
            }}
            QPushButton:hover {{
                background-color: #357abd;
            }}
        """)
        add_btn.clicked.connect(self._add_new_tag)
        input_layout.addWidget(add_btn)
        
        layout.addLayout(input_layout)
        
        scroll = QScrollArea()
        scroll.setWidgetResizable(True)
        scroll.setFixedHeight(200)
        # ã€å…³é”®ä¿®å¤ã€‘åœ¨æ­¤å¤„æ³¨å…¥ QScrollBar æ ·å¼
        scroll.setStyleSheet("""
            QScrollArea {
                border: none;
                background: transparent;
            }
            QScrollBar:vertical {
                border: none;
                background: transparent;
                width: 6px;
                margin: 0px;
            }
            QScrollBar::handle:vertical {
                background: #444;
                border-radius: 3px;
                min-height: 20px;
            }
            QScrollBar::handle:vertical:hover {
                background: #555;
            }
            QScrollBar::add-line:vertical, QScrollBar::sub-line:vertical {
                height: 0px;
            }
            QScrollBar::add-page:vertical, QScrollBar::sub-page:vertical {
                background: none;
            }
        """)
        
        self.tag_list_widget = QWidget()
        self.tag_list_layout = QVBoxLayout(self.tag_list_widget)
        self.tag_list_layout.setAlignment(Qt.AlignTop)
        self.tag_list_layout.setSpacing(6)
        self.tag_list_layout.setContentsMargins(0, 0, 0, 0)
        
        scroll.setWidget(self.tag_list_widget)
        layout.addWidget(scroll)
        
        self.count_label = QLabel('å·²é€‰æ‹© 0 ä¸ªæ ‡ç­¾')
        self.count_label.setStyleSheet(f"""
            color: {COLORS['primary']}; 
            font-size: 11px; 
            font-weight: bold;
            background: transparent;
            border: none;
        """)
        layout.addWidget(self.count_label)
        
        self.setFixedWidth(300)
        
    def _load_tags(self):
        while self.tag_list_layout.count():
            item = self.tag_list_layout.takeAt(0)
            if item.widget():
                item.widget().deleteLater()
        
        c = self.db.conn.cursor()
        c.execute('''
            SELECT DISTINCT t.name, COUNT(it.idea_id) as cnt 
            FROM tags t
            LEFT JOIN idea_tags it ON t.id = it.tag_id
            LEFT JOIN ideas i ON it.idea_id = i.id AND i.is_deleted = 0
            GROUP BY t.id
            ORDER BY cnt DESC, t.name ASC
        ''')
        all_tags = c.fetchall()
        
        current_tags = set(self.db.get_tags(self.idea_id))
        self.selected_tags = current_tags.copy()
        
        if not all_tags:
            empty = QLabel('æš‚æ— æ ‡ç­¾ï¼Œè¯·åˆ›å»ºæ–°æ ‡ç­¾')
            empty.setStyleSheet("color: #666; font-style: italic; font-size: 11px;")
            empty.setAlignment(Qt.AlignCenter)
            self.tag_list_layout.addWidget(empty)
        else:
            for tag_name, count in all_tags:
                checkbox = QCheckBox(f'{tag_name} ({count})')
                checkbox.setChecked(tag_name in current_tags)
                checkbox.setStyleSheet(f"""
                    QCheckBox {{
                        color: #ddd;
                        font-size: 12px;
                        spacing: 8px;
                        background: transparent;
                        border: none;
                    }}
                    QCheckBox::indicator {{
                        width: 16px;
                        height: 16px;
                        border: 2px solid #666;
                        border-radius: 4px;
                        background-color: {COLORS['bg_mid']};
                    }}
                    QCheckBox::indicator:checked {{
                        background-color: {COLORS['primary']};
                        border-color: {COLORS['primary']};
                        image: url(none);
                    }}
                    QCheckBox::indicator:hover {{
                        border-color: {COLORS['primary']};
                    }}
                    QCheckBox:hover {{
                        color: white;
                    }}
                """)
                checkbox.stateChanged.connect(lambda state, name=tag_name: self._on_tag_changed(name, state))
                self.tag_list_layout.addWidget(checkbox)
                
        self._update_count()
        
    def _on_tag_changed(self, tag_name, state):
        if state == Qt.Checked:
            self.selected_tags.add(tag_name)
        else:
            self.selected_tags.discard(tag_name)
        self._update_count()
        
    def _add_new_tag(self):
        tag_name = self.new_tag_input.text().strip()
        if not tag_name:
            return
            
        c = self.db.conn.cursor()
        c.execute('SELECT id FROM tags WHERE name = ?', (tag_name,))
        if c.fetchone():
            self.selected_tags.add(tag_name)
            self._load_tags()
            self.new_tag_input.clear()
            return
            
        c.execute('INSERT INTO tags (name) VALUES (?)', (tag_name,))
        self.db.conn.commit()
        
        self.selected_tags.add(tag_name)
        
        self._load_tags()
        self.new_tag_input.clear()
        
    def _update_count(self):
        count = len(self.selected_tags)
        self.count_label.setText(f'å·²é€‰æ‹© {count} ä¸ªæ ‡ç­¾')
        
    def _save_tags(self):
        c = self.db.conn.cursor()
        c.execute('DELETE FROM idea_tags WHERE idea_id = ?', (self.idea_id,))
        
        for tag_name in self.selected_tags:
            c.execute('SELECT id FROM tags WHERE name = ?', (tag_name,))
            result = c.fetchone()
            if result:
                tag_id = result[0]
                c.execute('INSERT INTO idea_tags (idea_id, tag_id) VALUES (?, ?)', 
                          (self.idea_id, tag_id))
                self.db.conn.commit()
        
    def _on_close(self):
        self._save_tags()
        self.tags_confirmed.emit(list(self.selected_tags))
        self.close()
        
    def focusOutEvent(self, event):
        self._save_tags()
        self.tags_confirmed.emit(list(self.selected_tags))
        self.close()
        super().focusOutEvent(event)
        
    def show_at_cursor(self):
        cursor_pos = QCursor.pos()
        screen_geo = self.screen().geometry()
        
        x = cursor_pos.x() + 10
        y = cursor_pos.y() + 10
        
        if x + self.width() > screen_geo.right():
            x = cursor_pos.x() - self.width() - 10
            
        if y + self.height() > screen_geo.bottom():
            y = screen_geo.bottom() - self.height() - 10
            
        self.move(x, y)
        self.show()
        self.raise_()
        self.activateWindow()
        self.setFocus()
```

